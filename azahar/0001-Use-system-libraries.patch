From 017d1e3940bdc6b44219ddb1986b392d2df94f5e Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Thu, 19 Oct 2023 20:05:46 -0300
Subject: [PATCH] Use system libraries

---
 CMakeLists.txt            |  3 +-
 externals/CMakeLists.txt  | 60 +++++++++++++++++++++++++++++++++------
 src/common/CMakeLists.txt | 10 +++++--
 3 files changed, 60 insertions(+), 13 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 9c5e5c1..c19e870 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -15,7 +15,6 @@ set(CMAKE_POLICY_DEFAULT_CMP0063 NEW)
 
 list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/CMakeModules")
 list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/externals/cmake-modules")
-include(DownloadExternals)
 include(CMakeDependentOption)
 include(FindPkgConfig)
 
@@ -230,7 +229,7 @@ function(check_submodules_present)
 endfunction()
 if (EXISTS "${PROJECT_SOURCE_DIR}/.git/objects")
     # only check submodules when source is obtained via Git
-    check_submodules_present()
+    #check_submodules_present()
 endif()
 
 configure_file(${PROJECT_SOURCE_DIR}/dist/compatibility_list/compatibility_list.qrc
diff --git a/externals/CMakeLists.txt b/externals/CMakeLists.txt
index 01e76a0..08a03b8 100644
--- a/externals/CMakeLists.txt
+++ b/externals/CMakeLists.txt
@@ -16,7 +16,6 @@ function(target_disable_warnings target)
 endfunction()
 
 set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${PROJECT_SOURCE_DIR}/CMakeModules)
-include(DownloadExternals)
 include(ExternalProject)
 
 # Boost
@@ -50,6 +49,7 @@ else()
 endif()
 
 # Catch2
+if (ENABLE_TESTS)
 add_library(catch2 INTERFACE)
 if(USE_SYSTEM_CATCH2)
     find_package(Catch2 3.0.0 REQUIRED)
@@ -59,6 +59,7 @@ else()
     add_subdirectory(catch2)
 endif()
 target_link_libraries(catch2 INTERFACE Catch2::Catch2WithMain)
+endif()
 
 # Crypto++
 if(USE_SYSTEM_CRYPTOPP)
@@ -216,12 +217,29 @@ endif()
 
 # Zstandard
 if(USE_SYSTEM_ZSTD)
-    find_package(zstd REQUIRED)
+    find_package(zstd)
+    if(NOT zstd_FOUND)
+      pkg_check_modules(libzstd_shared IMPORTED_TARGET libzstd)
+    endif()
     add_library(zstd INTERFACE)
-    if(TARGET zstd::libzstd_shared)
+    if(TARGET zstd::libzstd_shared OR TARGET PkgConfig::libzstd_shared)
         message(STATUS "Found system Zstandard")
     endif()
-    target_link_libraries(zstd INTERFACE zstd::libzstd_shared)
+    add_library(zstd_seekable STATIC
+        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/zstd/contrib/seekable_format/zstdseek_compress.c>
+        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/zstd/contrib/seekable_format/zstdseek_decompress.c>
+        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/zstd/lib/common/xxhash.c>
+    )
+    target_include_directories(zstd_seekable PUBLIC
+        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/zstd/contrib/seekable_format>
+        $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/zstd/lib/common>
+    )
+    target_compile_definitions(zstd_seekable PUBLIC XXH_NAMESPACE=ZSTD_)
+    if(TARGET zstd::libzstd_shared)
+    target_link_libraries(zstd INTERFACE zstd::libzstd_shared zstd_seekable)
+    else()
+      target_link_libraries(zstd INTERFACE PkgConfig::libzstd_shared zstd_seekable)
+    endif()
 else()
     set(ZSTD_LEGACY_SUPPORT OFF)
     set(ZSTD_BUILD_PROGRAMS OFF)
@@ -356,7 +374,13 @@ target_compile_options(httplib INTERFACE -DCPPHTTPLIB_OPENSSL_SUPPORT)
 target_link_libraries(httplib INTERFACE ${OPENSSL_LIBRARIES})
 
 if (UNIX AND NOT APPLE)
+    pkg_check_modules(gamemode IMPORTED_TARGET gamemode)
+    if(gamemode_FOUND)
+       add_library(gamemode INTERFACE)
+       target_link_libraries(gamemode INTERFACE PkgConfig::gamemode)
+    else()
     add_subdirectory(gamemode)
+    endif()
 endif()
 
 # cpp-jwt
@@ -431,16 +455,15 @@ if (ENABLE_VULKAN)
 
     # spirv-tools
     # TODO: Implement USE_SYSTEM_SPIRV_TOOLS -OS
-    set(SPIRV_SKIP_EXECUTABLES ON)
-    add_subdirectory(spirv-tools EXCLUDE_FROM_ALL)
 
     # glslang
     if(USE_SYSTEM_GLSLANG)
         find_package(glslang REQUIRED)
+        find_package(SPIRV-Tools REQUIRED)
         add_library(glslang INTERFACE)
         add_library(SPIRV INTERFACE)
         target_link_libraries(glslang INTERFACE glslang::glslang)
-        target_link_libraries(SPIRV INTERFACE glslang::SPIRV)
+        target_link_libraries(SPIRV INTERFACE glslang::SPIRV SPIRV-Tools-opt SPIRV-Tools-link)
         # System include path is different from submodule include path
         get_target_property(GLSLANG_PREFIX glslang::SPIRV INTERFACE_INCLUDE_DIRECTORIES)
         target_include_directories(SPIRV SYSTEM INTERFACE "${GLSLANG_PREFIX}/glslang")
@@ -451,11 +474,22 @@ if (ENABLE_VULKAN)
         set(ENABLE_CTEST OFF CACHE BOOL "")
         set(ENABLE_HLSL OFF CACHE BOOL "")
         set(BUILD_EXTERNAL OFF CACHE BOOL "")
+        set(SPIRV_SKIP_EXECUTABLES ON)
+        add_subdirectory(spirv-tools EXCLUDE_FROM_ALL)
         add_subdirectory(glslang)
     endif()
 
     # sirit
+    find_package(sirit)
+    if(sirit_FOUND)
+        add_library(sirit INTERFACE)
+        if(TARGET sirit::sirit)
+            message(STATUS "Found sirit")
+            target_link_libraries(sirit INTERFACE sirit::sirit)
+        endif()
+    else()
     add_subdirectory(sirit EXCLUDE_FROM_ALL)
+    endif()
 
     # VMA
     if(USE_SYSTEM_VMA)
@@ -474,7 +508,7 @@ if (ENABLE_VULKAN)
     # vulkan-headers
     add_library(vulkan-headers INTERFACE)
     if(USE_SYSTEM_VULKAN_HEADERS)
-        find_package(Vulkan REQUIRED)
+        find_package(VulkanHeaders REQUIRED)
         if(TARGET Vulkan::Headers)
             message(STATUS "Found Vulkan headers")
             target_link_libraries(vulkan-headers INTERFACE Vulkan::Headers)
@@ -490,6 +524,13 @@ if (ENABLE_VULKAN)
     endif()
 endif()
 
+pkg_check_modules(libxxhash IMPORTED_TARGET libxxhash)
+if(libxxhash_FOUND)
+  message(STATUS "Using the system libxxhash")
+  add_library(xxhash INTERFACE)
+  target_link_libraries(xxhash INTERFACE PkgConfig::libxxhash)
+  add_library(xxHash::xxhash ALIAS xxhash)
+else()
 set(XXHASH_BUILD_XXHSUM OFF)
 add_subdirectory(xxHash/cmake_unofficial EXCLUDE_FROM_ALL)
 target_compile_definitions(xxhash PRIVATE XXH_FORCE_MEMORY_ACCESS=2)
@@ -502,4 +543,5 @@ elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "aarch64|ARM64|armv8")
 else()
     target_compile_definitions(xxhash PRIVATE XXH_VECTOR=XXH_SCALAR)
     message(STATUS "Disabling SIMD for xxHash")
-endif()
\ No newline at end of file
+endif()
+endif()
diff --git a/src/common/CMakeLists.txt b/src/common/CMakeLists.txt
index b7062e9..5cf324b 100644
--- a/src/common/CMakeLists.txt
+++ b/src/common/CMakeLists.txt
@@ -151,12 +151,18 @@ add_library(citra_common STATIC
     web_result.h
     x64/cpu_detect.cpp
     x64/cpu_detect.h
-    x64/xbyak_abi.h
-    x64/xbyak_util.h
     zstd_compression.cpp
     zstd_compression.h
 )
 
+if(NOT TARGET xbyak::xbyak)
+target_sources(citra_common
+    PRIVATE
+      x64/xbyak_abi.h
+      x64/xbyak_util.h
+)
+endif()
+
 if (UNIX AND NOT APPLE)
   target_sources(citra_common PRIVATE
     linux/gamemode.cpp
-- 
2.52.0

