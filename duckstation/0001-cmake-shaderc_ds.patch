From c896f792db6a888d0650955352c02f935bdf2885 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Sat, 18 May 2024 18:09:15 -0300
Subject: [PATCH] cmake: shaderc_ds

---
 CMakeModules/DuckStationDependencies.cmake | 4 ++--
 src/util/CMakeLists.txt                    | 2 +-
 src/util/gpu_device.cpp                    | 4 ++--
 3 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/CMakeModules/DuckStationDependencies.cmake b/CMakeModules/DuckStationDependencies.cmake
index fe3df91..8453837 100644
--- a/CMakeModules/DuckStationDependencies.cmake
+++ b/CMakeModules/DuckStationDependencies.cmake
@@ -42,12 +42,12 @@ if(BUILD_QT_FRONTEND)
   find_package(Qt6 6.7.0 COMPONENTS Core Gui Widgets LinguistTools REQUIRED)
 endif()
 
-find_package(Shaderc REQUIRED)
+find_package(Shaderc_ds REQUIRED)
 find_package(spirv_cross_c_shared REQUIRED)
 
 if(LINUX AND NOT (ALLOW_INSTALL AND INSTALL_SELF_CONTAINED))
   # We need to add the rpath for shaderc to the executable.
-  get_target_property(SHADERC_LIBRARY Shaderc::shaderc_shared IMPORTED_LOCATION)
+  get_target_property(SHADERC_LIBRARY Shaderc_ds::shaderc_shared IMPORTED_LOCATION)
   get_filename_component(SHADERC_LIBRARY_DIRECTORY ${SHADERC_LIBRARY} DIRECTORY)
   list(APPEND CMAKE_BUILD_RPATH ${SHADERC_LIBRARY_DIRECTORY})
   get_target_property(SPIRV_CROSS_LIBRARY spirv-cross-c-shared IMPORTED_LOCATION)
diff --git a/src/util/CMakeLists.txt b/src/util/CMakeLists.txt
index 7a74378..e0953b1 100644
--- a/src/util/CMakeLists.txt
+++ b/src/util/CMakeLists.txt
@@ -169,7 +169,7 @@ if(ENABLE_VULKAN)
 endif()
 
 # shaderc/spirv-cross is loaded dynamically to reduce module loads on startup.
-get_target_property(SHADERC_INCLUDE_DIR Shaderc::shaderc_shared INTERFACE_INCLUDE_DIRECTORIES)
+get_target_property(SHADERC_INCLUDE_DIR Shaderc_ds::shaderc_shared INTERFACE_INCLUDE_DIRECTORIES)
 get_target_property(SPIRV_CROSS_INCLUDE_DIR spirv-cross-c-shared INTERFACE_INCLUDE_DIRECTORIES)
 target_include_directories(util PUBLIC ${SHADERC_INCLUDE_DIR} ${SPIRV_CROSS_INCLUDE_DIR})
 
diff --git a/src/util/gpu_device.cpp b/src/util/gpu_device.cpp
index b3b90af..28169b4 100644
--- a/src/util/gpu_device.cpp
+++ b/src/util/gpu_device.cpp
@@ -19,7 +19,7 @@
 
 #include "fmt/format.h"
 #include "imgui.h"
-#include "shaderc/shaderc.h"
+#include "shaderc_ds/shaderc.h"
 #include "spirv_cross_c.h"
 #include "xxhash.h"
 
@@ -1287,7 +1287,7 @@ bool dyn_libs::OpenShaderc(Error* error)
   if (s_shaderc_library.IsOpen())
     return true;
 
-  const std::string libname = DynamicLibrary::GetVersionedFilename(SHADERC_LIB_NAME);
+  const std::string libname = DynamicLibrary::GetVersionedFilename(SHADERC_LIB_NAME, 1);
   if (!s_shaderc_library.Open(libname.c_str(), error))
   {
     Error::AddPrefix(error, "Failed to load shaderc: ");
-- 
2.47.0

