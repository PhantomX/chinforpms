From acc1480e72a1fae727cd474d39f1ba281db314da Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Thu, 17 Mar 2022 13:53:39 -0300
Subject: [PATCH] Makefile: package build fixes

---
 Makefile | 68 +++++++++++++++++++++++++++++++++++++++++++-------------
 1 file changed, 52 insertions(+), 16 deletions(-)

diff --git a/Makefile b/Makefile
index 722fcc9..83440e6 100644
--- a/Makefile
+++ b/Makefile
@@ -3,10 +3,10 @@ DIR_DIFF := 1
 MT       := 1
 # 0: not need zlib;  1: compile zlib source code;  2: used -lz to link zlib lib;
 ZLIB     := 2
-LZMA     := 1
+LZMA     := 2
 ARM64ASM := 0
 # 0: not need zstd;  1: compile zstd source code;  2: used -lzstd to link zstd lib;
-ZSTD     := 1
+ZSTD     := 2
 MD5      := 1
 STATIC_CPP := 0
 # used clang?
@@ -31,6 +31,15 @@ ifeq ($(BZIP2),0)
   endif
 endif
 
+PREFIX ?= /usr/local
+BINDIR ?= $(PREFIX)/bin
+LIBDIR ?= $(PREFIX)/lib
+INCDIR ?= $(PREFIX)/include
+
+LIBRARY = libhdiffpatch.so
+LIBRARYMINOR = $(LIBRARY)._RPM_MINOR_
+LIBRARYMAJOR = $(LIBRARYMINOR)._RPM_MAJOR_
+
 HDIFF_OBJ  := 
 HPATCH_OBJ := \
     libHDiffPatch/HPatch/patch.o \
@@ -51,7 +60,7 @@ ifeq ($(BSD),0)
 else
 	HPATCH_OBJ += bsdiff_wrapper/bspatch_wrapper.o
 endif
-MD5_PATH := ../libmd5
+MD5_PATH := libmd5
 ifeq ($(DIR_DIFF),0)
 else
   ifeq ($(MD5),0)
@@ -60,8 +69,7 @@ else
   endif
 endif
 LZMA_PATH := ../lzma/C
-ifeq ($(LZMA),0)
-else # https://www.7-zip.org  https://github.com/sisong/lzma
+ifeq ($(LZMA),1) # https://www.7-zip.org  https://github.com/sisong/lzma
   HPATCH_OBJ += $(LZMA_PATH)/LzmaDec.o \
   				$(LZMA_PATH)/Lzma2Dec.o 
   ifeq ($(ARM64ASM),0)
@@ -175,7 +183,7 @@ endif
 
 
 DEF_FLAGS := \
-    -O3 -DNDEBUG -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 \
+    -fPIC -DNDEBUG -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 \
     -D_IS_NEED_ALL_CompressPlugin=0 \
     -D_IS_NEED_DEFAULT_CompressPlugin=0 \
     -D_IS_NEED_ALL_ChecksumPlugin=0 \
@@ -201,6 +209,9 @@ else
 	ifeq ($(BZIP2),1)
         DEF_FLAGS += -I$(BZ2_PATH)
 	endif
+	ifeq ($(BZIP2),2)
+        DEF_FLAGS += $(shell pkg-config --cflags-only-I bzip2)
+	endif
 endif
 ifeq ($(ZLIB),0)
 else
@@ -208,6 +219,9 @@ else
 	ifeq ($(ZLIB),1)
         DEF_FLAGS += -I$(ZLIB_PATH)
 	endif
+	ifeq ($(ZLIB),2)
+        DEF_FLAGS += $(shell pkg-config --cflags-only-I zlib)
+	endif
 endif
 ifeq ($(DIR_DIFF),0)
   DEF_FLAGS += -D_IS_NEED_DIR_DIFF_PATCH=0
@@ -231,11 +245,17 @@ else
 endif
 ifeq ($(LZMA),0)
 else
-  DEF_FLAGS += -D_CompressPlugin_lzma -D_CompressPlugin_lzma2 -I$(LZMA_PATH)
+  DEF_FLAGS += -D_CompressPlugin_lzma -D_CompressPlugin_lzma2
   ifeq ($(ARM64ASM),0)
   else
     DEF_FLAGS += -D_LZMA_DEC_OPT
   endif
+	ifeq ($(LZMA),1)
+      DEF_FLAGS += -I$(LZMA_PATH)
+	endif
+	ifeq ($(LZMA),2)
+      DEF_FLAGS += $(shell pkg-config --cflags-only-I lzmasdk-c)
+	endif
 endif
 ifeq ($(ZSTD),0)
 else
@@ -244,6 +264,9 @@ else
       DEF_FLAGS += -DZSTD_DISABLE_ASM -DZSTD_HAVE_WEAK_SYMBOLS=0 -DZSTD_TRACE=0 \
 	    -I$(ZSTD_PATH) -I$(ZSTD_PATH)/common -I$(ZSTD_PATH)/compress -I$(ZSTD_PATH)/decompress
 	endif
+	ifeq ($(ZSTD),2)
+      DEF_FLAGS += $(shell pkg-config --cflags-only-I libzstd)
+	endif
 endif
 
 ifeq ($(MT),0)
@@ -264,6 +287,9 @@ endif
 ifeq ($(BZIP2),2)
   PATCH_LINK += -lbz2		# link bzip2
 endif
+ifeq ($(LZMA),2)
+  PATCH_LINK += -llzmasdk		# link lzmasdk
+endif
 ifeq ($(ZSTD),2)
   PATCH_LINK += -lzstd		# link zstd
 endif
@@ -295,15 +321,15 @@ CXXFLAGS += $(DEF_FLAGS)
 
 .PHONY: all install clean
 
-all: libhdiffpatch.a hpatchz hdiffz mostlyclean
+all: $(LIBRARYMAJOR) hpatchz hdiffz
 
-libhdiffpatch.a: $(HDIFF_OBJ)
-	$(AR) rcs $@ $^
+$(LIBRARYMAJOR): $(HDIFF_OBJ)
+	$(CXX) -o $(LIBRARYMAJOR) -shared -Wl,-soname=$(LIBRARYMINOR) -DNDEBUG $(LDFLAGS) -Wl,-z,defs $(HDIFF_OBJ) $(PATCH_LINK)
 
 hpatchz: $(HPATCH_OBJ)
-	$(CC) hpatchz.c $(HPATCH_OBJ) $(CFLAGS) $(PATCH_LINK) -o hpatchz
-hdiffz: libhdiffpatch.a
-	$(CXX) hdiffz.cpp libhdiffpatch.a $(CXXFLAGS) $(DIFF_LINK) -o hdiffz
+	$(CC) hpatchz.c $(HPATCH_OBJ) $(CFLAGS) $(LDFLAGS) $(PATCH_LINK) -o hpatchz
+hdiffz: $(LIBRARYMAJOR)
+	$(CXX) hdiffz.cpp $(LIBRARYMAJOR) $(CXXFLAGS) $(LDFLAGS) $(DIFF_LINK) -o hdiffz
 
 ifeq ($(OS),Windows_NT) # mingw?
   RM := del /Q /F
@@ -312,17 +338,27 @@ else
   RM := rm -f
   DEL_HDIFF_OBJ := $(HDIFF_OBJ)
 endif
-INSTALL_X := install -m 0755
-INSTALL_BIN := $(DESTDIR)/usr/local/bin
+INSTALL_X := install -m 0755 -D
+INSTALL_F := install -m 0644 -D
+INSTALL_BIN := $(DESTDIR)/$(BINDIR)
+INSTALL_LIB := $(DESTDIR)/$(LIBDIR)
+INSTALL_INC := $(DESTDIR)/$(INCDIR)
 
 mostlyclean: hpatchz hdiffz
 	$(RM) $(DEL_HDIFF_OBJ)
 clean:
-	$(RM) libhdiffpatch.a hpatchz hdiffz $(DEL_HDIFF_OBJ)
+	$(RM) $(LIBRARYMAJOR) hpatchz hdiffz $(DEL_HDIFF_OBJ)
 
 install: all
 	$(INSTALL_X) hdiffz $(INSTALL_BIN)/hdiffz
 	$(INSTALL_X) hpatchz $(INSTALL_BIN)/hpatchz
+	$(INSTALL_X) $(LIBRARYMAJOR) $(INSTALL_LIB)/$(LIBRARYMAJOR)
+	ln -s $(LIBRARYMAJOR) $(INSTALL_LIB)/$(LIBRARYMINOR)
+	ln -s $(LIBRARYMINOR) $(INSTALL_LIB)/$(LIBRARY)
+	$(INSTALL_F) libHDiffPatch/HDiff/diff.h $(INSTALL_INC)/HDiffPatch/HDiff/diff.h
+	$(INSTALL_F) libHDiffPatch/HPatch/patch.h $(INSTALL_INC)/HDiffPatch/HPatch/patch.h
+	$(INSTALL_F) dirDiffPatch/dir_diff/dir_diff.h $(INSTALL_INC)/HDiffPatch/dir_diff/dir_diff.h
+	$(INSTALL_F) dirDiffPatch/dir_patch/dir_patch.h $(INSTALL_INC)/HDiffPatch/dir_patch/dir_patch.h
 
 uninstall:
 	$(RM)  $(INSTALL_BIN)/hdiffz  $(INSTALL_BIN)/hpatchz
-- 
2.36.1

