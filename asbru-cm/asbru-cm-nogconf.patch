From bef05c2294539b3f8564494d0f66963e0e27e289 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Fri, 10 May 2019 08:45:55 -0300
Subject: [PATCH] Disable GConf2 proxy settings requests

This breaks GConf free systems
---
 lib/PACConfig.pm | 12 ++++--------
 lib/PACEdit.pm   |  3 ---
 lib/pac_conn     | 12 ++++--------
 res/pac.glade    |  2 +-
 4 files changed, 9 insertions(+), 20 deletions(-)

diff --git a/lib/PACConfig.pm b/lib/PACConfig.pm
index 51f0836..2803324 100644
--- a/lib/PACConfig.pm
+++ b/lib/PACConfig.pm
@@ -33,7 +33,6 @@ use warnings;
 use FindBin qw ( $RealBin $Bin $Script );
 use YAML qw ( LoadFile DumpFile );
 use Storable;
-use Gnome2::GConf;
 use Crypt::CBC;
 
 # GTK2
@@ -62,9 +61,6 @@ my $GLADE_FILE		= $RealBin . '/res/pac.glade';
 my $CFG_DIR			= $ENV{'HOME'} . '/.config/pac';
 my $RES_DIR			= $RealBin . '/res';
 
-# Connect to Gnome's GConf
-my $GCONF			= Gnome2::GConf::Client -> get_default;
-
 my $CIPHER			= Crypt::CBC -> new( -key => 'PAC Manager (David Torrejon Vaquerizas, david.tv@gmail.com)', -cipher => 'Blowfish', -salt => '12345678' ) or die "ERROR: $!";
 
 # END: Define GLOBAL CLASS variables
@@ -507,10 +503,10 @@ sub _updateGUIPreferences {
 	my $cfg = shift // $$self{_CFG};
 
 	# Get PROXY from environment
-	my $proxy_ip		= $GCONF -> get_string( '/system/http_proxy/host' ) || $GCONF -> get_string( '/system/proxy/http/host' );
-	my $proxy_port		= $GCONF -> get_int( '/system/http_proxy/port' ) || $GCONF -> get_string( '/system/proxy/http/port' );
-	my $proxy_user		= $GCONF -> get_string( '/system/http_proxy/authentication_user' ) || $GCONF -> get_string( '/system/proxy/http/host/authentication-user' );
-	my $proxy_pass		= $GCONF -> get_string( '/system/http_proxy/authentication_password' ) || $GCONF -> get_string( '/system/proxy/http/host/authentication-password' );
+	my $proxy_ip		= '';
+	my $proxy_port		= '';
+	my $proxy_user		= '';
+	my $proxy_pass		= '';
 	my $proxy_string	= 'no proxy configured';
 	$proxy_ip		and $proxy_string = "$proxy_ip:$proxy_port";
 	$proxy_user		and $proxy_string .= "; User: $proxy_user, Pass: <password hidden!>";
diff --git a/lib/PACEdit.pm b/lib/PACEdit.pm
index 48d0f94..a697312 100644
--- a/lib/PACEdit.pm
+++ b/lib/PACEdit.pm
@@ -36,7 +36,6 @@ use warnings;
 use YAML qw ( LoadFile DumpFile );
 use Storable qw ( dclone nstore nstore_fd fd_retrieve );
 use Encode;
-use Gnome2::GConf;
 
 # GTK2
 use Gtk2 '-init';
@@ -68,8 +67,6 @@ my $INIT_CFG_FILE	= $RES_DIR . '/pac.yml';
 my $CFG_DIR			= $ENV{'HOME'} . '/.config/pac';
 my $CFG_FILE		= $CFG_DIR . '/pac.yml';
 
-my $GCONF			= Gnome2::GConf::Client -> get_default;
-
 # END: Define GLOBAL CLASS variables
 ###################################################################
 
diff --git a/lib/pac_conn b/lib/pac_conn
index a2fb954..d3bd56e 100755
--- a/lib/pac_conn
+++ b/lib/pac_conn
@@ -33,7 +33,6 @@ use FindBin qw ( $RealBin $Bin $Script );
 use lib $RealBin, $RealBin . '/ex', $RealBin . '/edit';
 use Storable qw ( dclone thaw retrieve fd_retrieve nstore_fd );
 use Expect;
-use Gnome2::GConf;
 use POSIX qw ( strftime );
 use Encode qw ( encode decode );
 use IO::Socket::INET;
@@ -83,9 +82,6 @@ $Expect::Multiline_Matching = 1;
 my $EXP = new Expect;
 eval { $EXP -> slave -> clone_winsize_from( \*STDIN ); };
 
-# Connect to Gnome's GConf
-my $GCONF = Gnome2::GConf::Client -> get_default;
-
 # END OF : Variables declaration/initialization
 ########################################################
 
@@ -114,10 +110,10 @@ $UUID		= shift or die $COLOR{'err'} . "ERROR: You must provide a profile to conn
 $GETCMD		= shift // 0;
 
 # Get PROXY from environment
-$PROXY{'env'}{'ip'}		= $GCONF -> get_string( '/system/http_proxy/host' ) || $GCONF -> get_string( '/system/proxy/http/host' );
-$PROXY{'env'}{'port'}	= $GCONF -> get_int( '/system/http_proxy/port' ) || $GCONF -> get_string( '/system/proxy/http/port' );
-$PROXY{'env'}{'user'}	= $GCONF -> get_string( '/system/http_proxy/authentication_user' ) || $GCONF -> get_string( '/system/proxy/http/host/authentication-user' );
-$PROXY{'env'}{'pass'}	= $GCONF -> get_string( '/system/http_proxy/authentication_password' ) || $GCONF -> get_string( '/system/proxy/http/host/authentication-password' );
+$PROXY{'env'}{'ip'}		= '';
+$PROXY{'env'}{'port'}	= '';
+$PROXY{'env'}{'user'}	= '';
+$PROXY{'env'}{'pass'}	= '';
 
 # Load the 'freezed' configuration
 $CFG = retrieve( $CFG_FILE ) or die "ERROR: Could not load config file '$CFG_FILE': $!";
diff --git a/res/pac.glade b/res/pac.glade
index 0325b72..a6b98b8 100644
--- a/res/pac.glade
+++ b/res/pac.glade
@@ -4664,7 +4664,7 @@ tty</property>
                             <property name="can_focus">True</property>
                             <property name="receives_default">False</property>
                             <property name="has_tooltip">True</property>
-                            <property name="tooltip" translatable="yes">Try to use GConf's configured proxy (if any)</property>
+                            <property name="tooltip" translatable="yes">Do nothing</property>
                             <property name="use_action_appearance">False</property>
                             <property name="active">True</property>
                             <property name="draw_indicator">True</property>
-- 
2.21.0

