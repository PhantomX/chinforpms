From 4d68c3d7cb878aa0a0ae6bf177cb18b7f9af266b Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Wed, 5 Feb 2025 20:31:44 -0300
Subject: [PATCH] Use system libraries

---
 thirdparty/CMakeLists.txt | 25 ++++++++++++++++---------
 1 file changed, 16 insertions(+), 9 deletions(-)

diff --git a/thirdparty/CMakeLists.txt b/thirdparty/CMakeLists.txt
index 156f348..da581f0 100644
--- a/thirdparty/CMakeLists.txt
+++ b/thirdparty/CMakeLists.txt
@@ -7,6 +7,14 @@ target_compile_options(sljit PRIVATE $<$<COMPILE_LANG_AND_ID:C,AppleClang,Clang,
 option(ARES_ENABLE_CHD "Enable CHD format support via libchdr" ON)
 
 if(ARES_ENABLE_CHD)
+  find_package(PkgConfig QUIET)
+  
+  pkg_search_module(libchdr IMPORTED_TARGET libchdr)
+  if(libchdr_FOUND)
+    message(STATUS "Using the system libchdr")
+    add_library(chdr-static INTERFACE)
+    target_link_libraries(chdr-static INTERFACE PkgConfig::libchdr)
+  else()
   # lzma
   add_subdirectory(libchdr/deps/lzma-24.05 EXCLUDE_FROM_ALL)
   list(APPEND CHDR_LIBS lzma)
@@ -56,6 +64,13 @@ if(ARES_ENABLE_CHD)
     chdr-static
     PRIVATE $<$<CXX_COMPILER_ID:Clang,AppleClang>:-Wno-unreachable-code -Wno-unused-function>
   )
+  set_target_properties(chdr-static PROPERTIES FOLDER thirdparty PREFIX "")
+  if(NOT WITH_SYSTEM_ZLIB)
+    set_target_properties(zlib PROPERTIES FOLDER thirdparty PREFIX "")
+  endif()
+  set_target_properties(lzma PROPERTIES FOLDER thirdparty PREFIX "")
+  set_target_properties(libzstd_static PROPERTIES FOLDER thirdparty PREFIX "")
+  endif()
 endif()
 
 add_library(
@@ -111,12 +126,4 @@ add_library(
 set_target_properties(ymfm PROPERTIES FOLDER thirdparty PREFIX "")
 set_target_properties(tzxfile PROPERTIES FOLDER thirdparty PREFIX "")
 set_target_properties(sljit PROPERTIES FOLDER thirdparty PREFIX "")
-if(ARES_ENABLE_CHD)
-  set_target_properties(chdr-static PROPERTIES FOLDER thirdparty PREFIX "")
-  if(NOT WITH_SYSTEM_ZLIB)
-    set_target_properties(zlib PROPERTIES FOLDER thirdparty PREFIX "")
-  endif()
-  set_target_properties(lzma PROPERTIES FOLDER thirdparty PREFIX "")
-  set_target_properties(libzstd_static PROPERTIES FOLDER thirdparty PREFIX "")
-endif()
-set_target_properties(qon PROPERTIES FOLDER thirdparty PREFIX "")
\ No newline at end of file
+set_target_properties(qon PROPERTIES FOLDER thirdparty PREFIX "")
-- 
2.51.0

