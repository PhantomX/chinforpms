From a5ae3c6b3ce566932c0e460362612d37df4853cc Mon Sep 17 00:00:00 2001
From: Fedora Kernel Team <kernel-team@fedoraproject.org>
Date: Thu, 6 May 2021 11:01:27 -0300
Subject: [PATCH] Fix double fault in md_end_io
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Patch from Guoqing Jiang and PaweÅ‚ Wiejacha
https://lore.kernel.org/linux-raid/CADLTsw340wuEoX02ad-M6mN_48uDdnkj0dZSJGYMFrjgB+y80Q@mail.gmail.com/
---
 block/bio.c         | 3 ++-
 drivers/md/md.c     | 3 ++-
 include/linux/bio.h | 1 +
 3 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/block/bio.c b/block/bio.c
index 50e5790..05d7d48 100644
--- a/block/bio.c
+++ b/block/bio.c
@@ -283,10 +283,11 @@ static struct bio *__bio_chain_endio(struct bio *bio)
 	return parent;
 }
 
-static void bio_chain_endio(struct bio *bio)
+void bio_chain_endio(struct bio *bio)
 {
 	bio_endio(__bio_chain_endio(bio));
 }
+EXPORT_SYMBOL(bio_chain_endio);
 
 /**
  * bio_chain - chain bio completions
diff --git a/drivers/md/md.c b/drivers/md/md.c
index 21da0c4..e50d7a3 100644
--- a/drivers/md/md.c
+++ b/drivers/md/md.c
@@ -489,7 +489,8 @@ static blk_qc_t md_submit_bio(struct bio *bio)
 		return BLK_QC_T_NONE;
 	}
 
-	if (bio->bi_end_io != md_end_io) {
+	if (bio->bi_end_io != md_end_io && bio->bi_end_io !=
+							 bio_chain_endio) {
 		struct md_io *md_io;
 
 		md_io = mempool_alloc(&mddev->md_io_pool, GFP_NOIO);
diff --git a/include/linux/bio.h b/include/linux/bio.h
index d0246c9..d205f83 100644
--- a/include/linux/bio.h
+++ b/include/linux/bio.h
@@ -429,6 +429,7 @@ static inline struct bio *bio_alloc(gfp_t gfp_mask, unsigned short nr_iovecs)
 extern blk_qc_t submit_bio(struct bio *);
 
 extern void bio_endio(struct bio *);
+extern void bio_chain_endio(struct bio *bio);
 
 static inline void bio_io_error(struct bio *bio)
 {
-- 
2.31.1

