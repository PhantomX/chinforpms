From b24ad15407161540d50f9eb2a94b6cc08b8397d8 Mon Sep 17 00:00:00 2001
From: fdmanana@kernel.org
Date: Thu, 1 Feb 2024 18:13:28 -0300
Subject: [PATCH 1/2] btrfs: unused block deletion fix followup 1

https://lore.kernel.org/linux-btrfs/CAL3q7H6802ayLHUJFztzZAVzBLJAGdFx=6FHNNy87+obZXXZpQ@mail.gmail.com/
---
 fs/btrfs/disk-io.c     | 3 ++-
 fs/btrfs/transaction.c | 6 +++++-
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/fs/btrfs/disk-io.c b/fs/btrfs/disk-io.c
index 62cb97f..ee4f414 100644
--- a/fs/btrfs/disk-io.c
+++ b/fs/btrfs/disk-io.c
@@ -3567,7 +3567,8 @@ int __cold open_ctree(struct super_block *sb, struct btrfs_fs_devices *fs_device
 	set_bit(BTRFS_FS_OPEN, &fs_info->flags);
 
 	/* Kick the cleaner thread so it'll start deleting snapshots. */
-	if (test_bit(BTRFS_FS_UNFINISHED_DROPS, &fs_info->flags))
+	if (test_bit(BTRFS_FS_UNFINISHED_DROPS, &fs_info->flags) ||
+	    !list_empty(&fs_info->unused_bgs))
 		wake_up_process(fs_info->cleaner_kthread);
 
 clear_oneshot:
diff --git a/fs/btrfs/transaction.c b/fs/btrfs/transaction.c
index 5b3333c..afea4a8 100644
--- a/fs/btrfs/transaction.c
+++ b/fs/btrfs/transaction.c
@@ -1104,6 +1104,9 @@ static int __btrfs_end_transaction(struct btrfs_trans_handle *trans,
 
 	btrfs_trans_release_chunk_metadata(trans);
 
+	if (!test_bit(BTRFS_FS_CLEANER_RUNNING, &info->flags))
+		wake_up_process(info->cleaner_kthread);
+
 	if (trans->type & __TRANS_FREEZABLE)
 		sb_end_intwrite(info->sb);
 
@@ -2552,7 +2555,8 @@ int btrfs_commit_transaction(struct btrfs_trans_handle *trans)
 	btrfs_trans_state_lockdep_release(fs_info, BTRFS_LOCKDEP_TRANS_UNBLOCKED);
 
 	/* If we have features changed, wake up the cleaner to update sysfs. */
-	if (test_bit(BTRFS_FS_FEATURE_CHANGED, &fs_info->flags) &&
+	if ((test_bit(BTRFS_FS_FEATURE_CHANGED, &fs_info->flags) ||
+	     !list_empty(&fs_info->unused_bgs)) &&
 	    fs_info->cleaner_kthread)
 		wake_up_process(fs_info->cleaner_kthread);
 
-- 
2.43.0

