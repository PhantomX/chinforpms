From 947edf15bf7908ca5cc085f12768bb811c80b391 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Mon, 19 Oct 2020 21:32:04 -0300
Subject: [PATCH 1/2] Revert: futex: Add Proton compatibility code

This reverts 342e115d5935758d33ca3fbc44d6ff22cf46c988
---
 include/uapi/linux/futex.h | 2 +-
 kernel/futex.c             | 5 ++---
 2 files changed, 3 insertions(+), 4 deletions(-)

diff --git a/include/uapi/linux/futex.h b/include/uapi/linux/futex.h
index a3e7608..580001e 100644
--- a/include/uapi/linux/futex.h
+++ b/include/uapi/linux/futex.h
@@ -21,7 +21,7 @@
 #define FUTEX_WAKE_BITSET	10
 #define FUTEX_WAIT_REQUEUE_PI	11
 #define FUTEX_CMP_REQUEUE_PI	12
-#define FUTEX_WAIT_MULTIPLE	31
+#define FUTEX_WAIT_MULTIPLE	13
 
 #define FUTEX_PRIVATE_FLAG	128
 #define FUTEX_CLOCK_REALTIME	256
diff --git a/kernel/futex.c b/kernel/futex.c
index 03d89fe..6f4bea7 100644
--- a/kernel/futex.c
+++ b/kernel/futex.c
@@ -4059,7 +4059,7 @@ SYSCALL_DEFINE6(futex, u32 __user *, uaddr, int, op, u32, val,
 			return -EINVAL;
 
 		t = timespec64_to_ktime(ts);
-		if (cmd == FUTEX_WAIT || cmd == FUTEX_WAIT_MULTIPLE)
+		if (cmd == FUTEX_WAIT)
 			t = ktime_add_safe(ktime_get(), t);
 		tp = &t;
 	}
@@ -4260,7 +4260,6 @@ COMPAT_SYSCALL_DEFINE3(get_robust_list, int, pid,
  */
 struct compat_futex_wait_block {
 	compat_uptr_t	uaddr;
-	__u32 pad;
 	__u32 val;
 	__u32 bitset;
 };
@@ -4323,7 +4322,7 @@ SYSCALL_DEFINE6(futex_time32, u32 __user *, uaddr, int, op, u32, val,
 			return -EINVAL;
 
 		t = timespec64_to_ktime(ts);
-		if (cmd == FUTEX_WAIT || cmd == FUTEX_WAIT_MULTIPLE)
+		if (cmd == FUTEX_WAIT)
 			t = ktime_add_safe(ktime_get(), t);
 		tp = &t;
 	}
-- 
2.28.0

