From 4009f741930c22ff5ccb44d52f2e2d8eb3f3afff Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Sun, 7 Jan 2024 17:50:57 -0300
Subject: [PATCH] fix build flags

---
 Makefiles/Makefile.UNIX | 18 +++++++++++++-----
 Makefiles/Rules.inc     | 13 ++++++-------
 2 files changed, 19 insertions(+), 12 deletions(-)

diff --git a/Makefiles/Makefile.UNIX b/Makefiles/Makefile.UNIX
index af02998..49a0b9a 100644
--- a/Makefiles/Makefile.UNIX
+++ b/Makefiles/Makefile.UNIX
@@ -62,18 +62,26 @@ LD = gcc
 # SDL
 #
 
-SDL2_CFLAGS = `sdl2-config --cflags`
-SDL2_LIBS = `sdl2-config --libs`
+SDL2_CFLAGS = `pkg-config --cflags sdl2`
+SDL2_LIBS = `pkg-config --libs sdl2`
 ifeq ($(strip $(NET_BOARD)),1)
-	SDL2_LIBS += -lSDL2_net
+	SDL2_NET_CFLAGS = `pkg-config --cflags SDL2_net`
+	SDL2_NET_LIBS = `pkg-config --libs SDL2_net
 endif
 
 #
 #	UNIX-specific
 #
 
-PLATFORM_CXXFLAGS = $(SDL2_CFLAGS) -O3
-PLATFORM_LDFLAGS = $(SDL2_LIBS) -lGL -lGLU -lz -lm -lstdc++ -lpthread
+GL_CFLAGS = `pkg-config --cflags gl`
+GL_LIBS = `pkg-config --libs gl`
+GLU_CFLAGS = `pkg-config --cflags glu`
+GLU_LIBS = `pkg-config --libs glu`
+ZLIB_CFLAGS = `pkg-config --cflags zlib`
+ZLIB_LIBS = `pkg-config --libs zlib`
+
+PLATFORM_CXXFLAGS = $(SDL2_CFLAGS) $(SDL2_NET_CFLAGS) $(GL_CFLAGS) $(GLU_CFLAGS) $(ZLIB_CFLAGS)
+PLATFORM_LDFLAGS = $(SDL2_LIBS) $(SDL2_NET_LIBS) $(GL_LIBS) $(GLU_LIBS) $(ZLIB_LIBS) -lm -lstdc++ -lpthread
 PLATFORM_BINARY_EXTENSION =
 
 
diff --git a/Makefiles/Rules.inc b/Makefiles/Rules.inc
index ae3c05f..0c15d92 100644
--- a/Makefiles/Rules.inc
+++ b/Makefiles/Rules.inc
@@ -69,14 +69,13 @@ endif
 # Compiler options
 #
 ARCH =
-OPT = -O3
+CFLAGS ?= -O3
 ifeq ($(strip $(DEBUG)),1)
 	OPT = -g	# no optimization; debug mode
 endif
 WARN = -Wall
 CSTD = -std=iso9899:2011
 CXXSTD = -std=c++17
-LDOPT = -s
 ifeq ($(strip $(DEBUG)),1)
 	LDOPT =
 endif
@@ -84,10 +83,10 @@ endif
 #
 # Construct the compiler (C and C++) and linker flags
 #
-COMMON_CFLAGS = -c $(ARCH) $(OPT) $(WARN) $(addprefix -I,$(sort $(INCLUDE_DIRS))) -DGLEW_STATIC $(SUPERMODEL_BUILD_FLAGS)
-CFLAGS = $(COMMON_CFLAGS) $(CSTD)
-CXXFLAGS = $(PLATFORM_CXXFLAGS) $(COMMON_CFLAGS) $(CXXSTD)
-LDFLAGS = -o $(BIN_DIR)/$(SUPERMODEL_BINARY) $(PLATFORM_LDFLAGS) $(LDOPT)
+COMMON_CFLAGS = -c $(ARCH) $(WARN) $(addprefix -I,$(sort $(INCLUDE_DIRS))) -DGLEW_STATIC $(SUPERMODEL_BUILD_FLAGS)
+CFLAGS += $(COMMON_CFLAGS) $(CSTD)
+CXXFLAGS += $(PLATFORM_CXXFLAGS) $(COMMON_CFLAGS) $(CXXSTD)
+LDFLAGS += -o $(BIN_DIR)/$(SUPERMODEL_BINARY) $(PLATFORM_LDFLAGS) $(LDOPT)
 
 
 ###############################################################################
@@ -384,7 +383,7 @@ $(OBJ_DIR)/%.o:	%.c | $(OBJ_DIR)
 
 MUSASHI_OUTFILE = $(OBJ_DIR)/m68kmake.exe # do not remove the .exe suffix!
 MUSASHI_CFLAGS = -ISrc/CPU/68K/Musashi -I$(OBJ_DIR) -DINLINE="static inline" -Wno-unused-variable
-MUSASHI_LDFLAGS = -o $(MUSASHI_OUTFILE) $(OBJ_DIR)/m68kmake.o -s
+MUSASHI_LDFLAGS = -o $(MUSASHI_OUTFILE) $(OBJ_DIR)/m68kmake.o
 
 $(MUSASHI_OUTFILE): Src/CPU/68K/Musashi/m68kmake.c Src/CPU/68K/Musashi/m68k_in.c | $(OBJ_DIR)
 	$(info --------------------------------------------------------------------------------)
-- 
2.52.0

