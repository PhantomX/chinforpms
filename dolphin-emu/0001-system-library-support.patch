From a2b809243b4e4f24795dbe1133c45cbea69d4c20 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Wed, 3 Aug 2022 22:19:34 -0300
Subject: [PATCH] system library support

---
 CMakeLists.txt                              | 13 ++++++++++++-
 Source/Core/Common/Hash.cpp                 |  6 ++++++
 Source/Core/DiscIO/CompressedBlob.cpp       | 12 ++++++++++++
 Source/Core/UpdaterCommon/UpdaterCommon.cpp |  4 ++++
 4 files changed, 34 insertions(+), 1 deletion(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 2cc8594..a5c4ca6 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -775,7 +775,18 @@ else()
   add_subdirectory(Externals/zstd)
 endif()
 
-add_subdirectory(Externals/zlib-ng)
+pkg_check_modules(ZLIBNG IMPORTED_TARGET zlib-ng)
+if (ZLIBNG_FOUND)
+  message(STATUS "Using shared zlib-ng")
+  add_library(zlibng-shared INTERFACE)
+  target_link_libraries(zlibng-shared INTERFACE PkgConfig::ZLIBNG)
+  add_library(ZLIB::ZLIB ALIAS zlibng-shared)
+  add_definitions(-DUSE_SHARED_ZLIBNG)
+else()
+  check_vendoring_approved(zlib-ng)
+  message(STATUS "Using static zlib-ng from Externals")
+  add_subdirectory(Externals/zlib-ng)
+endif()
 
 pkg_check_modules(MINIZIP minizip>=3.0.0)
 if(MINIZIP_FOUND)
diff --git a/Source/Core/Common/Hash.cpp b/Source/Core/Common/Hash.cpp
index e6b421e..612128f 100644
--- a/Source/Core/Common/Hash.cpp
+++ b/Source/Core/Common/Hash.cpp
@@ -7,7 +7,13 @@
 #include <bit>
 #include <cstring>
 
+#ifdef USE_SHARED_ZLIBNG
+#include <zlib-ng.h>
+#define adler32_z zng_adler32_z
+#define crc32_z zng_crc32_z
+#else
 #include <zlib.h>
+#endif
 
 #include "Common/BitUtils.h"
 #include "Common/CPUDetect.h"
diff --git a/Source/Core/DiscIO/CompressedBlob.cpp b/Source/Core/DiscIO/CompressedBlob.cpp
index 139a1e6..bf487cb 100644
--- a/Source/Core/DiscIO/CompressedBlob.cpp
+++ b/Source/Core/DiscIO/CompressedBlob.cpp
@@ -11,7 +11,19 @@
 #include <utility>
 #include <vector>
 
+#ifdef USE_SHARED_ZLIBNG
+#include <zlib-ng.h>
+#define z_stream zng_stream
+#define inflateInit zng_inflateInit
+#define inflateEnd zng_inflateEnd
+#define inflate zng_inflate
+#define deflateInit zng_deflateInit
+#define deflateEnd zng_deflateEnd
+#define deflateReset zng_deflateReset
+#define deflate zng_deflate
+#else
 #include <zlib.h>
+#endif
 
 #ifdef _WIN32
 #include <windows.h>
diff --git a/Source/Core/UpdaterCommon/UpdaterCommon.cpp b/Source/Core/UpdaterCommon/UpdaterCommon.cpp
index 6fdb963..4f6d8de 100644
--- a/Source/Core/UpdaterCommon/UpdaterCommon.cpp
+++ b/Source/Core/UpdaterCommon/UpdaterCommon.cpp
@@ -11,7 +11,11 @@
 #include <ed25519.h>
 #include <mbedtls/base64.h>
 #include <mbedtls/sha256.h>
+#ifdef USE_SHARED_ZLIBNG
+#include <zlib-ng.h>
+#else
 #include <zlib.h>
+#endif
 
 #include "Common/CommonFuncs.h"
 #include "Common/CommonPaths.h"
-- 
2.39.1

