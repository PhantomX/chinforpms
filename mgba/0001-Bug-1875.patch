From e21ba124832c1a685010ba786227ce3ba26f9e27 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Fri, 11 Sep 2020 16:47:55 -0300
Subject: [PATCH] Bug 1875

https://github.com/mgba-emu/mgba/issues/1875
Fix by Eijebong
---
 aaa.patch                           | 39 +++++++++++++++++++++++++++++
 src/platform/qt/InputController.cpp |  3 +++
 src/platform/qt/InputController.h   |  2 ++
 3 files changed, 44 insertions(+)
 create mode 100644 aaa.patch

diff --git a/aaa.patch b/aaa.patch
new file mode 100644
index 0000000..c36e10b
--- /dev/null
+++ b/aaa.patch
@@ -0,0 +1,39 @@
+diff --git a/src/platform/qt/InputController.cpp b/src/platform/qt/InputController.cpp
+index f19130dd..681f98d5 100644
+--- a/src/platform/qt/InputController.cpp
++++ b/src/platform/qt/InputController.cpp
+@@ -650,14 +650,17 @@ void InputController::sendGamepadEvent(QEvent* event) {
+ }
+
+ void InputController::postPendingEvent(GBAKey key) {
++       QWriteLocker l(&m_eventsLock);
+        m_pendingEvents.insert(key);
+ }
+
+ void InputController::clearPendingEvent(GBAKey key) {
++       QWriteLocker l(&m_eventsLock);
+        m_pendingEvents.remove(key);
+ }
+
+ bool InputController::hasPendingEvent(GBAKey key) const {
++       QReadLocker l(&m_eventsLock);
+        return m_pendingEvents.contains(key);
+ }
+
+diff --git a/src/platform/qt/InputController.h b/src/platform/qt/InputController.h
+index 5c2c8502..72a766c9 100644
+--- a/src/platform/qt/InputController.h
++++ b/src/platform/qt/InputController.h
+@@ -10,6 +10,7 @@
+
+ #include <QImage>
+ #include <QMutex>
++#include <QReadWriteLock>
+ #include <QObject>
+ #include <QSet>
+ #include <QTimer>
+@@ -181,6 +182,7 @@ private:
+        QTimer m_gamepadTimer{nullptr};
+
+        QSet<GBAKey> m_pendingEvents;
++       mutable QReadWriteLock m_eventsLock;
diff --git a/src/platform/qt/InputController.cpp b/src/platform/qt/InputController.cpp
index f19130d..681f98d 100644
--- a/src/platform/qt/InputController.cpp
+++ b/src/platform/qt/InputController.cpp
@@ -650,14 +650,17 @@ void InputController::sendGamepadEvent(QEvent* event) {
 }
 
 void InputController::postPendingEvent(GBAKey key) {
+	QWriteLocker l(&m_eventsLock);
 	m_pendingEvents.insert(key);
 }
 
 void InputController::clearPendingEvent(GBAKey key) {
+	QWriteLocker l(&m_eventsLock);
 	m_pendingEvents.remove(key);
 }
 
 bool InputController::hasPendingEvent(GBAKey key) const {
+	QReadLocker l(&m_eventsLock);
 	return m_pendingEvents.contains(key);
 }
 
diff --git a/src/platform/qt/InputController.h b/src/platform/qt/InputController.h
index 5c2c850..72a766c 100644
--- a/src/platform/qt/InputController.h
+++ b/src/platform/qt/InputController.h
@@ -10,6 +10,7 @@
 
 #include <QImage>
 #include <QMutex>
+#include <QReadWriteLock>
 #include <QObject>
 #include <QSet>
 #include <QTimer>
@@ -181,6 +182,7 @@ private:
 	QTimer m_gamepadTimer{nullptr};
 
 	QSet<GBAKey> m_pendingEvents;
+	mutable QReadWriteLock m_eventsLock;
 };
 
 }
-- 
2.26.2

