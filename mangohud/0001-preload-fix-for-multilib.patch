From 328423acb2310bc6e6fa217282b467d790854549 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Thu, 11 Jun 2020 10:55:22 -0300
Subject: [PATCH] preload: fix for multilib

---
 bin/mangohud.in | 13 ++++---------
 src/meson.build |  2 +-
 2 files changed, 5 insertions(+), 10 deletions(-)

diff --git a/bin/mangohud.in b/bin/mangohud.in
index 3fed8a6..34754fa 100755
--- a/bin/mangohud.in
+++ b/bin/mangohud.in
@@ -1,8 +1,8 @@
 #!/bin/sh
 
-MANGOHUD_LIB_NAME="libMangoHud.so"
+MANGOHUD_LIB_NAME="/usr/\$LIB/mangohud/libMangoHud.so"
 if [ "$MANGOHUD_DLSYM" = "1" ]; then
-	MANGOHUD_LIB_NAME="libMangoHud_dlsym.so:${MANGOHUD_LIB_NAME}"
+	MANGOHUD_LIB_NAME="/usr/\$LIB/mangohud/libMangoHud_dlsym.so:${MANGOHUD_LIB_NAME}"
 fi
 
 if [ "$#" -eq 0 ]; then
@@ -15,11 +15,6 @@ fi
 
 # Execute the program under a clean environment
 # pass through the overriden LD_PRELOAD environment variables
-LD_PRELOAD="${LD_PRELOAD}:${MANGOHUD_LIB_NAME}"
-LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:@libdir_mangohud@"
+LD_PRELOAD="${LD_PRELOAD:+${LD_PRELOAD}:}${MANGOHUD_LIB_NAME}"
 
-if hash @mangohud_sh@ 2>/dev/null; then
-  exec env MANGOHUD=1 LD_LIBRARY_PATH="${LD_LIBRARY_PATH}" LD_PRELOAD="${LD_PRELOAD}" @mangohud_sh@ "$@"
-else
-  exec env MANGOHUD=1 LD_LIBRARY_PATH="${LD_LIBRARY_PATH}" LD_PRELOAD="${LD_PRELOAD}" "$@"
-fi
+exec env MANGOHUD=1 LD_PRELOAD="${LD_PRELOAD}" "$@"
diff --git a/src/meson.build b/src/meson.build
index 5790fcf..6373479 100644
--- a/src/meson.build
+++ b/src/meson.build
@@ -177,7 +177,7 @@ else
 endif
 
 configure_file(input : '../bin/mangohud.in',
-  output : 'mangohud@0@'.format(mangohud_cpu_family),
+  output : 'mangohud',
   configuration : {'libdir_mangohud' : libdir_mangohud, 'mangohud_sh' : mangohud_opposite_bin},
   install_dir : get_option('bindir'),
 )
-- 
2.26.2

