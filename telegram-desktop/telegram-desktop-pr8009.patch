From 5e9748dceb877bb34f317aa52e8e3e2f6eef2293 Mon Sep 17 00:00:00 2001
From: Nicholas Guriev <guriev-ns@ya.ru>
Date: Sat, 6 Jun 2020 17:19:05 +0300
Subject: [PATCH] Do not pop up emoji tabbed panel and media menu on mouse over

---
 Telegram/SourceFiles/chat_helpers/tabbed_panel.cpp     |  8 +-------
 Telegram/SourceFiles/chat_helpers/tabbed_panel.h       |  1 -
 Telegram/SourceFiles/history/history_widget.cpp        |  9 +++++++--
 .../history/view/history_view_compose_controls.cpp     |  9 +++++++--
 .../media/view/media_view_overlay_widget.cpp           | 10 +---------
 .../SourceFiles/media/view/media_view_overlay_widget.h |  1 -
 6 files changed, 16 insertions(+), 22 deletions(-)

diff --git a/Telegram/SourceFiles/chat_helpers/tabbed_panel.cpp b/Telegram/SourceFiles/chat_helpers/tabbed_panel.cpp
index 8fba46c57c..a69d71a7bb 100644
--- a/Telegram/SourceFiles/chat_helpers/tabbed_panel.cpp
+++ b/Telegram/SourceFiles/chat_helpers/tabbed_panel.cpp
@@ -231,10 +231,6 @@ void TabbedPanel::leaveEventHook(QEvent *e) {
 	return TWidget::leaveEventHook(e);
 }
 
-void TabbedPanel::otherEnter() {
-	showAnimated();
-}
-
 void TabbedPanel::otherLeave() {
 	if (preventAutoHide()) {
 		return;
@@ -402,9 +398,7 @@ void TabbedPanel::showStarted() {
 }
 
 bool TabbedPanel::eventFilter(QObject *obj, QEvent *e) {
-	if (e->type() == QEvent::Enter) {
-		otherEnter();
-	} else if (e->type() == QEvent::Leave) {
+	if (e->type() == QEvent::Leave) {
 		otherLeave();
 	}
 	return false;
diff --git a/Telegram/SourceFiles/chat_helpers/tabbed_panel.h b/Telegram/SourceFiles/chat_helpers/tabbed_panel.h
index b05966792f..f0cbc8dc5c 100644
--- a/Telegram/SourceFiles/chat_helpers/tabbed_panel.h
+++ b/Telegram/SourceFiles/chat_helpers/tabbed_panel.h
@@ -60,7 +60,6 @@ class TabbedPanel : public Ui::RpWidget {
 protected:
 	void enterEventHook(QEvent *e) override;
 	void leaveEventHook(QEvent *e) override;
-	void otherEnter();
 	void otherLeave();
 
 	void paintEvent(QPaintEvent *e) override;
diff --git a/Telegram/SourceFiles/history/history_widget.cpp b/Telegram/SourceFiles/history/history_widget.cpp
index 2574bfb697..8d892f21ff 100644
--- a/Telegram/SourceFiles/history/history_widget.cpp
+++ b/Telegram/SourceFiles/history/history_widget.cpp
@@ -678,8 +678,13 @@ void HistoryWidget::refreshTabbedPanel() {
 void HistoryWidget::initTabbedSelector() {
 	refreshTabbedPanel();
 
-	_tabbedSelectorToggle->addClickHandler([=] {
-		toggleTabbedSelectorMode();
+	_tabbedSelectorToggle->setAcceptBoth();
+	_tabbedSelectorToggle->addClickHandler([=](Qt::MouseButton mod) {
+		if (mod == Qt::LeftButton) {
+			_tabbedPanel->toggleAnimated();
+		} else if (mod == Qt::RightButton) {
+			toggleTabbedSelectorMode();
+		}
 	});
 
 	const auto selector = controller()->tabbedSelector();
diff --git a/Telegram/SourceFiles/history/view/history_view_compose_controls.cpp b/Telegram/SourceFiles/history/view/history_view_compose_controls.cpp
index 04daa403fd..1105c8b266 100644
--- a/Telegram/SourceFiles/history/view/history_view_compose_controls.cpp
+++ b/Telegram/SourceFiles/history/view/history_view_compose_controls.cpp
@@ -227,8 +227,13 @@ void ComposeControls::initTabbedSelector() {
 		setTabbedPanel(nullptr);
 	}
 
-	_tabbedSelectorToggle->addClickHandler([=] {
-		toggleTabbedSelectorMode();
+	_tabbedSelectorToggle->setAcceptBoth();
+	_tabbedSelectorToggle->addClickHandler([=](Qt::MouseButton mod) {
+		if (mod == Qt::LeftButton) {
+			_tabbedPanel->toggleAnimated();
+		} else if (mod == Qt::RightButton) {
+			toggleTabbedSelectorMode();
+		}
 	});
 
 	const auto selector = _window->tabbedSelector();
diff --git a/Telegram/SourceFiles/media/view/media_view_overlay_widget.cpp b/Telegram/SourceFiles/media/view/media_view_overlay_widget.cpp
index b2234b6918..501c8f049b 100644
--- a/Telegram/SourceFiles/media/view/media_view_overlay_widget.cpp
+++ b/Telegram/SourceFiles/media/view/media_view_overlay_widget.cpp
@@ -296,8 +296,7 @@ OverlayWidget::OverlayWidget()
 , _radial([=](crl::time now) { return radialAnimationCallback(now); })
 , _lastAction(-st::mediaviewDeltaFromLastAction, -st::mediaviewDeltaFromLastAction)
 , _stateAnimation([=](crl::time now) { return stateAnimationCallback(now); })
-, _dropdown(this, st::mediaviewDropdownMenu)
-, _dropdownShowTimer(this) {
+, _dropdown(this, st::mediaviewDropdownMenu) {
 	Lang::Updated(
 	) | rpl::start_with_next([=] {
 		refreshLang();
@@ -388,8 +387,6 @@ OverlayWidget::OverlayWidget()
 	_docCancel->addClickHandler([=] { onSaveCancel(); });
 
 	_dropdown->setHiddenCallback([this] { dropdownHidden(); });
-	_dropdownShowTimer->setSingleShot(true);
-	connect(_dropdownShowTimer, SIGNAL(timeout()), this, SLOT(onDropdown()));
 }
 
 void OverlayWidget::refreshLang() {
@@ -3616,11 +3613,6 @@ void OverlayWidget::updateOverRect(OverState state) {
 bool OverlayWidget::updateOverState(OverState newState) {
 	bool result = true;
 	if (_over != newState) {
-		if (newState == OverMore && !_ignoringDropdown) {
-			_dropdownShowTimer->start(0);
-		} else {
-			_dropdownShowTimer->stop();
-		}
 		updateOverRect(_over);
 		updateOverRect(newState);
 		if (_over != OverNone) {
diff --git a/Telegram/SourceFiles/media/view/media_view_overlay_widget.h b/Telegram/SourceFiles/media/view/media_view_overlay_widget.h
index 5ccabe4627..ec7d01336c 100644
--- a/Telegram/SourceFiles/media/view/media_view_overlay_widget.h
+++ b/Telegram/SourceFiles/media/view/media_view_overlay_widget.h
@@ -468,7 +468,6 @@ private slots:
 
 	Ui::PopupMenu *_menu = nullptr;
 	object_ptr<Ui::DropdownMenu> _dropdown;
-	object_ptr<QTimer> _dropdownShowTimer;
 
 	struct ActionData {
 		QString text;
