From 41e4ca220edfcb8a7e6b8f009b4467833a789c46 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Fri, 25 Jul 2025 16:31:50 -0300
Subject: [PATCH] Fix ltdp 0005 patch

---
 ltdp-0005-Option-to-disable-stories.patch | 18 +++++++++---------
 1 file changed, 9 insertions(+), 9 deletions(-)

diff --git a/ltdp-0005-Option-to-disable-stories.patch b/ltdp-0005-Option-to-disable-stories.patch
index 665f5d3..85cd5aa 100644
--- a/ltdp-0005-Option-to-disable-stories.patch
+++ b/ltdp-0005-Option-to-disable-stories.patch
@@ -23,8 +23,8 @@ index 0d9671f..f77cf4e 100644
 +});
 +
  [[nodiscard]] std::optional<StoryMedia> ParseMedia(
- 		not_null<Session*> owner,
- 		const MTPMessageMedia &media) {
+ 		not_null<PeerData*> peer,
+ 		const MTPMessageMedia &media,
 @@ -92,6 +101,8 @@ std::vector<StoryId> RespectingPinned(const StoriesIds &ids) {
  	return result;
  }
@@ -35,9 +35,9 @@ index 0d9671f..f77cf4e 100644
  	return {
  		.id = peer->id,
 @@ -364,6 +375,10 @@ void Stories::clearArchive(not_null<PeerData*> peer) {
- }
-
- void Stories::parseAndApply(const MTPPeerStories &stories) {
+ void Stories::parseAndApply(
+ 		const MTPPeerStories &stories,
+ 		ParseSource source) {
 +	if (DisableStories.value()) {
 +		return;
 +	}
@@ -61,26 +61,26 @@ index 4e6b0ce..b71076f 100644
 --- a/Telegram/SourceFiles/data/data_stories.h
 +++ b/Telegram/SourceFiles/data/data_stories.h
 @@ -30,6 +30,8 @@ struct StoryIdDates;
- class Story;
+ struct StoryAlbum;
  class StoryPreload;
 
 +extern const char kOptionDisableStories[];
 +
  struct StoriesIds {
- 	base::flat_set<StoryId, std::greater<>> list;
+ 	std::vector<StoryId> list; // flat_set<int, greater> for saved/archive.
  	std::vector<StoryId> pinnedToTop;
 diff --git a/Telegram/SourceFiles/settings/settings_experimental.cpp b/Telegram/SourceFiles/settings/settings_experimental.cpp
 index 983497e..db40ead 100644
 --- a/Telegram/SourceFiles/settings/settings_experimental.cpp
 +++ b/Telegram/SourceFiles/settings/settings_experimental.cpp
 @@ -19,6 +19,7 @@ https://github.com/telegramdesktop/tdesktop/blob/master/LEGAL
- #include "core/application.h"
  #include "core/launcher.h"
+ #include "core/sandbox.h"
  #include "chat_helpers/tabbed_panel.h"
 +#include "data/data_stories.h"
  #include "dialogs/dialogs_widget.h"
+ #include "history/history_item_components.h"
  #include "info/profile/info_profile_actions.h"
- #include "lang/lang_keys.h"
 @@ -140,6 +141,7 @@ void SetupExperimental(
  				: rpl::producer<>()));
  	};
-- 
2.52.0

