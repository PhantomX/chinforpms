From 010528521903f6f032024a0cce7e01c10093ceb0 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Sun, 6 Feb 2022 19:28:42 -0300
Subject: [PATCH] Do not pop up emoji tabbed panel and media menu on mouse over

Updated from https://github.com/telegramdesktop/tdesktop/pull/8009 by
Nicholas Guriev <guriev-ns@ya.ru>
---
 Telegram/SourceFiles/chat_helpers/tabbed_panel.cpp     | 10 +---------
 Telegram/SourceFiles/chat_helpers/tabbed_panel.h       |  1 -
 Telegram/SourceFiles/history/history_widget.cpp        |  9 +++++----
 .../view/controls/history_view_compose_controls.cpp    |  9 +++++----
 .../media/view/media_view_overlay_widget.cpp           |  6 ------
 .../SourceFiles/media/view/media_view_overlay_widget.h |  1 -
 6 files changed, 11 insertions(+), 25 deletions(-)

diff --git a/Telegram/SourceFiles/chat_helpers/tabbed_panel.cpp b/Telegram/SourceFiles/chat_helpers/tabbed_panel.cpp
index 606145e..bc758fb 100644
--- a/Telegram/SourceFiles/chat_helpers/tabbed_panel.cpp
+++ b/Telegram/SourceFiles/chat_helpers/tabbed_panel.cpp
@@ -258,10 +258,6 @@ void TabbedPanel::leaveEventHook(QEvent *e) {
 	return TWidget::leaveEventHook(e);
 }
 
-void TabbedPanel::otherEnter() {
-	showAnimated();
-}
-
 void TabbedPanel::otherLeave() {
 	if (preventAutoHide()) {
 		return;
@@ -438,11 +434,7 @@ void TabbedPanel::showStarted() {
 }
 
 bool TabbedPanel::eventFilter(QObject *obj, QEvent *e) {
-	if (TabbedPanelShowOnClick.value()) {
-		return false;
-	} else if (e->type() == QEvent::Enter) {
-		otherEnter();
-	} else if (e->type() == QEvent::Leave) {
+	if (e->type() == QEvent::Leave) {
 		otherLeave();
 	}
 	return false;
diff --git a/Telegram/SourceFiles/chat_helpers/tabbed_panel.h b/Telegram/SourceFiles/chat_helpers/tabbed_panel.h
index c592c4a..3c0293e 100644
--- a/Telegram/SourceFiles/chat_helpers/tabbed_panel.h
+++ b/Telegram/SourceFiles/chat_helpers/tabbed_panel.h
@@ -64,7 +64,6 @@ public:
 protected:
 	void enterEventHook(QEnterEvent *e) override;
 	void leaveEventHook(QEvent *e) override;
-	void otherEnter();
 	void otherLeave();
 
 	void paintEvent(QPaintEvent *e) override;
diff --git a/Telegram/SourceFiles/history/history_widget.cpp b/Telegram/SourceFiles/history/history_widget.cpp
index 1a29f31..a844b24 100644
--- a/Telegram/SourceFiles/history/history_widget.cpp
+++ b/Telegram/SourceFiles/history/history_widget.cpp
@@ -1031,10 +1031,11 @@ void HistoryWidget::initVoiceRecordBar() {
 void HistoryWidget::initTabbedSelector() {
 	refreshTabbedPanel();
 
-	_tabbedSelectorToggle->addClickHandler([=] {
-		if (_tabbedPanel && _tabbedPanel->isHidden()) {
-			_tabbedPanel->showAnimated();
-		} else {
+	_tabbedSelectorToggle->setAcceptBoth();
+	_tabbedSelectorToggle->addClickHandler([=](Qt::MouseButton mod) {
+		if (mod == Qt::LeftButton) {
+			_tabbedPanel->toggleAnimated();
+		} else if (mod == Qt::RightButton) {
 			toggleTabbedSelectorMode();
 		}
 	});
diff --git a/Telegram/SourceFiles/history/view/controls/history_view_compose_controls.cpp b/Telegram/SourceFiles/history/view/controls/history_view_compose_controls.cpp
index 3c5e3e5..bbb9119 100644
--- a/Telegram/SourceFiles/history/view/controls/history_view_compose_controls.cpp
+++ b/Telegram/SourceFiles/history/view/controls/history_view_compose_controls.cpp
@@ -1974,10 +1974,11 @@ void ComposeControls::initTabbedSelector() {
 		setTabbedPanel(nullptr);
 	}
 
-	_tabbedSelectorToggle->addClickHandler([=] {
-		if (_tabbedPanel && _tabbedPanel->isHidden()) {
-			_tabbedPanel->showAnimated();
-		} else {
+	_tabbedSelectorToggle->setAcceptBoth();
+	_tabbedSelectorToggle->addClickHandler([=](Qt::MouseButton mod) {
+		if (mod == Qt::LeftButton) {
+			_tabbedPanel->toggleAnimated();
+		} else if (mod == Qt::RightButton) {
 			toggleTabbedSelectorMode();
 		}
 	});
diff --git a/Telegram/SourceFiles/media/view/media_view_overlay_widget.cpp b/Telegram/SourceFiles/media/view/media_view_overlay_widget.cpp
index 5dfe337..ee8aa3f 100644
--- a/Telegram/SourceFiles/media/view/media_view_overlay_widget.cpp
+++ b/Telegram/SourceFiles/media/view/media_view_overlay_widget.cpp
@@ -508,7 +508,6 @@ OverlayWidget::OverlayWidget()
 	_docCancel->addClickHandler([=] { saveCancel(); });
 
 	_dropdown->setHiddenCallback([this] { dropdownHidden(); });
-	_dropdownShowTimer.setCallback([=] { showDropdown(); });
 
 	orderWidgets();
 }
@@ -4763,11 +4762,6 @@ void OverlayWidget::updateOverRect(OverState state) {
 bool OverlayWidget::updateOverState(OverState newState) {
 	bool result = true;
 	if (_over != newState) {
-		if (newState == OverMore && !_ignoringDropdown) {
-			_dropdownShowTimer.callOnce(0);
-		} else {
-			_dropdownShowTimer.cancel();
-		}
 		updateOverRect(_over);
 		updateOverRect(newState);
 		if (_over != OverNone) {
diff --git a/Telegram/SourceFiles/media/view/media_view_overlay_widget.h b/Telegram/SourceFiles/media/view/media_view_overlay_widget.h
index 37c853a..63847c0 100644
--- a/Telegram/SourceFiles/media/view/media_view_overlay_widget.h
+++ b/Telegram/SourceFiles/media/view/media_view_overlay_widget.h
@@ -600,7 +600,6 @@ private:
 
 	base::unique_qptr<Ui::PopupMenu> _menu;
 	object_ptr<Ui::DropdownMenu> _dropdown;
-	base::Timer _dropdownShowTimer;
 
 	bool _receiveMouse = true;
 
-- 
2.39.2

