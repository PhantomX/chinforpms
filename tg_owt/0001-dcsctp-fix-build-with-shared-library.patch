From b594eafec1951ca268cce50f49b0da1ff86ccf66 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Mon, 29 Nov 2021 10:50:09 -0300
Subject: [PATCH] dcsctp: fix build with shared library

---
 CMakeLists.txt                  | 63 +++++++++++++++++++++++++++++++++
 cmake/external.cmake            |  8 +++++
 src/net/dcsctp/packet/crc32c.cc |  2 +-
 3 files changed, 72 insertions(+), 1 deletion(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index f72b191..0941026 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -150,6 +150,7 @@ link_libabsl(tg_owt)
 link_libopenh264(tg_owt)
 link_libusrsctp(tg_owt)
 link_libvpx(tg_owt)
+link_crc32c(tg_owt)
 
 if (TG_OWT_BUILD_AUDIO_BACKENDS AND (UNIX AND NOT APPLE))
     link_libalsa(tg_owt)
@@ -2177,6 +2178,68 @@ PRIVATE
     stats/rtc_stats_report.cc
     stats/rtc_stats.cc
     stats/rtcstats_objects.cc
+
+    net/dcsctp/packet/chunk/abort_chunk.cc
+    net/dcsctp/packet/chunk/chunk.cc
+    net/dcsctp/packet/chunk/cookie_ack_chunk.cc
+    net/dcsctp/packet/chunk/cookie_echo_chunk.cc
+    net/dcsctp/packet/chunk/data_chunk.cc
+    net/dcsctp/packet/chunk/error_chunk.cc
+    net/dcsctp/packet/chunk/forward_tsn_chunk.cc
+    net/dcsctp/packet/chunk/heartbeat_ack_chunk.cc
+    net/dcsctp/packet/chunk/heartbeat_request_chunk.cc
+    net/dcsctp/packet/chunk/idata_chunk.cc
+    net/dcsctp/packet/chunk/iforward_tsn_chunk.cc
+    net/dcsctp/packet/chunk/init_ack_chunk.cc
+    net/dcsctp/packet/chunk/init_chunk.cc
+    net/dcsctp/packet/chunk/reconfig_chunk.cc
+    net/dcsctp/packet/chunk/sack_chunk.cc
+    net/dcsctp/packet/chunk/shutdown_ack_chunk.cc
+    net/dcsctp/packet/chunk/shutdown_chunk.cc
+    net/dcsctp/packet/chunk/shutdown_complete_chunk.cc
+    net/dcsctp/packet/chunk_validators.cc
+    net/dcsctp/packet/error_cause/cookie_received_while_shutting_down_cause.cc
+    net/dcsctp/packet/error_cause/error_cause.cc
+    net/dcsctp/packet/error_cause/no_user_data_cause.cc
+    net/dcsctp/packet/error_cause/out_of_resource_error_cause.cc
+    net/dcsctp/packet/error_cause/protocol_violation_cause.cc
+    net/dcsctp/packet/error_cause/unrecognized_chunk_type_cause.cc
+    net/dcsctp/packet/error_cause/user_initiated_abort_cause.cc
+    net/dcsctp/packet/parameter/forward_tsn_supported_parameter.cc
+    net/dcsctp/packet/parameter/parameter.cc
+    net/dcsctp/packet/parameter/state_cookie_parameter.cc
+    net/dcsctp/packet/parameter/supported_extensions_parameter.cc
+    net/dcsctp/packet/sctp_packet.cc
+    net/dcsctp/packet/tlv_trait.cc
+    net/dcsctp/socket/dcsctp_socket.cc
+    net/dcsctp/public/text_pcap_packet_observer.cc
+    net/dcsctp/rx/data_tracker.cc
+    net/dcsctp/rx/reassembly_queue.cc
+    net/dcsctp/socket/heartbeat_handler.cc
+    net/dcsctp/socket/state_cookie.cc
+    net/dcsctp/socket/stream_reset_handler.cc
+    net/dcsctp/socket/transmission_control_block.cc
+    net/dcsctp/timer/timer.cc
+    net/dcsctp/tx/retransmission_queue.cc
+    net/dcsctp/packet/parameter/reconfiguration_response_parameter.cc
+    net/dcsctp/packet/error_cause/unrecognized_parameter_cause.cc
+    net/dcsctp/rx/traditional_reassembly_streams.cc
+    net/dcsctp/packet/parameter/outgoing_ssn_reset_request_parameter.cc
+    net/dcsctp/packet/error_cause/restart_of_an_association_with_new_address_cause.cc
+    net/dcsctp/packet/parameter/heartbeat_info_parameter.cc
+    net/dcsctp/tx/rr_send_queue.cc
+    net/dcsctp/packet/error_cause/missing_mandatory_parameter_cause.cc
+    net/dcsctp/packet/error_cause/unresolvable_address_cause.cc
+    net/dcsctp/packet/parameter/incoming_ssn_reset_request_parameter.cc
+    net/dcsctp/timer/task_queue_timeout.cc
+    net/dcsctp/tx/retransmission_timeout.cc
+    net/dcsctp/tx/retransmission_error_counter.cc
+    net/dcsctp/packet/crc32c.cc
+    net/dcsctp/packet/error_cause/invalid_stream_identifier_cause.cc
+    net/dcsctp/packet/error_cause/stale_cookie_error_cause.cc
+    net/dcsctp/packet/error_cause/invalid_mandatory_parameter_cause.cc
+    net/dcsctp/public/dcsctp_socket_factory.cc
+
 )
 
 if (is_x86 OR is_x64)
diff --git a/cmake/external.cmake b/cmake/external.cmake
index c11df5b..70f11c7 100644
--- a/cmake/external.cmake
+++ b/cmake/external.cmake
@@ -266,3 +266,11 @@ function(link_dl target_name)
         target_link_libraries(${target_name} PRIVATE ${CMAKE_DL_LIBS})
     endif()
 endfunction()
+
+function(link_crc32c target_name)
+    if (TG_OWT_PACKAGED_BUILD)
+        find_package(Crc32c REQUIRED)
+        set(Crc32c_FOUND ${Crc32c_FOUND} PARENT_SCOPE)
+        target_link_libraries(${target_name} PRIVATE -lcrc32c)
+    endif()
+endfunction()
diff --git a/src/net/dcsctp/packet/crc32c.cc b/src/net/dcsctp/packet/crc32c.cc
index e3f0dc1..f403e2a 100644
--- a/src/net/dcsctp/packet/crc32c.cc
+++ b/src/net/dcsctp/packet/crc32c.cc
@@ -11,7 +11,7 @@
 
 #include <cstdint>
 
-#include "third_party/crc32c/src/include/crc32c/crc32c.h"
+#include <crc32c/crc32c.h>
 
 namespace dcsctp {
 
-- 
2.33.1

