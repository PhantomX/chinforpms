From 388bb51941b3332be99bd6087e92715480223392 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Tue, 13 Sep 2022 14:35:27 -0300
Subject: [PATCH] use system lzma-sdk

---
 Makefile                   |  7 ++++
 qmc2.pro                   | 72 +++++++++++++++++++++-----------------
 src/arcade/qmc2-arcade.pro | 65 ++++++++++++++++++----------------
 src/sevenzipfile.h         |  7 ++++
 4 files changed, 89 insertions(+), 62 deletions(-)

diff --git a/Makefile b/Makefile
index 714a5fd..197cdf1 100644
--- a/Makefile
+++ b/Makefile
@@ -668,6 +668,10 @@ ifeq '$(SYSTEM_MINIZIP)' '0'
 DEFINES += QMC2_BUNDLED_MINIZIP
 endif
 
+ifeq '$(SYSTEM_SEVENZIP)' '0'
+DEFINES += QMC2_BUNDLED_SEVENZIP
+endif
+
 ifeq '$(SYSTEM_ZLIB)' '0'
 DEFINES += QMC2_BUNDLED_ZLIB
 endif
@@ -938,6 +942,9 @@ endif
 ifeq '$(SYSTEM_MINIZIP)' '0'
 ARCADE_DEFINES += QMC2_ARCADE_BUNDLED_MINIZIP
 endif
+ifeq '$(SYSTEM_SEVENZIP)' '0'
+ARCADE_DEFINES += QMC2_ARCADE_BUNDLED_SEVENZIP
+endif
 ifeq '$(SYSTEM_ZLIB)' '0'
 ARCADE_DEFINES += QMC2_ARCADE_BUNDLED_ZLIB
 endif
diff --git a/qmc2.pro b/qmc2.pro
index 46c736d..e58a3dc 100644
--- a/qmc2.pro
+++ b/qmc2.pro
@@ -10,8 +10,7 @@ HEADERS += src/qftp/qftp.h \
 SOURCES += src/qftp/qftp.cpp \
 	src/qftp/qurlinfo.cpp
 INCLUDEPATH += src/ \
-	src/qftp \
-	src/lzma
+	src/qftp
 TEMPLATE = app
 FORMS += ui/qmc2main.ui \
 	ui/options.ui \
@@ -163,35 +162,7 @@ SOURCES += src/qmc2main.cpp \
 	src/setupwizard.cpp \
 	src/clickablelabel.cpp \
 	src/htmleditor/htmleditor.cpp \
-	src/htmleditor/highlighter.cpp \
-	src/lzma/7zAlloc.c \
-	src/lzma/7zBuf2.c \
-	src/lzma/7zBuf.c \
-	src/lzma/7zCrc.c \
-	src/lzma/7zCrcOpt.c \
-	src/lzma/7zDec.c \
-	src/lzma/7zFile.c \
-	src/lzma/7zArcIn.c \
-	src/lzma/7zStream.c \
-	src/lzma/Alloc.c \
-	src/lzma/Bcj2.c \
-	src/lzma/Bra86.c \
-	src/lzma/Bra.c \
-	src/lzma/BraIA64.c \
-	src/lzma/CpuArch.c \
-	src/lzma/Delta.c \
-	src/lzma/LzFind.c \
-	src/lzma/Lzma2Dec.c \
-	src/lzma/Lzma2Enc.c \
-	src/lzma/Lzma86Dec.c \
-	src/lzma/Lzma86Enc.c \
-	src/lzma/LzmaDec.c \
-	src/lzma/LzmaEnc.c \
-	src/lzma/LzmaLib.c \
-	src/lzma/Ppmd7.c \
-	src/lzma/Ppmd7Dec.c \
-	src/lzma/Ppmd7Enc.c \
-	src/lzma/Sha256.c
+	src/htmleditor/highlighter.cpp
 HEADERS += src/qmc2main.h \
 	src/options.h \
 	src/docbrowser.h \
@@ -302,7 +273,44 @@ TRANSLATIONS += data/lng/qmc2_de.ts \
 	data/lng/qmc2_us.ts
 RESOURCES += qmc2.qrc
 QMAKE_MAKEFILE = Makefile.qmake
-DEFINES += _7ZIP_PPMD_SUPPORT _7ZIP_ST
+
+	contains(DEFINES, QMC2_BUNDLED_SEVENZIP) {
+		INCLUDEPATH += src/lzma
+		SOURCES += src/lzma/7zAlloc.c \
+			src/lzma/7zAlloc.c \
+			src/lzma/7zBuf2.c \
+			src/lzma/7zBuf.c \
+			src/lzma/7zCrc.c \
+			src/lzma/7zCrcOpt.c \
+			src/lzma/7zDec.c \
+			src/lzma/7zFile.c \
+			src/lzma/7zArcIn.c \
+			src/lzma/7zStream.c \
+			src/lzma/Alloc.c \
+			src/lzma/Bcj2.c \
+			src/lzma/Bra86.c \
+			src/lzma/Bra.c \
+			src/lzma/BraIA64.c \
+			src/lzma/CpuArch.c \
+			src/lzma/Delta.c \
+			src/lzma/LzFind.c \
+			src/lzma/Lzma2Dec.c \
+			src/lzma/Lzma2Enc.c \
+			src/lzma/Lzma86Dec.c \
+			src/lzma/Lzma86Enc.c \
+			src/lzma/LzmaDec.c \
+			src/lzma/LzmaEnc.c \
+			src/lzma/LzmaLib.c \
+			src/lzma/Ppmd7.c \
+			src/lzma/Ppmd7Dec.c \
+			src/lzma/Ppmd7Enc.c \
+			src/lzma/Sha256.c
+
+		DEFINES += _7ZIP_PPMD_SUPPORT _7ZIP_ST
+	} else {
+		CONFIG += link_pkgconfig
+		PKGCONFIG += lzmasdk-c
+	}
 
 contains(DEFINES, QMC2_LIBARCHIVE_ENABLED) {
 	SOURCES += src/archivefile.cpp
diff --git a/src/arcade/qmc2-arcade.pro b/src/arcade/qmc2-arcade.pro
index 8026b05..248f7fe 100644
--- a/src/arcade/qmc2-arcade.pro
+++ b/src/arcade/qmc2-arcade.pro
@@ -28,34 +28,6 @@ SOURCES += main.cpp \
     ../settings.cpp \
     ../sevenzipfile.cpp \
     ../bigbytearray.cpp \
-    ../lzma/7zAlloc.c \
-    ../lzma/7zBuf2.c \
-    ../lzma/7zBuf.c \
-    ../lzma/7zCrc.c \
-    ../lzma/7zCrcOpt.c \
-    ../lzma/7zDec.c \
-    ../lzma/7zFile.c \
-    ../lzma/7zArcIn.c \
-    ../lzma/7zStream.c \
-    ../lzma/Alloc.c \
-    ../lzma/Bcj2.c \
-    ../lzma/Bra86.c \
-    ../lzma/Bra.c \
-    ../lzma/BraIA64.c \
-    ../lzma/CpuArch.c \
-    ../lzma/Delta.c \
-    ../lzma/LzFind.c \
-    ../lzma/Lzma2Dec.c \
-    ../lzma/Lzma2Enc.c \
-    ../lzma/Lzma86Dec.c \
-    ../lzma/Lzma86Enc.c \
-    ../lzma/LzmaDec.c \
-    ../lzma/LzmaEnc.c \
-    ../lzma/LzmaLib.c \
-    ../lzma/Ppmd7.c \
-    ../lzma/Ppmd7Dec.c \
-    ../lzma/Ppmd7Enc.c \
-    ../lzma/Sha256.c \
     ../iconcachedbmgr.cpp
 
 HEADERS += \
@@ -81,8 +53,6 @@ HEADERS += \
     ../bigbytearray.h \
     ../iconcachedbmgr.h
 
-INCLUDEPATH += ../lzma
-
 DEFINES += QMC2_ARCADE
 
 contains(DEFINES, QMC2_ARCADE_LIBARCHIVE_ENABLED) {
@@ -91,6 +61,41 @@ contains(DEFINES, QMC2_ARCADE_LIBARCHIVE_ENABLED) {
     LIBS += -larchive
 }
 
+contains(DEFINES, QMC2_ARCADE_BUNDLED_SEVENZIP) {
+    INCLUDEPATH += ../lzma
+    SOURCES +=     ../lzma/7zAlloc.c \
+      ../lzma/7zBuf2.c \
+      ../lzma/7zBuf.c \
+      ../lzma/7zCrc.c \
+      ../lzma/7zCrcOpt.c \
+      ../lzma/7zDec.c \
+      ../lzma/7zFile.c \
+      ../lzma/7zArcIn.c \
+      ../lzma/7zStream.c \
+      ../lzma/Alloc.c \
+      ../lzma/Bcj2.c \
+      ../lzma/Bra86.c \
+      ../lzma/Bra.c \
+      ../lzma/BraIA64.c \
+      ../lzma/CpuArch.c \
+      ../lzma/Delta.c \
+      ../lzma/LzFind.c \
+      ../lzma/Lzma2Dec.c \
+      ../lzma/Lzma2Enc.c \
+      ../lzma/Lzma86Dec.c \
+      ../lzma/Lzma86Enc.c \
+      ../lzma/LzmaDec.c \
+      ../lzma/LzmaEnc.c \
+      ../lzma/LzmaLib.c \
+      ../lzma/Ppmd7.c \
+      ../lzma/Ppmd7Dec.c \
+      ../lzma/Ppmd7Enc.c \
+      ../lzma/Sha256.c
+} else {
+    CONFIG += link_pkgconfig
+    PKGCONFIG += lzmasdk-c
+}
+
 contains(DEFINES, QMC2_ARCADE_BUNDLED_MINIZIP) {
 	INCLUDEPATH += ../minizip
 	SOURCES += ../minizip/mz_compat.c \
diff --git a/src/sevenzipfile.h b/src/sevenzipfile.h
index 7b33844..6c402c1 100644
--- a/src/sevenzipfile.h
+++ b/src/sevenzipfile.h
@@ -16,10 +16,17 @@
 #include "bigbytearray.h"
 
 extern "C" {
+#if defined(QMC2_BUNDLED_SEVENZIP)
 #include "lzma/7z.h"
 #include "lzma/7zAlloc.h"
 #include "lzma/7zCrc.h"
 #include "lzma/7zFile.h"
+#else
+#include "7z.h"
+#include "7zAlloc.h"
+#include "7zCrc.h"
+#include "7zFile.h"
+#endif
 }
 
 class SevenZipMetaData
-- 
2.37.3

