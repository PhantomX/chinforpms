From c202425456e83d73b5cba9a6621888d39f89bc0c Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Tue, 26 Apr 2022 11:46:46 -0300
Subject: [PATCH] Use system libraries

---
 CMakeLists.txt                            | 20 ++++++++++++++++++++
 Common/Data/Collections/Hashmaps.h        |  2 +-
 Core/Debugger/DisassemblyManager.cpp      |  2 +-
 Core/HLE/sceJpeg.cpp                      |  2 +-
 Core/MIPS/IR/IRJit.cpp                    |  2 +-
 Core/MIPS/JitCommon/JitBlockCache.cpp     |  2 +-
 Core/MIPS/MIPSAnalyst.cpp                 |  2 +-
 Core/Util/PPGeDraw.cpp                    |  2 +-
 GPU/Common/TextureDecoder.cpp             |  2 +-
 GPU/Common/TextureReplacer.cpp            |  2 +-
 GPU/D3D11/TextureCacheD3D11.cpp           |  2 +-
 GPU/Directx9/TextureCacheDX9.cpp          |  2 +-
 GPU/GLES/TextureCacheGLES.cpp             |  2 +-
 GPU/Vulkan/TextureCacheVulkan.cpp         |  2 +-
 UI/CwCheatScreen.cpp                      |  2 +-
 Windows/Debugger/CtrlDisAsmView.cpp       |  2 +-
 Windows/Debugger/CtrlMemView.cpp          |  2 +-
 ext/basis_universal/basisu_transcoder.cpp |  2 +-
 18 files changed, 37 insertions(+), 17 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 36dbf12..26d4e6e 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -163,6 +163,7 @@ option(USE_SYSTEM_FFMPEG "Dynamically link against system FFMPEG" ${USE_SYSTEM_F
 option(USE_SYSTEM_LIBZIP "Dynamically link against system libzip" ${USE_SYSTEM_LIBZIP})
 option(USE_SYSTEM_LIBSDL2 "Dynamically link against system SDL2" ON)
 option(USE_SYSTEM_LIBPNG "Dynamically link against system libpng" ON)
+option(USE_SYSTEM_XXHASH "Dynamically link against system miniupnpc" ${USE_SYSTEM_XXHASH})
 option(USE_SYSTEM_ZSTD "Dynamically link against system zstd" ${USE_SYSTEM_ZSTD})
 option(USE_SYSTEM_MINIUPNPC "Dynamically link against system miniUPnPc" ${USE_SYSTEM_MINIUPNPC})
 option(USE_ASAN "Use address sanitizer" OFF)
@@ -1427,11 +1428,30 @@ add_library(xbrz STATIC
 )
 target_include_directories(xbrz PRIVATE ext/xbrz)
 
+if(USE_SYSTEM_XXHASH)
+	find_path(XXHASH_INCLUDE_DIR xxhash.h)
+	find_library(XXHASH_LIBRARY xxhash)
+	mark_as_advanced(XXHASH_INCLUDE_DIR XXHASH_LIBRARY)
+	
+	include(FindPackageHandleStandardArgs)
+	find_package_handle_standard_args(XXHASH DEFAULT_MSG
+	  XXHASH_INCLUDE_DIR XXHASH_LIBRARY)
+	
+	if(XXHASH_FOUND AND NOT TARGET XXHASH)
+	  message(STATUS "Using shared xxhash")
+	  add_library(xxhash UNKNOWN IMPORTED)
+	  set_target_properties(xxhash PROPERTIES
+	    IMPORTED_LOCATION "${XXHASH_LIBRARY}"
+	    INTERFACE_INCLUDE_DIRECTORIES "${XXHASH_INCLUDE_DIR}"
+	  )
+	endif()
+else()
 add_library(xxhash STATIC
 	ext/xxhash.c
 	ext/xxhash.h
 )
 target_include_directories(xxhash PRIVATE ext/xxhash)
+endif()
 
 set(CoreExtra)
 set(CoreExtraLibs)
diff --git a/Common/Data/Collections/Hashmaps.h b/Common/Data/Collections/Hashmaps.h
index ac6b06c..147d05b 100644
--- a/Common/Data/Collections/Hashmaps.h
+++ b/Common/Data/Collections/Hashmaps.h
@@ -4,7 +4,7 @@
 #include <cstring>
 #include <vector>
 
-#include "ext/xxhash.h"
+#include "xxhash.h"
 #include "Common/CommonFuncs.h"
 #include "Common/Log.h"
 
diff --git a/Core/Debugger/DisassemblyManager.cpp b/Core/Debugger/DisassemblyManager.cpp
index 667ba13..b61f8b6 100644
--- a/Core/Debugger/DisassemblyManager.cpp
+++ b/Core/Debugger/DisassemblyManager.cpp
@@ -20,7 +20,7 @@
 #include <algorithm>
 #include <map>
 
-#include "ext/xxhash.h"
+#include "xxhash.h"
 
 #include "Common/CommonTypes.h"
 #include "Common/Data/Encoding/Utf8.h"
diff --git a/Core/HLE/sceJpeg.cpp b/Core/HLE/sceJpeg.cpp
index 8b2e427..113f4be 100644
--- a/Core/HLE/sceJpeg.cpp
+++ b/Core/HLE/sceJpeg.cpp
@@ -33,7 +33,7 @@
 // Uncomment if you want to dump JPEGs loaded through sceJpeg to a file
 // #define JPEG_DEBUG
 #ifdef JPEG_DEBUG
-#include "ext/xxhash.h"
+#include "xxhash.h"
 #include "Common/File/FileUtil.h"
 #include "Common/StringUtils.h"
 #endif
diff --git a/Core/MIPS/IR/IRJit.cpp b/Core/MIPS/IR/IRJit.cpp
index 66608fc..43cc7a4 100644
--- a/Core/MIPS/IR/IRJit.cpp
+++ b/Core/MIPS/IR/IRJit.cpp
@@ -17,7 +17,7 @@
 
 #include <set>
 
-#include "ext/xxhash.h"
+#include "xxhash.h"
 #include "Common/Profiler/Profiler.h"
 
 #include "Common/Log.h"
diff --git a/Core/MIPS/JitCommon/JitBlockCache.cpp b/Core/MIPS/JitCommon/JitBlockCache.cpp
index d1498e4..4c6d6a8 100644
--- a/Core/MIPS/JitCommon/JitBlockCache.cpp
+++ b/Core/MIPS/JitCommon/JitBlockCache.cpp
@@ -19,7 +19,7 @@
 #include <cstddef>
 #include <algorithm>
 
-#include "ext/xxhash.h"
+#include "xxhash.h"
 #include "Common/CommonTypes.h"
 #include "Common/Profiler/Profiler.h"
 
diff --git a/Core/MIPS/MIPSAnalyst.cpp b/Core/MIPS/MIPSAnalyst.cpp
index f4fb504..04703ae 100644
--- a/Core/MIPS/MIPSAnalyst.cpp
+++ b/Core/MIPS/MIPSAnalyst.cpp
@@ -23,7 +23,7 @@
 #include <mutex>
 
 #include "ext/cityhash/city.h"
-#include "ext/xxhash.h"
+#include "xxhash.h"
 
 #include "Common/File/FileUtil.h"
 #include "Common/Log.h"
diff --git a/Core/Util/PPGeDraw.cpp b/Core/Util/PPGeDraw.cpp
index 12dc1e8..c31f5ea 100644
--- a/Core/Util/PPGeDraw.cpp
+++ b/Core/Util/PPGeDraw.cpp
@@ -17,7 +17,7 @@
 
 #include <algorithm>
 
-#include "ext/xxhash.h"
+#include "xxhash.h"
 #include "Common/Data/Color/RGBAUtil.h"
 #include "Common/File/VFS/VFS.h"
 #include "Common/Data/Format/ZIMLoad.h"
diff --git a/GPU/Common/TextureDecoder.cpp b/GPU/Common/TextureDecoder.cpp
index a12be66..b70a9fb 100644
--- a/GPU/Common/TextureDecoder.cpp
+++ b/GPU/Common/TextureDecoder.cpp
@@ -17,7 +17,7 @@
 
 #include "ppsspp_config.h"
 
-#include "ext/xxhash.h"
+#include "xxhash.h"
 
 #include "Common/Common.h"
 #include "Common/Data/Convert/ColorConv.h"
diff --git a/GPU/Common/TextureReplacer.cpp b/GPU/Common/TextureReplacer.cpp
index 57ab5b7..419b6bd 100644
--- a/GPU/Common/TextureReplacer.cpp
+++ b/GPU/Common/TextureReplacer.cpp
@@ -23,7 +23,7 @@
 #include <png.h>
 
 #include "ext/basis_universal/basisu_transcoder.h"
-#include "ext/xxhash.h"
+#include "xxhash.h"
 
 #include "Common/Data/Convert/ColorConv.h"
 #include "Common/Data/Format/IniFile.h"
diff --git a/GPU/D3D11/TextureCacheD3D11.cpp b/GPU/D3D11/TextureCacheD3D11.cpp
index ffdf94c..df1de2b 100644
--- a/GPU/D3D11/TextureCacheD3D11.cpp
+++ b/GPU/D3D11/TextureCacheD3D11.cpp
@@ -37,7 +37,7 @@
 #include "Core/Config.h"
 #include "Core/Host.h"
 
-#include "ext/xxhash.h"
+#include "xxhash.h"
 #include "Common/Math/math_util.h"
 
 // For depth depal
diff --git a/GPU/Directx9/TextureCacheDX9.cpp b/GPU/Directx9/TextureCacheDX9.cpp
index 55433f5..09f833e 100644
--- a/GPU/Directx9/TextureCacheDX9.cpp
+++ b/GPU/Directx9/TextureCacheDX9.cpp
@@ -33,7 +33,7 @@
 #include "Core/Config.h"
 #include "Core/Host.h"
 
-#include "ext/xxhash.h"
+#include "xxhash.h"
 #include "Common/Math/math_util.h"
 
 // NOTE: In the D3D backends, we flip R and B in the shaders, so while these look wrong, they're OK.
diff --git a/GPU/GLES/TextureCacheGLES.cpp b/GPU/GLES/TextureCacheGLES.cpp
index b5d8fdd..973e7e7 100644
--- a/GPU/GLES/TextureCacheGLES.cpp
+++ b/GPU/GLES/TextureCacheGLES.cpp
@@ -18,7 +18,7 @@
 #include <algorithm>
 #include <cstring>
 
-#include "ext/xxhash.h"
+#include "xxhash.h"
 #include "Common/Common.h"
 #include "Common/Data/Convert/ColorConv.h"
 #include "Common/Data/Text/I18n.h"
diff --git a/GPU/Vulkan/TextureCacheVulkan.cpp b/GPU/Vulkan/TextureCacheVulkan.cpp
index 7f60c27..5fba16d 100644
--- a/GPU/Vulkan/TextureCacheVulkan.cpp
+++ b/GPU/Vulkan/TextureCacheVulkan.cpp
@@ -18,7 +18,7 @@
 #include <algorithm>
 #include <cstring>
 
-#include "ext/xxhash.h"
+#include "xxhash.h"
 #include "Common/File/VFS/VFS.h"
 #include "Common/Data/Text/I18n.h"
 #include "Common/LogReporting.h"
diff --git a/UI/CwCheatScreen.cpp b/UI/CwCheatScreen.cpp
index cd6f052..7820b8d 100644
--- a/UI/CwCheatScreen.cpp
+++ b/UI/CwCheatScreen.cpp
@@ -16,7 +16,7 @@
 // https://github.com/hrydgard/ppsspp and http://www.ppsspp.org/.
 
 #include "ppsspp_config.h"
-#include "ext/xxhash.h"
+#include "xxhash.h"
 #include "Common/UI/UI.h"
 
 #include "Common/Data/Text/I18n.h"
diff --git a/Windows/Debugger/CtrlDisAsmView.cpp b/Windows/Debugger/CtrlDisAsmView.cpp
index 7b46ae2..ad6ba94 100644
--- a/Windows/Debugger/CtrlDisAsmView.cpp
+++ b/Windows/Debugger/CtrlDisAsmView.cpp
@@ -23,7 +23,7 @@
 
 #include "Common/CommonWindows.h"
 #include "Common/Data/Encoding/Utf8.h"
-#include "ext/xxhash.h"
+#include "xxhash.h"
 #include "Common/System/Display.h"
 
 #include <CommDlg.h>
diff --git a/Windows/Debugger/CtrlMemView.cpp b/Windows/Debugger/CtrlMemView.cpp
index f4eb61d..0b0c67a 100644
--- a/Windows/Debugger/CtrlMemView.cpp
+++ b/Windows/Debugger/CtrlMemView.cpp
@@ -4,7 +4,7 @@
 #include <tchar.h>
 #include <math.h>
 #include <iomanip>
-#include "ext/xxhash.h"
+#include "xxhash.h"
 #include "Core/Config.h"
 #include "Core/MemMap.h"
 #include "Core/Reporting.h"
diff --git a/ext/basis_universal/basisu_transcoder.cpp b/ext/basis_universal/basisu_transcoder.cpp
index b5bef83..ac49b5d 100644
--- a/ext/basis_universal/basisu_transcoder.cpp
+++ b/ext/basis_universal/basisu_transcoder.cpp
@@ -155,7 +155,7 @@
    // If BASISD_SUPPORT_KTX2_ZSTD is 0, UASTC files compressed with Zstd cannot be loaded.
 	#if BASISD_SUPPORT_KTX2_ZSTD
 		// We only use two Zstd API's: ZSTD_decompress() and ZSTD_isError()
-		#include "../zstd/lib/zstd.h"
+		#include "zstd.h"
 	#endif
 #endif
 
-- 
2.39.2

