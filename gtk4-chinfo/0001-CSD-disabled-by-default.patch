From 0f7fd4996c8ea8e6f6eaf78e72511b19cad8b724 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Mon, 18 Apr 2022 09:55:30 -0300
Subject: [PATCH] CSD: disabled by default

---
 gtk/gtkwindow.c         | 8 ++++++++
 gtk/gtkwindowcontrols.c | 4 +++-
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/gtk/gtkwindow.c b/gtk/gtkwindow.c
index 901b370..eed3306 100644
--- a/gtk/gtkwindow.c
+++ b/gtk/gtkwindow.c
@@ -3161,6 +3161,14 @@ gtk_window_enable_csd (GtkWindow *window)
     }
 
   priv->client_decorated = TRUE;
+#ifdef GDK_WINDOWING_X11
+  if (GDK_IS_X11_DISPLAY (gtk_widget_get_display (widget)) && g_getenv("GTK_CSD") == FALSE)
+    {
+      //gtk_style_context_remove_class (gtk_widget_get_style_context (widget), GTK_STYLE_CLASS_CSD);
+      gtk_widget_remove_css_class (widget, "solid-csd");
+      priv->client_decorated = FALSE;
+    }
+#endif
 }
 
 /**
diff --git a/gtk/gtkwindowcontrols.c b/gtk/gtkwindowcontrols.c
index 1f01eb9..e5bfb28 100644
--- a/gtk/gtkwindowcontrols.c
+++ b/gtk/gtkwindowcontrols.c
@@ -131,7 +131,9 @@ get_layout (GtkWindowControls *self)
   if (!root || !GTK_IS_WINDOW (root))
     return NULL;
 
-  if (self->decoration_layout)
+  if (g_strcmp0 (g_getenv ("GTK_CSD"), "1") != 0)
+    layout_desc = NULL;
+  else if (self->decoration_layout)
     layout_desc = g_strdup (self->decoration_layout);
   else
     g_object_get (gtk_widget_get_settings (widget),
-- 
2.52.0

