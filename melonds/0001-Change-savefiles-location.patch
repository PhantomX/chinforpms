From af85c1dc5bb256f09c7e0d235a49c6ac888b8111 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Tue, 23 Nov 2021 21:47:07 -0300
Subject: [PATCH] Change savefiles location

Ugly dirty fix to save to configdir/sav|mch directory instead rom file location
---
 src/frontend/Util_ROM.cpp        | 34 +++++++++++++++++++++++++++++---
 src/frontend/qt_sdl/Platform.cpp |  4 ++++
 src/frontend/qt_sdl/main.cpp     |  9 +++++++--
 3 files changed, 42 insertions(+), 5 deletions(-)

diff --git a/src/frontend/Util_ROM.cpp b/src/frontend/Util_ROM.cpp
index 4d23c70..06e534e 100644
--- a/src/frontend/Util_ROM.cpp
+++ b/src/frontend/Util_ROM.cpp
@@ -21,6 +21,10 @@
 
 #include <utility>
 
+#include <unistd.h>
+#include <sys/types.h>
+#include <pwd.h>
+
 #ifdef ARCHIVE_SUPPORT_ENABLED
 #include "ArchiveUtil.h"
 #endif
@@ -226,8 +230,29 @@ int SetupDSiNAND()
     return Load_OK;
 }
 
+// https://thispointer.com/c-how-to-get-filename-from-a-path-with-or-without-extension-boost-c17-filesytem-library/
+std::string getFileName(std::string filePath, char separator = '/')
+{
+    // Get last dot position
+    std::size_t dotPos = filePath.rfind('.');
+    std::size_t sepPos = filePath.rfind(separator);
+
+    if(sepPos != std::string::npos)
+    {
+        return filePath.substr(sepPos + 1, filePath.size());
+    }
+    return "";
+}
+
 void LoadCheats()
 {
+    std::string homedir = getenv("HOME");
+    if (homedir.empty())
+    {
+         std::string homedir = getpwuid(getuid())->pw_dir;
+    }
+    std::string mchpath = homedir + "/.config/melonDS/mch/";
+
     if (CheatFile)
     {
         delete CheatFile;
@@ -237,13 +262,16 @@ void LoadCheats()
     char filename[1024];
     if (ROMPath[ROMSlot_NDS][0] != '\0')
     {
-        strncpy(filename, ROMPath[ROMSlot_NDS], 1023);
+        std::string fullname = mchpath + getFileName(ROMPath[ROMSlot_NDS]);
+        strncpy(filename, fullname.c_str(), 1023);
         filename[1023] = '\0';
-        strncpy(filename + strlen(ROMPath[ROMSlot_NDS]) - 3, "mch", 3);
+        strncpy(filename + strlen(fullname.c_str()) - 3, "mch", 3);
     }
     else
     {
-        strncpy(filename, "firmware.mch", 1023);
+        std::string fullname = mchpath + "firmware.mch";
+        filename[1023] = '\0';
+        strncpy(filename, fullname.c_str(), 1023);
     }
 
     // TODO: check for error (malformed cheat file, ...)
diff --git a/src/frontend/qt_sdl/Platform.cpp b/src/frontend/qt_sdl/Platform.cpp
index 812c953..90406e1 100644
--- a/src/frontend/qt_sdl/Platform.cpp
+++ b/src/frontend/qt_sdl/Platform.cpp
@@ -106,6 +106,8 @@ void Init(int argc, char** argv)
     QString confdir;
     QDir config(QStandardPaths::writableLocation(QStandardPaths::ConfigLocation));
     config.mkdir("melonDS");
+    config.mkdir("melonDS/mch");
+    config.mkdir("melonDS/sav");
     confdir = config.absolutePath() + "/melonDS/";
     EmuDirectory = confdir.toStdString();
 #endif
@@ -292,6 +294,8 @@ FILE* OpenLocalFile(std::string path, std::string mode)
         // Check user configuration directory
         QDir config(QStandardPaths::writableLocation(QStandardPaths::GenericConfigLocation));
         config.mkdir("melonDS");
+        config.mkdir("melonDS/mch");
+        config.mkdir("melonDS/sav");
         fullpath = config.absolutePath() + "/melonDS/";
         fullpath.append(qpath);
 #endif
diff --git a/src/frontend/qt_sdl/main.cpp b/src/frontend/qt_sdl/main.cpp
index 64a0a90..945eede 100644
--- a/src/frontend/qt_sdl/main.cpp
+++ b/src/frontend/qt_sdl/main.cpp
@@ -41,6 +41,8 @@
 #include <sys/socket.h>
 #include <signal.h>
 #endif
+#include <QStandardPaths>
+#include <QDir>
 
 #include <SDL2/SDL.h>
 
@@ -1788,7 +1790,8 @@ void MainWindow::dropEvent(QDropEvent* event)
         else
         {
             slot = (romFileName.endsWith(".gba", Qt::CaseInsensitive) ? 1 : 0);
-            QString sramFileName = QFileInfo(_filename).absolutePath() + QDir::separator() + QFileInfo(romFileName).completeBaseName() + ".sav";
+            QDir config(QStandardPaths::writableLocation(QStandardPaths::GenericConfigLocation));
+            QString sramFileName = config.absolutePath() + "/melonDS/sav/" + QFileInfo(romFileName).completeBaseName() + ".sav";
 
             if(slot == 0)
                 strncpy(Frontend::NDSROMExtension, QFileInfo(romFileName).suffix().toStdString().c_str(), 4);
@@ -1880,10 +1883,12 @@ void MainWindow::loadROM(QByteArray *romData, QString archiveFileName, QString r
     recentFileList.prepend(archiveFileName);
     updateRecentFilesMenu();
 
+    QDir config(QStandardPaths::writableLocation(QStandardPaths::GenericConfigLocation));
+
     // Strip entire archive name and get folder path
     strncpy(Config::LastROMFolder, QFileInfo(archiveFileName).absolutePath().toStdString().c_str(), 1024);
 
-    QString sramFileName = QFileInfo(archiveFileName).absolutePath() + QDir::separator() + QFileInfo(romFileName).completeBaseName() + ".sav";
+    QString sramFileName = config.absolutePath() + "/melonDS/sav/" + QFileInfo(romFileName).completeBaseName() + ".sav";
 
     int slot; int res;
     if (romFileName.endsWith("gba"))
-- 
2.33.1

