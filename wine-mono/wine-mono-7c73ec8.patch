From 7c73ec861d4e50afa2b9c1ac1f4edc57bd80eee3 Mon Sep 17 00:00:00 2001
From: Vincent Povirk <vincent@codeweavers.com>
Date: Wed, 25 Sep 2019 14:43:36 -0500
Subject: [PATCH] Add a program to install the dotnetfakedlls inf file.

Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=47807
---
 Makefile                            | 11 +++++++++++
 msi-tables/support/customaction.idt |  4 ++--
 tools/installinf/installinf.c       | 23 +++++++++++++++++++++++
 3 files changed, 36 insertions(+), 2 deletions(-)
 create mode 100644 tools/installinf/installinf.c

diff --git a/Makefile b/Makefile
index 1765a99..ea1dbbb 100644
--- a/Makefile
+++ b/Makefile
@@ -158,6 +158,17 @@ tests-runtime-$(1): $$(BUILDDIR)/mono-unix/mono/mini/.built-tests $$(BUILDDIR)/m
 	cp $$(BUILDDIR)/mono-unix/mono/tests/*.exe $$(BUILDDIR)/mono-unix/mono/tests/*.dll $$(OUTDIR)/tests-$(1)
 tests: tests-runtime-$(1)
 
+# instlalinf.exe
+$$(BUILDDIR)/installinf-$(1).exe: $$(SRCDIR)/tools/installinf/installinf.c
+	$$(MINGW_$(1))-gcc $$< -lsetupapi -municode -o $$@
+
+support-installinf-$(1): $$(BUILDDIR)/installinf-$(1).exe
+	mkdir -p $(IMAGEDIR)/support/
+	cp $$(BUILDDIR)/installinf-$(1).exe $(IMAGEDIR)/support/
+.PHONY: support-installinf-$(1)
+imagedir-targets: support-installinf-$(1)
+IMAGEDIR_BUILD_TARGETS += $$(BUILDDIR)/installinf-$(1).exe
+
 # FNA native deps
 # SDL2
 # note: we explicitly disable vsscanf as msvcrt doesn't support it and mingw-w64's wrapper is buggy
diff --git a/msi-tables/support/customaction.idt b/msi-tables/support/customaction.idt
index 4ace02d..b462757 100644
--- a/msi-tables/support/customaction.idt
+++ b/msi-tables/support/customaction.idt
@@ -1,5 +1,5 @@
 Action	Type	Source	Target	ExtendedType
 s72	i2	S72	L0	I4
 CustomAction	Action
-INSTALLFAKEDLLS	1058	WindowsFolder	[SystemFolder]\rundll32.exe setupapi.dll,InstallHinfSection DefaultInstall 128 [SourceDir]\dotnetfakedlls.inf	
-INSTALLFAKEDLLS64	1058	WindowsFolder	[WindowsFolder]\SysNative\rundll32.exe setupapi.dll,InstallHinfSection DefaultInstall 128 [SourceDir]\dotnetfakedlls.inf	
+INSTALLFAKEDLLS	1058	WindowsFolder	[SourceDir]\installinf-x86.exe [SourceDir]\dotnetfakedlls.inf	
+INSTALLFAKEDLLS64	1058	WindowsFolder	[SourceDir]\installinf-x86_64.exe [SourceDir]\dotnetfakedlls.inf	
diff --git a/tools/installinf/installinf.c b/tools/installinf/installinf.c
new file mode 100644
index 0000000..9f5deab
--- /dev/null
+++ b/tools/installinf/installinf.c
@@ -0,0 +1,23 @@
+/* installinf - Use setupapi to install a .inf file.
+ *
+ * We cannot use rundll32 for this because Wine Mono may be installed before it is created. */
+
+#include <stdlib.h>
+#include <wchar.h>
+#include <windows.h>
+#include <setupapi.h>
+
+int wmain(int argc, wchar_t **argv)
+{
+	wchar_t* buf;
+	const wchar_t* prefix = L"DefaultInstall 128 ";
+
+	buf = malloc(sizeof(wchar_t) * (wcslen(prefix) + wcslen(argv[1]) + 1));
+
+	wcscpy(buf, prefix);
+	wcscat(buf, argv[1]);
+
+	InstallHinfSectionW(NULL, NULL, buf, 0);
+
+	return 0;
+}
