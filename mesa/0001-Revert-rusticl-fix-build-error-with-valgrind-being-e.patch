From 96133783bb97e4fcb035eeed1c87d008981c2e2c Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Thu, 2 Feb 2023 10:28:23 -0300
Subject: [PATCH] Revert "rusticl: fix build error with valgrind being enabled"

This reverts commit 49d677d326660fd056d02e9b1e13869c73e36ddb.
---
 .gitlab-ci/container/debian/x86_build-base.sh | 4 ++--
 .gitlab-ci/image-tags.yml                     | 2 +-
 .pick_status.json                             | 2 +-
 docs/rusticl.rst                              | 2 +-
 meson.build                                   | 4 ++--
 src/gallium/frontends/rusticl/meson.build     | 4 ----
 6 files changed, 7 insertions(+), 11 deletions(-)

diff --git a/.gitlab-ci/container/debian/x86_build-base.sh b/.gitlab-ci/container/debian/x86_build-base.sh
index f3c05cb9563..67792383a83 100644
--- a/.gitlab-ci/container/debian/x86_build-base.sh
+++ b/.gitlab-ci/container/debian/x86_build-base.sh
@@ -78,8 +78,8 @@ apt-get install -y --no-remove \
 # Needed for ci-fairy, this revision is able to upload files to MinIO
 pip3 install git+http://gitlab.freedesktop.org/freedesktop/ci-templates@ffe4d1b10aab7534489f0c4bbc4c5899df17d3f2
 
-# We need at least 1.0.0 for proper Rust; 0.62 for modern meson env2mfile
-pip3 install meson==1.0.0
+# We need at least 0.61.4 for proper Rust; 0.62 for modern meson env2mfile
+pip3 install meson==0.63.3
 
 . .gitlab-ci/container/build-rust.sh
 
diff --git a/.gitlab-ci/image-tags.yml b/.gitlab-ci/image-tags.yml
index 9f4bb4c2ebd..2cbf738a1c5 100644
--- a/.gitlab-ci/image-tags.yml
+++ b/.gitlab-ci/image-tags.yml
@@ -1,6 +1,6 @@
 variables:
    DEBIAN_X86_BUILD_BASE_IMAGE: "debian/x86_build-base"
-   DEBIAN_BASE_TAG: "2023-01-31-rust-valgrind-23-stable"
+   DEBIAN_BASE_TAG: "2023-01-10-robust-wget"
 
    DEBIAN_X86_BUILD_IMAGE_PATH: "debian/x86_build"
    DEBIAN_BUILD_TAG: "2023-01-09-lavacli"
diff --git a/.pick_status.json b/.pick_status.json
index 6adf34f7538..390e932b712 100644
--- a/.pick_status.json
+++ b/.pick_status.json
@@ -958,7 +958,7 @@
         "description": "rusticl: fix build error with valgrind being enabled",
         "nominated": true,
         "nomination_type": 1,
-        "resolution": 1,
+        "resolution": 0,
         "main_sha": null,
         "because_sha": "20c90fed5a0ab0202ee1ef474c71cb816164a448"
     },
diff --git a/docs/rusticl.rst b/docs/rusticl.rst
index 9217fc766af..45f99bcca3c 100644
--- a/docs/rusticl.rst
+++ b/docs/rusticl.rst
@@ -19,7 +19,7 @@ To build Rusticl you need to satisfy the following build dependencies:
 The minimum versions to build Rusticl are:
 
 -  Rust: 1.59
--  Meson: 1.0.0
+-  Meson: 0.61.4
 -  Bindgen: 0.58.0
 -  LLVM: 11.0.0 (recommended: 15.0.0)
 -  SPIRV-Tools: any version (recommended: v2022.3)
diff --git a/meson.build b/meson.build
index 9a46caa0b00..beb5c6f0c23 100644
--- a/meson.build
+++ b/meson.build
@@ -957,8 +957,8 @@ if with_gallium_rusticl
     error('rusticl requires at least one gallium driver.')
   endif
 
-  if meson.version().version_compare('< 1.0.0')
-    error('rusticl requires meson 1.0.0 or newer')
+  if meson.version().version_compare('< 0.61.4')
+    error('rusticl requires meson 0.61.4 or newer')
   endif
 
   add_languages('rust', required: true)
diff --git a/src/gallium/frontends/rusticl/meson.build b/src/gallium/frontends/rusticl/meson.build
index e53b50a9b8b..5bfa6faf5af 100644
--- a/src/gallium/frontends/rusticl/meson.build
+++ b/src/gallium/frontends/rusticl/meson.build
@@ -195,7 +195,6 @@ rusticl_mesa_bindings_inline_wrapper = static_library(
   ],
   dependencies: [
     idep_nir_headers,
-    dep_valgrind,
   ],
 )
 
@@ -210,9 +209,6 @@ rusticl_mesa_bindings_rs = rust.bindgen(
     inc_nir,
     inc_src,
   ],
-  dependencies: [
-    dep_valgrind,
-  ],
   c_args : [
     rusticl_bindgen_c_args,
     pre_args,
-- 
2.39.1

