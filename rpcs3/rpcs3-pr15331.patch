From e4faf23653ab60cacbbdefc022a6fe68a575903b Mon Sep 17 00:00:00 2001
From: oltolm <oleg.tolmatcev@gmail.com>
Date: Sun, 10 Mar 2024 12:56:16 +0100
Subject: [PATCH 1/6] llvm: update to 18

---
 3rdparty/llvm/CMakeLists.txt | 19 +++++--------------
 Utilities/JITLLVM.cpp        |  5 +++++
 rpcs3/util/types.hpp         |  2 +-
 3 files changed, 11 insertions(+), 15 deletions(-)

diff --git a/3rdparty/llvm/CMakeLists.txt b/3rdparty/llvm/CMakeLists.txt
index fdadd8c5d3f0..28dbf06b0729 100644
--- a/3rdparty/llvm/CMakeLists.txt
+++ b/3rdparty/llvm/CMakeLists.txt
@@ -36,12 +36,7 @@ if(WITH_LLVM)
 
 		set(STATIC_LINK_LLVM ON CACHE BOOL "Link against LLVM statically. This will get set to ON if you build LLVM from the submodule." FORCE)
 
-		# now tries to find LLVM again
 		find_package(LLVM 16.0 CONFIG)
-		if(NOT LLVM_FOUND)
-			set(LLVM_DIR "${CMAKE_CURRENT_BINARY_DIR}/llvm_build/lib/cmake/llvm/")
-			find_package(LLVM 17.0 CONFIG)
-		endif()
 		if(NOT LLVM_FOUND)
 			message(FATAL_ERROR "Couldn't build LLVM from the submodule. You might need to run `git submodule update --init`")
 		endif()
@@ -53,20 +48,16 @@ if(WITH_LLVM)
 			set(LLVM_DIR ${CMAKE_SOURCE_DIR}/${LLVM_DIR})
 		endif()
 
-		find_package(LLVM 16.0 CONFIG)
-		if(NOT LLVM_FOUND)
-			find_package(LLVM 17.0 CONFIG)
-		endif()
+		find_package(LLVM CONFIG)
 
 		if (NOT LLVM_FOUND)
-			if (LLVM_VERSION AND LLVM_VERSION_MAJOR LESS 16)
-				message(FATAL_ERROR "Found LLVM version ${LLVM_VERSION}. Required versions 16...17. \
-														 Enable BUILD_LLVM option to build LLVM from included as a git submodule.")
-			endif()
-
 			message(FATAL_ERROR "Can't find LLVM libraries from the CMAKE_PREFIX_PATH path or LLVM_DIR. \
 													 Enable BUILD_LLVM option to build LLVM from included as a git submodule.")
 		endif()
+		if (LLVM_VERSION VERSION_LESS 16)
+			message(FATAL_ERROR "Found LLVM version ${LLVM_VERSION}. Required version 16 or above. \
+													 Enable BUILD_LLVM option to build LLVM from included as a git submodule.")
+		endif()
 	endif()
 
 	if (STATIC_LINK_LLVM)
diff --git a/Utilities/JITLLVM.cpp b/Utilities/JITLLVM.cpp
index a14cf25a6749..e514f5c62c11 100644
--- a/Utilities/JITLLVM.cpp
+++ b/Utilities/JITLLVM.cpp
@@ -30,6 +30,7 @@ LOG_CHANNEL(jit_log, "JIT");
 #pragma GCC diagnostic ignored "-Weffc++"
 #pragma GCC diagnostic ignored "-Wmissing-noreturn"
 #endif
+#include <llvm/Support/CodeGen.h>
 #include "llvm/Support/TargetSelect.h"
 #include "llvm/TargetParser/Host.h"
 #include "llvm/ExecutionEngine/ExecutionEngine.h"
@@ -542,7 +543,11 @@ jit_compiler::jit_compiler(const std::unordered_map<std::string, u64>& _link, co
 			.setErrorStr(&result)
 			.setEngineKind(llvm::EngineKind::JIT)
 			.setMCJITMemoryManager(std::move(mem))
+#if LLVM_VERSION_MAJOR < 18
 			.setOptLevel(llvm::CodeGenOpt::Aggressive)
+#else
+			.setOptLevel(llvm::CodeGenOptLevel::Aggressive)
+#endif
 			.setCodeModel(flags & 0x2 ? llvm::CodeModel::Large : llvm::CodeModel::Small)
 #ifdef __APPLE__
 			//.setCodeModel(llvm::CodeModel::Large)
From 17e5b74dff7cdcfdad4894bb71629a3ab9a82a82 Mon Sep 17 00:00:00 2001
From: oltolm <oleg.tolmatcev@gmail.com>
Date: Mon, 18 Mar 2024 17:33:20 +0100
Subject: [PATCH 3/6] fix GCC warnings

---
 rpcs3/Emu/CPU/CPUTranslator.cpp | 2 +-
 rpcs3/Emu/Cell/SPUThread.cpp    | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/rpcs3/Emu/CPU/CPUTranslator.cpp b/rpcs3/Emu/CPU/CPUTranslator.cpp
index 96afeb53ac26..fa7f15ff9a57 100644
--- a/rpcs3/Emu/CPU/CPUTranslator.cpp
+++ b/rpcs3/Emu/CPU/CPUTranslator.cpp
@@ -171,7 +171,7 @@ void cpu_translator::initialize(llvm::LLVMContext& context, llvm::ExecutionEngin
 		cpu == "tigerlake" ||
 		cpu == "rocketlake" ||
 		cpu == "sapphirerapids" ||
-		(cpu.startswith("znver") && cpu != "znver1" && cpu != "znver2" && cpu != "znver3"))
+		(cpu.starts_with("znver") && cpu != "znver1" && cpu != "znver2" && cpu != "znver3"))
 	{
 		m_use_avx = true;
 		m_use_fma = true;
From 6750589069c9cd73387c8d2634a1c4de589450a1 Mon Sep 17 00:00:00 2001
From: oltolm <oleg.tolmatcev@gmail.com>
Date: Tue, 23 Jan 2024 00:19:16 +0100
Subject: [PATCH 5/6] fix compiler warnings

---
 rpcs3/Emu/NP/rpcn_client.cpp         | 4 ++--
 rpcs3/Emu/RSX/Program/GLSLCommon.cpp | 2 +-
 rpcs3/rpcs3qt/qt_camera_video_sink.h | 2 ++
 3 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/rpcs3/Emu/RSX/Program/GLSLCommon.cpp b/rpcs3/Emu/RSX/Program/GLSLCommon.cpp
index e0ce1481a019..97bc6fd7b5dd 100644
--- a/rpcs3/Emu/RSX/Program/GLSLCommon.cpp
+++ b/rpcs3/Emu/RSX/Program/GLSLCommon.cpp
@@ -161,7 +161,7 @@ namespace glsl
 	void insert_rop(std::ostream& OS, const shader_properties& /*props*/)
 	{
 		OS <<
-			#include "GLSLSnippets//RSXProg/RSXROPEpilogue.glsl"
+			#include "GLSLSnippets/RSXProg/RSXROPEpilogue.glsl"
 			;
 	}
 
diff --git a/rpcs3/rpcs3qt/qt_camera_video_sink.h b/rpcs3/rpcs3qt/qt_camera_video_sink.h
index 20f8dda46086..94946c177d05 100644
--- a/rpcs3/rpcs3qt/qt_camera_video_sink.h
+++ b/rpcs3/rpcs3qt/qt_camera_video_sink.h
@@ -1,5 +1,7 @@
 #pragma once
 
+#include "util/atomic.hpp"
+#include "util/types.hpp"
 #include <QVideoFrame>
 #include <QVideoSink>
 #include <QImage>

From f6348851542d33542e69ae635f752001bd2d9798 Mon Sep 17 00:00:00 2001
From: oltolm <oleg.tolmatcev@gmail.com>
Date: Wed, 20 Mar 2024 17:34:38 +0100
Subject: [PATCH 6/6] workaround Clang 18.1 crash

---
 rpcs3/util/types.hpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/rpcs3/util/types.hpp b/rpcs3/util/types.hpp
index 6e69657c768a..47eb08147f4d 100644
--- a/rpcs3/util/types.hpp
+++ b/rpcs3/util/types.hpp
@@ -1057,7 +1057,7 @@ template <typename CT> requires requires (const CT& x) { std::size(x); }
 	}
 	else
 	{
-		return narrow<u32>(std::size(container), line, col, file, func);
+		return narrow<u32>(container.size(), line, col, file, func);
 	}
 }
 
