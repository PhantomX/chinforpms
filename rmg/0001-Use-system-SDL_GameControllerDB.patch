From 0a3c04a57fc4856be39ea209f0a4fa1d388fcdcd Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Thu, 9 Feb 2023 22:56:03 -0300
Subject: [PATCH] Use system SDL_GameControllerDB

---
 CMakeLists.txt                 | 6 +++++-
 Source/3rdParty/CMakeLists.txt | 4 ++++
 Source/RMG-Input/main.cpp      | 3 +--
 3 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index bac2301..7a197d6 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -156,9 +156,13 @@ if (VRU)
         DESTINATION ${DATA_INSTALL_PATH}
     )
 endif(VRU)
-install(FILES ${SDL_GAMECONTROLLERDB} ${CMAKE_SOURCE_DIR}/Data/InputProfileDB.json
+if (BUNDLE_SDL_GAMECONTROLLERDB)
+install(FILES ${SDL_GAMECONTROLLERDB}
     DESTINATION ${DATA_INSTALL_PATH}
 )
+endif()
+install(FILES ${CMAKE_SOURCE_DIR}/Data/InputProfileDB.json
+    DESTINATION ${DATA_INSTALL_PATH} )
 file(GLOB GENERATED_CHEAT_FILES ${CMAKE_SOURCE_DIR}/Data/Cheats/Generated/*.cht)
 file(GLOB CUSTOM_CHEAT_FILES ${CMAKE_SOURCE_DIR}/Data/Cheats/Custom/*.cht)
 install(FILES ${GENERATED_CHEAT_FILES} ${CUSTOM_CHEAT_FILES}
diff --git a/Source/3rdParty/CMakeLists.txt b/Source/3rdParty/CMakeLists.txt
index c85d6b7..af639d6 100644
--- a/Source/3rdParty/CMakeLists.txt
+++ b/Source/3rdParty/CMakeLists.txt
@@ -235,6 +235,7 @@ set(IMGUI_SOURCES
 add_library(imgui STATIC ${IMGUI_SOURCES})
 target_include_directories(imgui PRIVATE ${IMGUI_DIR})
 
+if (BUNDLE_SDL_GAMECONTROLLERDB)
 set(SDL_GAMECONTROLLERDB_DIR ${CMAKE_CURRENT_SOURCE_DIR}/SDL_GameControllerDB)
 set(SDL_GAMECONTROLLERDB_BUILD_DIR ${CMAKE_CURRENT_BINARY_DIR}/SDL_GameControllerDB)
 set(SDL_GAMECONTROLLERDB_SOURCES_IN
@@ -252,6 +253,7 @@ ExternalProject_Add(SDL_GameControllerDB
 
     BUILD_BYPRODUCTS ${SDL_GAMECONTROLLERDB_SOURCES_OUT}
 )
+endif()
 
 ExternalProject_Get_property(mupen64plus-core BUILD_BYPRODUCTS)
 set(MUPEN64PLUSCORE_LIB ${BUILD_BYPRODUCTS} PARENT_SCOPE)
@@ -283,5 +285,7 @@ set(MUPEN64PLUS_PLUGIN_GFX_PARALLEL ${BUILD_BYPRODUCTS} PARENT_SCOPE)
 
 set(IMGUI_DIR ${CMAKE_CURRENT_SOURCE_DIR}/imgui PARENT_SCOPE)
 
+if (BUNDLE_SDL_GAMECONTROLLERDB)
 ExternalProject_Get_property(SDL_GameControllerDB BUILD_BYPRODUCTS)
 set(SDL_GAMECONTROLLERDB ${BUILD_BYPRODUCTS} PARENT_SCOPE)
+endif()
diff --git a/Source/RMG-Input/main.cpp b/Source/RMG-Input/main.cpp
index d36bd1a..a99d685 100644
--- a/Source/RMG-Input/main.cpp
+++ b/Source/RMG-Input/main.cpp
@@ -1060,8 +1060,7 @@ static void sdl_init()
         }
     }
 
-    gameControllerDbPath = CoreGetSharedDataDirectory();
-    gameControllerDbPath += "/gamecontrollerdb.txt";
+    gameControllerDbPath = "_RPM_GCDBDIR_/gamecontrollerdb.txt";
 
     // try to load SDL_GameControllerDB when the file exists
     if (std::filesystem::is_regular_file(gameControllerDbPath))
-- 
2.51.1

