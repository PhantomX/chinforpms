From 5e53907c0771f91cfd9654ac0e1a61e5a2740f4a Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Thu, 9 Feb 2023 22:56:03 -0300
Subject: [PATCH] Use system SDL_GameControllerDB

---
 CMakeLists.txt                 | 2 ++
 Source/3rdParty/CMakeLists.txt | 4 ++++
 Source/RMG-Input/main.cpp      | 3 +--
 3 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index fad98be..43c8520 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -88,9 +88,11 @@ install(FILES ${MUPEN64PLUSCORE_LIB}
 install(FILES ${MUPEN64PLUSCORE_INI} Data/font.ttf
     DESTINATION ${DATA_INSTALL_PATH}
 )
+if (BUNDLE_SDL_GAMECONTROLLERDB)
 install(FILES ${SDL_GAMECONTROLLERDB}
     DESTINATION ${DATA_INSTALL_PATH}
 )
+endif()
 file(GLOB GENERATED_CHEAT_FILES ${CMAKE_SOURCE_DIR}/Data/Cheats/Generated/*.cht)
 file(GLOB CUSTOM_CHEAT_FILES ${CMAKE_SOURCE_DIR}/Data/Cheats/Custom/*.cht)
 install(FILES ${GENERATED_CHEAT_FILES} ${CUSTOM_CHEAT_FILES}
diff --git a/Source/3rdParty/CMakeLists.txt b/Source/3rdParty/CMakeLists.txt
index 918ea82..81498b0 100644
--- a/Source/3rdParty/CMakeLists.txt
+++ b/Source/3rdParty/CMakeLists.txt
@@ -289,6 +289,7 @@ ExternalProject_Add(imgui
     BUILD_BYPRODUCTS ${IMGUI_SOURCES_OUT}
 )
 
+if (BUNDLE_SDL_GAMECONTROLLERDB)
 set(SDL_GAMECONTROLLERDB_DIR ${THIRDPARTY_DIR}/SDL_GameControllerDB)
 set(SDL_GAMECONTROLLERDB_BUILD_DIR ${SDL_GAMECONTROLLERDB_DIR}/build)
 set(SDL_GAMECONTROLLERDB_SOURCES_IN
@@ -309,6 +310,7 @@ ExternalProject_Add(SDL_GameControllerDB
 
     BUILD_BYPRODUCTS ${SDL_GAMECONTROLLERDB_SOURCES_OUT}
 )
+endif()
 
 ExternalProject_Get_property(mupen64plus-core BUILD_BYPRODUCTS)
 set(MUPEN64PLUSCORE_LIB ${BUILD_BYPRODUCTS} PARENT_SCOPE)
@@ -349,5 +351,7 @@ ExternalProject_Get_property(imgui BUILD_BYPRODUCTS)
 set(IMGUI_SOURCES ${BUILD_BYPRODUCTS} PARENT_SCOPE)
 set(IMGUI_DIR ${THIRDPARTY_DIR}/imgui PARENT_SCOPE)
 
+if (BUNDLE_SDL_GAMECONTROLLERDB)
 ExternalProject_Get_property(SDL_GameControllerDB BUILD_BYPRODUCTS)
 set(SDL_GAMECONTROLLERDB ${BUILD_BYPRODUCTS} PARENT_SCOPE)
+endif()
diff --git a/Source/RMG-Input/main.cpp b/Source/RMG-Input/main.cpp
index e54257a..3c5dae9 100644
--- a/Source/RMG-Input/main.cpp
+++ b/Source/RMG-Input/main.cpp
@@ -589,8 +589,7 @@ void sdl_init()
         }
     }
 
-    gameControllerDbPath = CoreGetSharedDataDirectory();
-    gameControllerDbPath += "/gamecontrollerdb.txt";
+    gameControllerDbPath = "_RPM_GCDBDIR_/gamecontrollerdb.txt";
 
     // load mappings from file
     SDL_GameControllerAddMappingsFromFile(gameControllerDbPath.string().c_str());
-- 
2.39.1

