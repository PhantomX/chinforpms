From f81bc5ffc4e67a2bc13746522efdb5d5418d4a23 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Sat, 24 May 2025 22:15:16 -0300
Subject: [PATCH] Use system libraries

---
 apps/ymir-sdl3/CMakeLists.txt                 | 16 +++++++++---
 apps/ymir-sdl3/src/app/app.cpp                |  2 +-
 .../ymir-sdl3/src/app/services/midi_types.hpp |  2 +-
 .../ui/views/settings/audio_settings_view.cpp |  2 +-
 .../src/app/ui/windows/about_window.cpp       |  6 +----
 apps/ymir-sdl3/stb/CMakeLists.txt             | 22 ++++++++++++++++
 vendor/CMakeLists.txt                         | 25 +++++++++++++++++++
 7 files changed, 64 insertions(+), 11 deletions(-)
 create mode 100644 apps/ymir-sdl3/stb/CMakeLists.txt

diff --git a/apps/ymir-sdl3/CMakeLists.txt b/apps/ymir-sdl3/CMakeLists.txt
index e26c569..4ce74cb 100644
--- a/apps/ymir-sdl3/CMakeLists.txt
+++ b/apps/ymir-sdl3/CMakeLists.txt
@@ -374,9 +374,19 @@ find_package(date CONFIG REQUIRED)
 find_package(OpenSSL CONFIG REQUIRED)
 find_package(CURL REQUIRED)
 find_package(fmt CONFIG REQUIRED)
-find_package(rtmidi CONFIG REQUIRED)
+find_package(rtmidi CONFIG)
+if(NOT rtmidi_FOUND)
+    set(RTMIDI_BUILD_STATIC_LIBS ON)
+    set(RTMIDI_BUILD_TESTING OFF)
+    add_subdirectory(rtmidi)
+    add_library(RtMidi::rtmidi ALIAS rtmidi)
+endif()
 find_package(SDL3 CONFIG REQUIRED)
-find_package(Stb REQUIRED)
+find_package(Stb)
+if(NOT Stb_FOUND)
+    add_subdirectory(stb)
+    target_link_libraries(ymir-sdl3 PRIVATE stb::stb)
+endif()
 find_package(tomlplusplus CONFIG REQUIRED)
 
 target_include_directories(ymir-sdl3
@@ -398,7 +408,7 @@ target_link_libraries(ymir-sdl3 PRIVATE
     cereal::cereal
     lz4::lz4
     RtMidi::rtmidi
-    CURL::libcurl_static
+    CURL::libcurl
 )
 if (WIN32)
     target_link_libraries(ymir-sdl3 PRIVATE
diff --git a/apps/ymir-sdl3/src/app/app.cpp b/apps/ymir-sdl3/src/app/app.cpp
index 8c7b314..e8e2a30 100644
--- a/apps/ymir-sdl3/src/app/app.cpp
+++ b/apps/ymir-sdl3/src/app/app.cpp
@@ -134,7 +134,7 @@
 #include <fmt/chrono.h>
 #include <fmt/std.h>
 
-#include <rtmidi/RtMidi.h>
+#include <RtMidi.h>
 
 #include <clocale>
 #include <mutex>
diff --git a/apps/ymir-sdl3/src/app/services/midi_types.hpp b/apps/ymir-sdl3/src/app/services/midi_types.hpp
index 206d808..31b7fc6 100644
--- a/apps/ymir-sdl3/src/app/services/midi_types.hpp
+++ b/apps/ymir-sdl3/src/app/services/midi_types.hpp
@@ -7,7 +7,7 @@
 //
 // Hopefully https://github.com/thestk/rtmidi/issues/367 is solved at some point.
 
-#include <rtmidi/RtMidi.h>
+#include <RtMidi.h>
 
 #include <memory>
 
diff --git a/apps/ymir-sdl3/src/app/ui/views/settings/audio_settings_view.cpp b/apps/ymir-sdl3/src/app/ui/views/settings/audio_settings_view.cpp
index 82cf121..932a71c 100644
--- a/apps/ymir-sdl3/src/app/ui/views/settings/audio_settings_view.cpp
+++ b/apps/ymir-sdl3/src/app/ui/views/settings/audio_settings_view.cpp
@@ -7,7 +7,7 @@
 #include <app/ui/widgets/common_widgets.hpp>
 #include <app/ui/widgets/settings_widgets.hpp>
 
-#include <rtmidi/RtMidi.h>
+#include <RtMidi.h>
 
 using namespace ymir;
 
diff --git a/apps/ymir-sdl3/src/app/ui/windows/about_window.cpp b/apps/ymir-sdl3/src/app/ui/windows/about_window.cpp
index 6e5bc7e..872d573 100644
--- a/apps/ymir-sdl3/src/app/ui/windows/about_window.cpp
+++ b/apps/ymir-sdl3/src/app/ui/windows/about_window.cpp
@@ -23,12 +23,10 @@
 #include <ngtcp2/version.h>
 #include <nlohmann/json.hpp>
 #include <openssl/opensslv.h>
-#include <rtmidi/RtMidi.h>
+#include <RtMidi.h>
 #include <semver.hpp>
 #include <toml++/toml.hpp>
 #include <xxhash.h>
-#include <zlib.h>
-#include <zstd.h>
 
 #define _STR_IMPL(x) #x
 #define _STR(x) _STR_IMPL(x)
@@ -128,8 +126,6 @@ static const struct {
     {.name = "stb_image_write",               .version = STB_IMAGE_WRITE_VERSION,    .license = licenseMIT,           .repoURL = "https://github.com/nothings/stb",                .licenseURL = "https://github.com/nothings/stb/blob/master/LICENSE"},
     {.name = "toml++",                        .version = TOMLPP_VERSION,             .license = licenseMIT,           .repoURL = "https://github.com/marzer/tomlplusplus" ,        .licenseURL = "https://github.com/marzer/tomlplusplus/blob/master/LICENSE",             .homeURL = "https://marzer.github.io/tomlplusplus/"},
     {.name = "xxHash",                        .version = XXHASH_VERSION,             .license = licenseBSD2,          .repoURL = "https://github.com/Cyan4973/xxHash",             .licenseURL = "https://github.com/Cyan4973/xxHash/blob/dev/LICENSE",                    .homeURL = "https://xxhash.com/"},
-    {.name = "zlib",                          .version = ZLIB_VERSION,               .license = licenseZlib,          .repoURL = "https://github.com/madler/zlib",                 .licenseURL = "https://github.com/madler/zlib/blob/develop/LICENSE",                    .homeURL = "https://zlib.net/"},
-    {.name = "zstd",                          .version = ZSTD_VERSION_STRING,        .license = licenseBSD3,          .repoURL = "https://github.com/facebook/zstd",               .licenseURL = "https://github.com/facebook/zstd/blob/dev/LICENSE",                      .homeURL = "http://www.zstd.net/"},
 };
 
 
diff --git a/apps/ymir-sdl3/stb/CMakeLists.txt b/apps/ymir-sdl3/stb/CMakeLists.txt
new file mode 100644
index 0000000..49a628c
--- /dev/null
+++ b/apps/ymir-sdl3/stb/CMakeLists.txt
@@ -0,0 +1,22 @@
+add_library(stb INTERFACE
+    stb/stb_image.h
+    stb/stb_image_write.h
+)
+
+add_library(stb::stb ALIAS stb)
+target_include_directories(stb
+    INTERFACE
+        "$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/stb>"
+)
+target_compile_features(stb INTERFACE cxx_std_20)
+
+## Apply performance options
+if (Ymir_AVX2)
+    if (MSVC)
+        target_compile_options(stb INTERFACE "/arch:AVX2")
+    else ()
+        target_compile_options(stb INTERFACE "-mavx2")
+        target_compile_options(stb INTERFACE "-mfma")
+        target_compile_options(stb INTERFACE "-mbmi")
+    endif ()
+endif ()
diff --git a/vendor/CMakeLists.txt b/vendor/CMakeLists.txt
index 7695024..afd84af 100644
--- a/vendor/CMakeLists.txt
+++ b/vendor/CMakeLists.txt
@@ -17,6 +17,8 @@
 
 message(STATUS "Adding vendored libraries")
 
+find_package(PkgConfig REQUIRED)
+
 # mio - https://github.com/vimpunk/mio
 # Notes:
 # - Using StrikerX3's fork instead
@@ -38,17 +40,40 @@ add_subdirectory(imgui EXCLUDE_FROM_ALL)
 # xxHash - https://github.com/Cyan4973/xxHash
 # - Unable to configure AVX2 support
 message(STATUS "==> xxHash")
+pkg_search_module(libxxhash IMPORTED_TARGET libxxhash)
+if(libxxhash_FOUND)
+  message(STATUS "Using the system libxxhash")
+  add_library(libxxhash INTERFACE)
+  target_link_libraries(libxxhash INTERFACE PkgConfig::libxxhash)
+  add_library(xxHash::xxHash ALIAS libxxhash)
+else()
 add_subdirectory(xxHash EXCLUDE_FROM_ALL)
+endif()
 
 # lz4 - https://github.com/lz4/lz4
 # - Unable to configure AVX2 support
 message(STATUS "==> lz4")
+pkg_search_module(liblz4 IMPORTED_TARGET liblz4)
+if(liblz4_FOUND)
+  message(STATUS "Using the system liblz4")
+  add_library(liblz4 INTERFACE)
+  target_link_libraries(liblz4 INTERFACE PkgConfig::liblz4)
+  add_library(lz4::lz4 ALIAS liblz4)
+else()
 add_subdirectory(lz4 EXCLUDE_FROM_ALL)
+endif()
 
 # libchdr - https://github.com/rtissera/libchdr
 # - Not available as a vcpkg port
 message(STATUS "==> libchdr")
+pkg_search_module(libchdr IMPORTED_TARGET libchdr)
+if(libchdr_FOUND)
+  message(STATUS "Using the system libchdr")
+  add_library(chdr-static INTERFACE)
+  target_link_libraries(chdr-static INTERFACE PkgConfig::libchdr)
+else()
 add_subdirectory(libchdr)
+endif()
 
 # Place vendored library projects under a Vendored folder in Visual Studio solutions
 if (MSVC)
-- 
2.53.0

