From 0e69b1459b70f61a7b26cee5a90b6dd3446959a3 Mon Sep 17 00:00:00 2001
From: rpm-build <rpm-build>
Date: Sat, 1 Jun 2024 19:26:14 -0300
Subject: [PATCH] winex11: always update display cache

Fix virtual desktop custom resolutions from explorer /desktop command line
---
 dlls/winex11.drv/window.c | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/dlls/winex11.drv/window.c b/dlls/winex11.drv/window.c
index b56f579..d7ab97b 100644
--- a/dlls/winex11.drv/window.c
+++ b/dlls/winex11.drv/window.c
@@ -2025,7 +2025,9 @@ void X11DRV_SetDesktopWindow( HWND hwnd )
 
     if (!width && !height)  /* not initialized yet */
     {
-        RECT rect = NtUserGetVirtualScreenRect();
+        RECT rect;
+        NtUserCallNoParam( NtUserCallNoParam_UpdateDisplayCache );
+        rect = NtUserGetVirtualScreenRect();
 
         SERVER_START_REQ( set_window_pos )
         {
@@ -2058,7 +2060,11 @@ void X11DRV_SetDesktopWindow( HWND hwnd )
     else
     {
         Window win = (Window)NtUserGetProp( hwnd, whole_window_prop );
-        if (win && win != root_window) X11DRV_init_desktop( win, width, height );
+        if (win && win != root_window)
+        {
+            X11DRV_init_desktop( win, width, height );
+            NtUserCallNoParam( NtUserCallNoParam_UpdateDisplayCache );
+        };
     }
 }
 
-- 
2.45.1

