From 5c5808ac6c3b639a495736c2058acc555405c954 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Sun, 22 May 2022 20:12:38 -0300
Subject: [PATCH] Use system libraries

---
 cmake/SearchForStuff.cmake                    | 57 ++++++++++++++++---
 pcsx2/CDVD/ChdFileReader.cpp                  |  2 +-
 pcsx2/CMakeLists.txt                          |  9 ++-
 pcsx2/GS/MultiISA.cpp                         |  2 +-
 .../SW/GSDrawScanlineCodeGenerator.h          |  2 +-
 pcsx2/GS/Renderers/SW/GSNewCodeGenerator.h    |  4 +-
 .../Renderers/SW/GSSetupPrimCodeGenerator.h   |  2 +-
 7 files changed, 62 insertions(+), 16 deletions(-)

diff --git a/cmake/SearchForStuff.cmake b/cmake/SearchForStuff.cmake
index 50f22e2..a4b8790 100644
--- a/cmake/SearchForStuff.cmake
+++ b/cmake/SearchForStuff.cmake
@@ -113,11 +113,10 @@ endif()
 
 find_optional_system_library(fmt 3rdparty/fmt/fmt 7.1.3)
 find_optional_system_library(ryml 3rdparty/rapidyaml/rapidyaml 0.4.0)
-find_optional_system_library(zstd 3rdparty/zstd 1.4.5)
-if (${zstd_TYPE} STREQUAL System)
-	alias_library(Zstd::Zstd zstd::libzstd_shared)
-	alias_library(pcsx2-zstd zstd::libzstd_shared)
-endif()
+
+check_lib(zstd libzstd)
+alias_library(Zstd::Zstd PkgConfig::zstd)
+alias_library(pcsx2-zstd PkgConfig::zstd)
 find_optional_system_library(libzip 3rdparty/libzip 1.8.0)
 
 if(QT_BUILD)
@@ -162,36 +161,78 @@ if(NOT WIN32 AND QT_BUILD)
 	find_package(CURL REQUIRED)
 endif()
 
-add_subdirectory(3rdparty/lzma EXCLUDE_FROM_ALL)
-add_subdirectory(3rdparty/libchdr EXCLUDE_FROM_ALL)
+check_lib(CHDR libchdr)
+if(NOT CHDR_FOUND)
+	add_subdirectory(3rdparty/lzma EXCLUDE_FROM_ALL)
+	add_subdirectory(3rdparty/libchdr EXCLUDE_FROM_ALL)
+else()
+	alias_library(chdr-static PkgConfig::CHDR)
+endif()
+
+find_package(SoundTouch)
+if(SoundTouch_FOUND)
+	message(STATUS "Using the system soundtouch")
+	alias_library(soundtouch SoundTouch::SoundTouch)
+else()
 add_subdirectory(3rdparty/soundtouch EXCLUDE_FROM_ALL)
+endif()
 
 # rapidyaml includes fast_float as a submodule, saves us pulling it in directly.
 # Normally, we'd just pull in the cmake project, and link to it, but... it seems to enable
 # permissive mode, which breaks other parts of PCSX2. So, we'll just create a target here
 # for now.
 #add_subdirectory(3rdparty/rapidyaml/rapidyaml/ext/c4core/src/c4/ext/fast_float EXCLUDE_FROM_ALL)
+find_package(FastFloat)
+if(FastFloat_FOUND)
+	message(STATUS "Using the system fast_float")
+	alias_library(fast_float FastFloat::fast_float)
+else()
 add_library(fast_float INTERFACE)
 target_include_directories(fast_float INTERFACE 3rdparty/rapidyaml/rapidyaml/ext/c4core/src/c4/ext/fast_float/include)
+endif()
+
+find_package(xbyak)
+if(xbyak_FOUND)
+	message(STATUS "Using the system xbyak")
+	alias_library(xbyak xbyak::xbyak)
+endif()
 
 add_subdirectory(3rdparty/jpgd EXCLUDE_FROM_ALL)
 add_subdirectory(3rdparty/simpleini EXCLUDE_FROM_ALL)
 add_subdirectory(3rdparty/imgui EXCLUDE_FROM_ALL)
-add_subdirectory(3rdparty/cpuinfo EXCLUDE_FROM_ALL)
 add_subdirectory(3rdparty/zydis EXCLUDE_FROM_ALL)
 
+check_lib(CPUINFO libcpuinfo)
+if(NOT CPUINFO_FOUND)
+	add_subdirectory(3rdparty/cpuinfo EXCLUDE_FROM_ALL)
+else()
+	alias_library(cpuinfo PkgConfig::CPUINFO)
+endif()
+
 if(USE_OPENGL)
 	add_subdirectory(3rdparty/glad EXCLUDE_FROM_ALL)
 endif()
 
 if(USE_VULKAN)
 	add_subdirectory(3rdparty/glslang EXCLUDE_FROM_ALL)
+	find_package(VulkanHeaders)
+	if(VulkanHeaders_FOUND)
+		message(STATUS "Using the system vulkan-headers")
+		alias_library(Vulkan-Headers Vulkan::Headers)
+	else()
 	add_subdirectory(3rdparty/vulkan-headers EXCLUDE_FROM_ALL)
+	endif()
 endif()
 
 if(CUBEB_API)
+	find_package(cubeb)
+	if(cubeb_FOUND)
+		message(STATUS "Using the system cubeb")
+		alias_library(cubeb cubeb::cubeb)
+	else()
 	add_subdirectory(3rdparty/cubeb EXCLUDE_FROM_ALL)
 	target_compile_options(cubeb PRIVATE "-w")
 	target_compile_options(speex PRIVATE "-w")
+	endif()
 endif()
 
diff --git a/pcsx2/CDVD/ChdFileReader.cpp b/pcsx2/CDVD/ChdFileReader.cpp
index 7fd6607..73faef3 100644
--- a/pcsx2/CDVD/ChdFileReader.cpp
+++ b/pcsx2/CDVD/ChdFileReader.cpp
@@ -25,7 +25,7 @@
 #pragma clang diagnostic push
 #pragma clang diagnostic ignored "-Wunused-function"
 #endif
-#include "libchdr/chd.h"
+#include "chd.h"
 #ifdef __clang__
 #pragma clang diagnostic pop
 #endif
diff --git a/pcsx2/CMakeLists.txt b/pcsx2/CMakeLists.txt
index e0d2f95..20bd884 100644
--- a/pcsx2/CMakeLists.txt
+++ b/pcsx2/CMakeLists.txt
@@ -1220,12 +1220,17 @@ target_include_directories(PCSX2_FLAGS INTERFACE
 	"${CMAKE_CURRENT_SOURCE_DIR}"
 	"${CMAKE_BINARY_DIR}/pcsx2"
 	"${CMAKE_BINARY_DIR}/common/include"
-	"${CMAKE_SOURCE_DIR}/3rdparty/xbyak"
 	"${FFMPEG_INCLUDE_DIRS}"
 )
+
+if(TARGET xbyak::xbyak)
+	target_link_libraries(PCSX2_FLAGS INTERFACE xbyak::xbyak)
+else()
+	target_include_directories(PCSX2_FLAGS INTERFACE "${CMAKE_SOURCE_DIR}/3rdparty/xbyak/xbyak")
+)
+endif()
 target_compile_definitions(PCSX2_FLAGS INTERFACE
 	XBYAK_NO_EXCEPTION
-)
 
 if(COMMAND target_precompile_headers)
 	message("Using precompiled headers.")
diff --git a/pcsx2/GS/MultiISA.cpp b/pcsx2/GS/MultiISA.cpp
index e5e572e..43f13ca 100644
--- a/pcsx2/GS/MultiISA.cpp
+++ b/pcsx2/GS/MultiISA.cpp
@@ -15,7 +15,7 @@
 
 #include "PrecompiledHeader.h"
 #include "MultiISA.h"
-#include <xbyak/xbyak_util.h>
+#include <xbyak_util.h>
 
 #ifdef _WIN32
 #define strcasecmp _stricmp
diff --git a/pcsx2/GS/Renderers/SW/GSDrawScanlineCodeGenerator.h b/pcsx2/GS/Renderers/SW/GSDrawScanlineCodeGenerator.h
index 21b6a2f..8077cb3 100644
--- a/pcsx2/GS/Renderers/SW/GSDrawScanlineCodeGenerator.h
+++ b/pcsx2/GS/Renderers/SW/GSDrawScanlineCodeGenerator.h
@@ -23,7 +23,7 @@
 #ifdef _WIN32
 #include "common/RedtapeWindows.h"
 #endif
-#include <xbyak/xbyak.h>
+#include <xbyak.h>
 
 #if defined(_M_AMD64) || defined(_WIN64)
 #define RegLong Xbyak::Reg64
diff --git a/pcsx2/GS/Renderers/SW/GSNewCodeGenerator.h b/pcsx2/GS/Renderers/SW/GSNewCodeGenerator.h
index 2404d27..b398341 100644
--- a/pcsx2/GS/Renderers/SW/GSNewCodeGenerator.h
+++ b/pcsx2/GS/Renderers/SW/GSNewCodeGenerator.h
@@ -17,8 +17,8 @@
 
 #define XBYAK_NO_OP_NAMES
 
-#include "xbyak/xbyak.h"
-#include "xbyak/xbyak_util.h"
+#include "xbyak.h"
+#include "xbyak_util.h"
 #include "GS/MultiISA.h"
 #include "common/Assertions.h"
 
diff --git a/pcsx2/GS/Renderers/SW/GSSetupPrimCodeGenerator.h b/pcsx2/GS/Renderers/SW/GSSetupPrimCodeGenerator.h
index 51041a2..4b464cc 100644
--- a/pcsx2/GS/Renderers/SW/GSSetupPrimCodeGenerator.h
+++ b/pcsx2/GS/Renderers/SW/GSSetupPrimCodeGenerator.h
@@ -22,7 +22,7 @@
 #ifdef _WIN32
 #include "common/RedtapeWindows.h"
 #endif
-#include <xbyak/xbyak.h>
+#include <xbyak.h>
 
 MULTI_ISA_UNSHARED_START
 
-- 
2.41.0

