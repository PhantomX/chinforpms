From 28a6f47aad00d0a7d086fba66ffd6f74818e3d4d Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Sat, 21 Aug 2021 20:53:54 -0300
Subject: [PATCH] System libchdr support

---
 cmake/SearchForStuff.cmake | 12 +++++++++++-
 pcsx2/CDVD/ChdFileReader.h |  2 +-
 pcsx2/CMakeLists.txt       |  2 +-
 3 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/cmake/SearchForStuff.cmake b/cmake/SearchForStuff.cmake
index 3d88bfa..316c5b6 100644
--- a/cmake/SearchForStuff.cmake
+++ b/cmake/SearchForStuff.cmake
@@ -223,7 +223,17 @@ if(NOT USE_SYSTEM_YAML)
 	endif()
 endif()
 
-add_subdirectory(3rdparty/libchdr/libchdr EXCLUDE_FROM_ALL)
+check_lib(CHDR libchdr)
+if(NOT CHDR_FOUND)
+    message(STATUS "No system libchdr was found")
+    set(CHDR_SYSTEM_LIBRARY chdr-static)
+    add_subdirectory(3rdparty/libchdr/libchdr EXCLUDE_FROM_ALL)
+    include_directories(3rdparty/libchdr/libchdr/include/libchdr)
+else()
+    include_directories(${CHDR_INCLUDE_DIRS})
+    set(CHDR_SYSTEM_LIBRARY ${CHDR_LIBRARIES})
+    message(STATUS "Found libchdr: ${CHDR_SYSTEM_LIBRARY}")
+endif()
 
 if(USE_NATIVE_TOOLS)
 	add_subdirectory(tools/bin2cpp EXCLUDE_FROM_ALL)
diff --git a/pcsx2/CDVD/ChdFileReader.h b/pcsx2/CDVD/ChdFileReader.h
index 9975c8f..59b7db8 100644
--- a/pcsx2/CDVD/ChdFileReader.h
+++ b/pcsx2/CDVD/ChdFileReader.h
@@ -15,7 +15,7 @@
 
 #pragma once
 #include "ThreadedFileReader.h"
-#include "libchdr/chd.h"
+#include "chd.h"
 
 class ChdFileReader : public ThreadedFileReader
 {
diff --git a/pcsx2/CMakeLists.txt b/pcsx2/CMakeLists.txt
index 3e07cdc..4dd5305 100644
--- a/pcsx2/CMakeLists.txt
+++ b/pcsx2/CMakeLists.txt
@@ -1246,7 +1246,7 @@ target_link_libraries(PCSX2 PRIVATE
 	x86emitter
 	fmt::fmt
 	yaml-cpp
-	chdr-static
+	${CHDR_SYSTEM_LIBRARY}
 	wxWidgets::all
 	GTK::gtk
 	HarfBuzz::HarfBuzz
-- 
2.31.1

