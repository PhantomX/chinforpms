From b9490b34384939dfa01501cb18d137fa0f5e44c3 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Sun, 15 Sep 2019 17:30:17 -0300
Subject: [PATCH] Use system libs

---
 core/archive/ZipArchive.h |  4 ++++
 core/core.mk              | 33 ++++++++++++++++++++++++++++-----
 shell/linux/Makefile      | 32 ++++++++++++++++++++++++++++++++
 3 files changed, 64 insertions(+), 5 deletions(-)

diff --git a/core/archive/ZipArchive.h b/core/archive/ZipArchive.h
index 05a0f0f..ff24960 100644
--- a/core/archive/ZipArchive.h
+++ b/core/archive/ZipArchive.h
@@ -22,7 +22,11 @@
 #ifndef CORE_ARCHIVE_ZIPARCHIVE_H_
 #define CORE_ARCHIVE_ZIPARCHIVE_H_
 #include "archive.h"
+#ifdef SYSTEM_LIBZIP
+#include <zip.h>
+#else
 #include "deps/libzip/zip.h"
+#endif
 
 class ZipArchive : public Archive
 {
diff --git a/core/core.mk b/core/core.mk
index a91ad3f..444e4b7 100755
--- a/core/core.mk
+++ b/core/core.mk
@@ -9,9 +9,21 @@ VERSION_HEADER := $(RZDCY_SRC_DIR)/version.h
 
 RZDCY_MODULES	:=	cfg/ hw/arm7/ hw/aica/ hw/holly/ hw/ hw/gdrom/ hw/maple/ \
  hw/mem/ hw/pvr/ hw/sh4/ hw/sh4/interpr/ hw/sh4/modules/ plugins/ profiler/ oslib/ \
- hw/extdev/ hw/arm/ hw/naomi/ imgread/ ./ deps/coreio/ deps/zlib/ deps/chdr/ deps/crypto/ \
- deps/libelf/ deps/chdpsr/ arm_emitter/ rend/ reios/ deps/libpng/ deps/xbrz/ \
- deps/libzip/ deps/imgui/ archive/ input/ log/
+ hw/extdev/ hw/arm/ hw/naomi/ imgread/ ./ deps/coreio/ deps/chdr/ deps/crypto/ \
+ deps/libelf/ deps/chdpsr/ arm_emitter/ rend/ reios/ deps/xbrz/ \
+ deps/imgui/ archive/ input/ log/
+
+ifndef SYSTEM_LIBPNG
+RZDCY_MODULES += deps/libpng/
+endif
+
+ifndef SYSTEM_LIBZIP
+RZDCY_MODULES +=  deps/libzip/
+endif
+
+ifndef SYSTEM_ZLIB
+RZDCY_MODULES +=  deps/zlib/
+endif
 
 ifndef NOT_ARM
     RZDCY_MODULES += rec-ARM/
@@ -127,8 +139,10 @@ endif
 ifdef CHD5_FLAC
 	RZDCY_CFLAGS += -DCHD5_FLAC -I$(RZDCY_SRC_DIR)/deps/flac/src/libFLAC/include/ -I$(RZDCY_SRC_DIR)/deps/flac/include
 	RZDCY_CFLAGS += -DHAVE_CONFIG_H
+ifndef SYSTEM_FLAC
 	RZDCY_MODULES += deps/flac/src/libFLAC/
 endif
+endif
 
 # 7-Zip/LZMA settings (CHDv5)
 ifdef CHD5_LZMA
@@ -136,8 +150,16 @@ ifdef CHD5_LZMA
 	RZDCY_CFLAGS += -D_7ZIP_ST -DCHD5_LZMA
 endif
 
-RZDCY_CFLAGS += -I$(RZDCY_SRC_DIR)/deps/libpng -I$(RZDCY_SRC_DIR)/deps/zlib
-RZDCY_CFLAGS +=  -DXXH_INLINE_ALL -I$(RZDCY_SRC_DIR)/deps/xxhash
+ifndef SYSTEM_LIBPNG
+RZDCY_CFLAGS += -I$(RZDCY_SRC_DIR)/deps/libpng
+endif
+ifndef SYSTEM_ZLIB
+RZDCY_CFLAGS += -I$(RZDCY_SRC_DIR)/deps/zlib
+endif
+
+ifndef SYSTEM_XXHASH
+RZDCY_CFLAGS +=  -DXXH_INLINE_ALL -I$(RZDCY_SRC_DIR)/deps/xxhash
+endif
 
 RZDCY_CXXFLAGS := $(RZDCY_CFLAGS) -fno-exceptions -fno-rtti -std=gnu++11
 
diff --git a/shell/linux/Makefile b/shell/linux/Makefile
index a7c5e6c..7ccf9d3 100644
--- a/shell/linux/Makefile
+++ b/shell/linux/Makefile
@@ -12,6 +12,12 @@ USE_UDEV := 1
 USE_MODEM := 1
 PLATFORM_EXT := elf
 
+SYSTEM_FLAC := 1
+SYSTEM_LIBPNG := 1
+SYSTEM_LIBZIP := 1
+SYSTEM_XXHASH := 1
+SYSTEM_ZLIB := 1
+
 CXX ?= ${CC_PREFIX}g++
 CC ?= ${CC_PREFIX}gcc
 AS ?= ${CC_PREFIX}as
@@ -399,6 +405,32 @@ ifdef DEBUGFAST
     CFLAGS += -DDEBUGFAST
 endif
 
+ifdef SYSTEM_FLAC
+    CFLAGS += `pkg-config --cflags flac`
+    CXXFLAGS += `pkg-config --cflags flac`
+    LIBS += `pkg-config --libs flac`
+endif
+
+ifdef SYSTEM_LIBPNG
+    CXXFLAGS += `pkg-config --cflags libpng`
+    LIBS += `pkg-config --libs libpng`
+endif
+
+ifdef SYSTEM_LIBZIP
+    CXXFLAGS += `pkg-config --cflags libzip` -D SYSTEM_LIBZIP
+    LIBS += `pkg-config --libs libzip`
+endif
+
+ifdef SYSTEM_XXHASH
+    LIBS += -lxxhash
+endif
+
+ifdef SYSTEM_ZLIB
+    CFLAGS += `pkg-config --cflags zlib` -D SYSTEM_ZLIB
+    CXXFLAGS += `pkg-config --cflags zlib` -D SYSTEM_ZLIB
+    LIBS += `pkg-config --libs zlib`
+endif
+
 EXECUTABLE_STRIPPED=nosym-reicast.$(PLATFORM_EXT)
 DC_PLATFORM=dreamcast
 EXECUTABLE=reicast.$(PLATFORM_EXT)
-- 
2.21.0
