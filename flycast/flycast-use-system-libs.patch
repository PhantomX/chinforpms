From 9b949b6d06d9a85287cf08e8527c990ef208222b Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Sat, 14 Mar 2020 22:17:47 -0300
Subject: [PATCH] Use system libs

---
 core/core.mk                | 33 +++++++++++++++++++++++++++++----
 core/hw/sh4/dyna/driver.cpp |  4 ++++
 shell/linux/Makefile        | 33 +++++++++++++++++++++++++++++++++
 3 files changed, 66 insertions(+), 4 deletions(-)

diff --git a/core/core.mk b/core/core.mk
index d3db6d8..1c97e49 100755
--- a/core/core.mk
+++ b/core/core.mk
@@ -9,9 +9,21 @@ VERSION_HEADER := $(RZDCY_SRC_DIR)/version.h
 
 RZDCY_MODULES	:=	cfg/ hw/arm7/ hw/aica/ hw/holly/ hw/ hw/gdrom/ hw/maple/ \
  hw/mem/ hw/pvr/ hw/sh4/ hw/sh4/interpr/ hw/sh4/modules/ plugins/ profiler/ oslib/ \
- hw/extdev/ hw/arm/ hw/naomi/ imgread/ ./ deps/coreio/ deps/zlib/ deps/chdr/ deps/crypto/ \
- deps/libelf/ deps/chdpsr/ arm_emitter/ rend/ reios/ deps/libpng/ deps/xbrz/ \
- deps/libzip/ deps/imgui/ archive/ input/ log/ wsi/
+ hw/extdev/ hw/arm/ hw/naomi/ imgread/ ./ deps/coreio/ deps/chdr/ deps/crypto/ \
+ deps/libelf/ deps/chdpsr/ arm_emitter/ rend/ reios/ deps/xbrz/ \
+ deps/imgui/ archive/ input/ log/ wsi/
+
+ifndef SYSTEM_LIBPNG
+RZDCY_MODULES += deps/libpng/
+endif
+
+ifndef SYSTEM_LIBZIP
+RZDCY_MODULES +=  deps/libzip/
+endif
+
+ifndef SYSTEM_ZLIB
+RZDCY_MODULES +=  deps/zlib/
+endif
 
 ifndef NOT_ARM
     RZDCY_MODULES += rec-ARM/
@@ -151,8 +163,10 @@ endif
 ifdef CHD5_FLAC
 	RZDCY_CFLAGS += -DCHD5_FLAC -I$(RZDCY_SRC_DIR)/deps/flac/src/libFLAC/include/ -I$(RZDCY_SRC_DIR)/deps/flac/include
 	RZDCY_CFLAGS += -DHAVE_CONFIG_H
+ifndef SYSTEM_FLAC
 	RZDCY_MODULES += deps/flac/src/libFLAC/
 endif
+endif
 
 # 7-Zip/LZMA settings (CHDv5)
 ifdef CHD5_LZMA
@@ -160,8 +174,19 @@ ifdef CHD5_LZMA
 	RZDCY_CFLAGS += -D_7ZIP_ST -DCHD5_LZMA
 endif
 
-RZDCY_CFLAGS += -I$(RZDCY_SRC_DIR)/deps/libpng -I$(RZDCY_SRC_DIR)/deps/libzip -I$(RZDCY_SRC_DIR)/deps/zlib
+ifndef SYSTEM_LIBPNG
+RZDCY_CFLAGS += -I$(RZDCY_SRC_DIR)/deps/libpng
+endif
+ifndef SYSTEM_LIBZIP
+RZDCY_CFLAGS += -I$(RZDCY_SRC_DIR)/deps/libzip
+endif
+ifndef SYSTEM_ZLIB
+RZDCY_CFLAGS += -I$(RZDCY_SRC_DIR)/deps/zlib
+endif
+
+ifndef SYSTEM_XXHASH
 RZDCY_CFLAGS +=  -DXXH_INLINE_ALL -I$(RZDCY_SRC_DIR)/deps/xxhash
+endif
 
 RZDCY_CXXFLAGS := $(RZDCY_CFLAGS) -fno-exceptions -fno-rtti -std=gnu++11
 
diff --git a/core/hw/sh4/dyna/driver.cpp b/core/hw/sh4/dyna/driver.cpp
index dbb0fbd..2d0b834 100644
--- a/core/hw/sh4/dyna/driver.cpp
+++ b/core/hw/sh4/dyna/driver.cpp
@@ -1,7 +1,11 @@
 #include "types.h"
 #include <unordered_set>
 
+#ifdef SYSTEM_XXHASH
+#include <xxhash.h>
+#else
 #include "deps/xxhash/xxhash.h"
+#endif
 #include "../sh4_interpreter.h"
 #include "../sh4_opcode_list.h"
 #include "../sh4_core.h"
diff --git a/shell/linux/Makefile b/shell/linux/Makefile
index 0e4f56f..fa7b0b4 100644
--- a/shell/linux/Makefile
+++ b/shell/linux/Makefile
@@ -14,6 +14,12 @@ endif
 USE_MODEM := 1
 PLATFORM_EXT := elf
 
+SYSTEM_FLAC := 1
+SYSTEM_LIBPNG := 1
+SYSTEM_LIBZIP := 1
+SYSTEM_XXHASH := 1
+SYSTEM_ZLIB := 1
+
 CXX ?= ${CC_PREFIX}g++
 CC ?= ${CC_PREFIX}gcc
 AS ?= ${CC_PREFIX}as
@@ -407,6 +413,33 @@ ifdef DEBUGFAST
     CFLAGS += -DDEBUGFAST
 endif
 
+ifdef SYSTEM_FLAC
+    CFLAGS += `pkg-config --cflags flac`
+    CXXFLAGS += `pkg-config --cflags flac`
+    LIBS += `pkg-config --libs flac`
+endif
+
+ifdef SYSTEM_LIBPNG
+    CXXFLAGS += `pkg-config --cflags libpng`
+    LIBS += `pkg-config --libs libpng`
+endif
+
+ifdef SYSTEM_LIBZIP
+    CXXFLAGS += `pkg-config --cflags libzip` -D SYSTEM_LIBZIP
+    LIBS += `pkg-config --libs libzip`
+endif
+
+ifdef SYSTEM_XXHASH
+    CXXFLAGS += -D SYSTEM_XXHASH
+    LIBS += -lxxhash
+endif
+
+ifdef SYSTEM_ZLIB
+    CFLAGS += `pkg-config --cflags zlib` -D SYSTEM_ZLIB
+    CXXFLAGS += `pkg-config --cflags zlib` -D SYSTEM_ZLIB
+    LIBS += `pkg-config --libs zlib`
+endif
+
 ifdef UNIT_TESTS
     CFLAGS += -DUNIT_TESTS
 endif
-- 
2.24.1

