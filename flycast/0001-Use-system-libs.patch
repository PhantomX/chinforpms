From 8968bb264eeddb60daabe3662e2c37f534d98b36 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Thu, 28 Jan 2021 22:37:22 -0300
Subject: [PATCH] Use system libs

---
 CMakeLists.txt                | 68 ++++++++++++++++++++++++++++++++---
 core/archive/7zArchive.cpp    |  7 ++++
 core/archive/7zArchive.h      |  5 +++
 core/archive/archive.cpp      |  4 +++
 core/deps/chdr/chd.c          |  5 +++
 core/imgread/chd.cpp          |  4 +++
 core/rend/vulkan/compiler.cpp |  4 +++
 core/rend/vulkan/shaders.h    |  4 +++
 8 files changed, 96 insertions(+), 5 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 48ab960..b95f907 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -11,6 +11,9 @@ option(ENABLE_OPROFILE "Enable OProfile" OFF)
 option(TEST_AUTOMATION "Enable test automation" OFF)
 option(ENABLE_LOG "Enable full logging" OFF)
 option(ASAN "Enable address sanitizer" OFF)
+option(USE_SYSTEM_CHDR "Dynamically link against system libchdr" OFF)
+option(USE_SYSTEM_LZMA "Dynamically link against system lzma-sdk" OFF)
+option(USE_SYSTEM_SPIRV "Dynamically link against system glslang/spirv" OFF)
 
 set(CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/shell/cmake")
 
@@ -101,19 +104,40 @@ else()
     target_compile_definitions(${PROJECT_NAME} PRIVATE TARGET_NO_OPENMP)
 endif()
 
+find_package(PkgConfig QUIET)
+
+pkg_search_module(XXHASH REQUIRED libxxhash)
+if(XXHASH_FOUND)
+    message(STATUS "Using system xxhash")
+    target_include_directories(${PROJECT_NAME} PRIVATE ${XXHASH_INCLUDE_DIRS})
+    target_link_libraries(${PROJECT_NAME} PRIVATE ${XXHASH_LIBRARIES})
+else()
 option(BUILD_SHARED_LIBS "Build shared library" OFF)
 set(XXHASH_BUILD_XXHSUM OFF CACHE BOOL "Build the xxhsum binary")
 add_subdirectory(core/deps/xxHash/cmake_unofficial)
 target_link_libraries(${PROJECT_NAME} PRIVATE xxHash::xxhash)
+endif()
 
+find_package(glm)
+if(NOT glm_FOUND)
 option(BUILD_SHARED_LIBS "Build shared library" OFF)
 add_subdirectory(core/deps/glm)
 target_link_libraries(${PROJECT_NAME} PRIVATE glm::glm)
+endif()
 
 if(NOT APPLE)
+if(USE_SYSTEM_SPIRV)
+    pkg_search_module(GLSLANG REQUIRED glslang)
+    pkg_search_module(SPIRV REQUIRED spirv)
+    message(STATUS "Using system glslang/spirv")
+    target_compile_definitions(${PROJECT_NAME} PRIVATE USE_SYSTEM_SPIRV)
+    target_include_directories(${PROJECT_NAME} PRIVATE ${GLSLANG_INCLUDE_DIRS} ${SPIRV_INCLUDE_DIRS})
+    target_link_libraries(${PROJECT_NAME} PRIVATE ${GLSLANG_LIBRARIES} ${SPIRV_LIBRARIES})
+else()
 	add_subdirectory(core/deps/glslang)
 	target_link_libraries(${PROJECT_NAME} PRIVATE SPIRV)
 endif()
+endif()
 
 find_package(ALSA QUIET)
 if(ALSA_FOUND AND NOT ANDROID)
@@ -180,7 +204,6 @@ else()
     set(ZLIB_INCLUDE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/core/deps/zlib" "${CMAKE_CURRENT_BINARY_DIR}/core/deps/zlib")
 endif()
 
-find_package(PkgConfig QUIET)
 if(PKG_CONFIG_FOUND AND NOT ANDROID AND NOT APPLE)
     pkg_search_module(AO ao)
     if(AO_FOUND)
@@ -189,11 +212,13 @@ if(PKG_CONFIG_FOUND AND NOT ANDROID AND NOT APPLE)
         target_link_libraries(${PROJECT_NAME} PRIVATE ${AO_LIBRARIES})
     endif()
 
+    if(NOT USE_SYSTEM_CHDR)
     pkg_search_module(FLAC flac)
     if(FLAC_FOUND)
         target_include_directories(${PROJECT_NAME} PRIVATE ${FLAC_INCLUDE_DIRS})
         target_link_libraries(${PROJECT_NAME} PRIVATE ${FLAC_LIBRARIES})
     endif()
+    endif()
 
     pkg_search_module(LIBEVDEV libevdev)
     if(LIBEVDEV_FOUND)
@@ -270,6 +295,14 @@ target_sources(${PROJECT_NAME} PRIVATE
         core/deps/chdpsr/cdipsr.h)
 
 target_compile_definitions(${PROJECT_NAME} PRIVATE CHD5_FLAC CHD5_LZMA)
+
+if(USE_SYSTEM_CHDR)
+    pkg_search_module(CHDR REQUIRED libchdr)
+    message(STATUS "Using shared libchdr")
+    target_compile_definitions(${PROJECT_NAME} PRIVATE USE_SYSTEM_CHDR)
+    target_include_directories(${PROJECT_NAME} PRIVATE ${CHDR_INCLUDE_DIRS})
+    target_link_libraries(${PROJECT_NAME} PRIVATE ${CHDR_LIBRARIES})
+else()
 target_sources(${PROJECT_NAME} PRIVATE
         core/deps/chdr/bitstream.c
         core/deps/chdr/bitstream.h
@@ -282,7 +315,11 @@ target_sources(${PROJECT_NAME} PRIVATE
         core/deps/chdr/flac.h
         core/deps/chdr/huffman.c
         core/deps/chdr/huffman.h)
+endif()
+
+target_include_directories(${PROJECT_NAME} PRIVATE core/deps/nowide/include)
 
+if(NOT USE_SYSTEM_CHDR)
 target_sources(${PROJECT_NAME} PRIVATE
         core/deps/crypto/md5.cpp
         core/deps/crypto/md5.h
@@ -291,8 +328,6 @@ target_sources(${PROJECT_NAME} PRIVATE
         core/deps/crypto/sha256.cpp
         core/deps/crypto/sha256.h)
 
-target_include_directories(${PROJECT_NAME} PRIVATE core/deps/nowide/include)
-
 if(NOT FLAC_FOUND)
     target_compile_definitions(${PROJECT_NAME} PRIVATE HAVE_CONFIG_H $<$<BOOL:MINGW>:HAVE_FSEEKO>)
     target_include_directories(${PROJECT_NAME} PRIVATE core/deps/flac/include core/deps/flac/src/libFLAC/include)
@@ -319,6 +354,7 @@ if(NOT FLAC_FOUND)
             core/deps/flac/src/libFLAC/window.c
             core/deps/flac/src/libFLAC/windows_unicode_filenames.c)
 endif()
+endif()
 
 if(NOT MINIUPNP_FOUND)
 	option(UPNPC_BUILD_SHARED "Build shared library" OFF)
@@ -416,15 +452,37 @@ if(NOT MSVC)
             core/deps/picotcp/stack/pico_tree.c)
 endif()
 
+if(USE_SYSTEM_CHDR AND NOT USE_SYSTEM_LZMA)
+  message(STATUS "Shared chdr enabled without shared lzma, disabling 7zip support")
+  set_property(GLOBAL PROPERTY DISABLE_7ZIP 1)
+  target_compile_definitions(${PROJECT_NAME} PRIVATE DISABLE_7ZIP)
+endif()
+
+if (USE_SYSTEM_LZMA)
+  pkg_search_module(LZMA REQUIRED lzmasdk-c)
+  if(LZMA_FOUND)
+    message(STATUS "Using shared lzmasdk")
+    target_compile_definitions(${PROJECT_NAME} PRIVATE USE_SYSTEM_LZMA)
+    target_include_directories(${PROJECT_NAME} PRIVATE ${LZMA_INCLUDE_DIRS})
+    target_link_libraries(${PROJECT_NAME} PRIVATE ${LZMA_LIBRARIES})
+  endif()
+else()
+if(NOT DISABLE_7ZIP)
 target_compile_definitions(${PROJECT_NAME} PRIVATE _7ZIP_ST)
 target_sources(${PROJECT_NAME} PRIVATE core/deps/lzma/7zArcIn.c core/deps/lzma/7zBuf.c core/deps/lzma/7zCrc.c core/deps/lzma/7zCrcOpt.c core/deps/lzma/7zDec.c core/deps/lzma/7zFile.c core/deps/lzma/7zStream.c core/deps/lzma/Alloc.c core/deps/lzma/Bcj2.c core/deps/lzma/Bra86.c core/deps/lzma/Bra.c core/deps/lzma/BraIA64.c core/deps/lzma/CpuArch.c core/deps/lzma/Delta.c core/deps/lzma/LzFind.c core/deps/lzma/Lzma2Dec.c core/deps/lzma/Lzma86Dec.c core/deps/lzma/Lzma86Enc.c core/deps/lzma/LzmaDec.c core/deps/lzma/LzmaEnc.c core/deps/lzma/LzmaLib.c core/deps/lzma/Sort.c)
+endif()
+endif()
 target_sources(${PROJECT_NAME} PRIVATE core/deps/libelf/elf32.cpp core/deps/libelf/elf64.cpp core/deps/libelf/elf.cpp)
 target_sources(${PROJECT_NAME} PRIVATE core/deps/imgui/imgui.cpp core/deps/imgui/imgui_demo.cpp core/deps/imgui/imgui_draw.cpp core/deps/imgui/imgui_widgets.cpp)
 target_sources(${PROJECT_NAME} PRIVATE core/deps/xbrz/xbrz.cpp)
 
-target_sources(${PROJECT_NAME} PRIVATE
+if(NOT DISABLE_7ZIP)
+  target_sources(${PROJECT_NAME} PRIVATE
         core/archive/7zArchive.cpp
-        core/archive/7zArchive.h
+        core/archive/7zArchive.h)
+endif()
+
+target_sources(${PROJECT_NAME} PRIVATE
         core/archive/archive.cpp
         core/archive/archive.h
         core/archive/rzip.cpp
diff --git a/core/archive/7zArchive.cpp b/core/archive/7zArchive.cpp
index cb79196..04a645c 100644
--- a/core/archive/7zArchive.cpp
+++ b/core/archive/7zArchive.cpp
@@ -19,9 +19,16 @@
     along with reicast.  If not, see <https://www.gnu.org/licenses/>.
  */
 #include "7zArchive.h"
+
+#ifdef USE_SYSTEM_LZMA
+#include <7z.h>
+#include <7zCrc.h>
+#include <Alloc.h>
+#else
 #include "deps/lzma/7z.h"
 #include "deps/lzma/7zCrc.h"
 #include "deps/lzma/Alloc.h"
+#endif
 
 #define kInputBufSize ((size_t)1 << 18)
 
diff --git a/core/archive/7zArchive.h b/core/archive/7zArchive.h
index 1e6e9ba..fc8aca6 100644
--- a/core/archive/7zArchive.h
+++ b/core/archive/7zArchive.h
@@ -21,8 +21,13 @@
 #pragma once
 
 #include "archive.h"
+#ifdef USE_SYSTEM_LZMA
+#include <7z.h>
+#include <7zFile.h>
+#else
 #include "deps/lzma/7z.h"
 #include "deps/lzma/7zFile.h"
+#endif
 
 #include <algorithm>
 
diff --git a/core/archive/archive.cpp b/core/archive/archive.cpp
index 904839a..615011d 100644
--- a/core/archive/archive.cpp
+++ b/core/archive/archive.cpp
@@ -20,17 +20,21 @@
  */
 
 #include "archive.h"
+#ifndef DISABLE_7ZIP
 #include "7zArchive.h"
+#endif
 #include "ZipArchive.h"
 
 Archive *OpenArchive(const char *path)
 {
 	std::string base_path(path);
 
+#ifndef DISABLE_7ZIP
 	Archive *sz_archive = new SzArchive();
 	if (sz_archive->Open(base_path.c_str()) || sz_archive->Open((base_path + ".7z").c_str()) || sz_archive->Open((base_path + ".7Z").c_str()))
 		return sz_archive;
 	delete sz_archive;
+#endif
 
 	Archive *zip_archive = new ZipArchive();
 	if (zip_archive->Open(base_path.c_str()) || zip_archive->Open((base_path + ".zip").c_str()) || zip_archive->Open((base_path + ".ZIP").c_str()))
diff --git a/core/deps/chdr/chd.c b/core/deps/chdr/chd.c
index 3c04737..fe7592b 100644
--- a/core/deps/chdr/chd.c
+++ b/core/deps/chdr/chd.c
@@ -49,8 +49,13 @@
 #endif // CHD5_FLAC
 #include "huffman.h"
 #if defined(CHD5_LZMA)
+#ifdef USE_SYSTEM_LZMA
+	#include <LzmaEnc.h>
+	#include <LzmaDec.h>
+#else
 	#include "deps/lzma/LzmaEnc.h"
 	#include "deps/lzma/LzmaDec.h"
+#endif
 #endif // CHD5_LZMA
 #include "deps/crypto/md5.h"
 #include "deps/crypto/sha1.h"
diff --git a/core/imgread/chd.cpp b/core/imgread/chd.cpp
index b0b5481..527a335 100644
--- a/core/imgread/chd.cpp
+++ b/core/imgread/chd.cpp
@@ -1,6 +1,10 @@
 #include "common.h"
 
+#ifdef USE_SYSTEM_CHDR
+#include <chd.h>
+#else
 #include "deps/chdr/chd.h"
+#endif
 
 /* tracks are padded to a multiple of this many frames */
 const uint32_t CD_TRACK_PADDING = 4;
diff --git a/core/rend/vulkan/compiler.cpp b/core/rend/vulkan/compiler.cpp
index ea644b4..485ecd3 100644
--- a/core/rend/vulkan/compiler.cpp
+++ b/core/rend/vulkan/compiler.cpp
@@ -19,7 +19,11 @@
     along with Flycast.  If not, see <https://www.gnu.org/licenses/>.
 */
 #include "compiler.h"
+#ifdef USE_SYSTEM_SPIRV
+#include <glslang/SPIRV/GlslangToSpv.h>
+#else
 #include "SPIRV/GlslangToSpv.h"
+#endif
 #include "vulkan_context.h"
 
 static const TBuiltInResource DefaultTBuiltInResource = {
diff --git a/core/rend/vulkan/shaders.h b/core/rend/vulkan/shaders.h
index ddb7b78..92b184f 100644
--- a/core/rend/vulkan/shaders.h
+++ b/core/rend/vulkan/shaders.h
@@ -20,7 +20,11 @@
 */
 #pragma once
 #include "vulkan.h"
+#ifdef USE_SYSTEM_SPIRV
+#include <glslang/SPIRV/GlslangToSpv.h>
+#else
 #include "SPIRV/GlslangToSpv.h"
+#endif
 
 #include <glm/glm.hpp>
 #include <map>
-- 
2.29.2

