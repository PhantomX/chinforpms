From 4e5082cf64b15d10127ab53c7b0ebc3b38977d16 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Sun, 24 Apr 2022 23:38:23 -0300
Subject: [PATCH] downgrade libxl

---
 CMakeLists.txt         |  4 ++--
 appveyor.yml           |  2 +-
 src/qjpegxlhandler.cpp | 30 ++++++++++++------------------
 3 files changed, 15 insertions(+), 21 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 415efe9..93e1cd8 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -21,8 +21,8 @@ set(REQUIRED_QT_VERSION 5.14.0)
 find_package(Qt${QT_MAJOR_VERSION}Gui ${REQUIRED_QT_VERSION} REQUIRED NO_MODULE)
 
 include(FindPkgConfig)
-pkg_check_modules(LibJXL REQUIRED IMPORTED_TARGET libjxl>=0.7.0)
-pkg_check_modules(LibJXLThreads REQUIRED IMPORTED_TARGET libjxl_threads>=0.7.0)
+pkg_check_modules(LibJXL REQUIRED IMPORTED_TARGET libjxl>=0.6.1)
+pkg_check_modules(LibJXLThreads REQUIRED IMPORTED_TARGET libjxl_threads>=0.6.1)
 
 add_definitions(-DQT_DISABLE_DEPRECATED_BEFORE=0x050f02)
 add_definitions(-DKF_DISABLE_DEPRECATED_BEFORE_AND_AT=0x055900)
diff --git a/appveyor.yml b/appveyor.yml
index cffe660..783a086 100644
--- a/appveyor.yml
+++ b/appveyor.yml
@@ -6,7 +6,7 @@ install:
 - cmd: >-
     call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"
 
-    git clone --depth 1 https://github.com/libjxl/libjxl.git --recursive
+    git clone --depth 1 --branch v0.6.x https://github.com/libjxl/libjxl.git --recursive
 
     cd libjxl
 
diff --git a/src/qjpegxlhandler.cpp b/src/qjpegxlhandler.cpp
index 835ba4a..eba3321 100644
--- a/src/qjpegxlhandler.cpp
+++ b/src/qjpegxlhandler.cpp
@@ -479,21 +479,6 @@ bool QJpegXLHandler::write(const QImage &image)
         return false;
     }
 
-    if (m_quality > 100) {
-        m_quality = 100;
-    } else if (m_quality < 0) {
-        m_quality = 90;
-    }
-
-    JxlBasicInfo output_info;
-    JxlEncoderInitBasicInfo(&output_info);
-
-    if (save_depth == 16 && m_quality == 100) {
-        output_info.have_container = JXL_TRUE;
-        JxlEncoderUseContainer(encoder, JXL_TRUE);
-        JxlEncoderSetCodestreamLevel(encoder, 10);
-    }
-
     void *runner = nullptr;
     int num_worker_threads = qBound(1, QThread::idealThreadCount(), 64);
 
@@ -507,11 +492,20 @@ bool QJpegXLHandler::write(const QImage &image)
         }
     }
 
-    JxlEncoderFrameSettings *encoder_options = JxlEncoderFrameSettingsCreate(encoder, nullptr);
+    JxlEncoderOptions *encoder_options = JxlEncoderOptionsCreate(encoder, nullptr);
+
+    if (m_quality > 100) {
+        m_quality = 100;
+    } else if (m_quality < 0) {
+        m_quality = 90;
+    }
+
+    JxlEncoderOptionsSetDistance(encoder_options, (100.0f - m_quality) / 10.0f);
 
-    JxlEncoderSetFrameDistance(encoder_options, (100.0f - m_quality) / 10.0f);
+    JxlEncoderOptionsSetLossless(encoder_options, (m_quality == 100) ? JXL_TRUE : JXL_FALSE);
 
-    JxlEncoderSetFrameLossless(encoder_options, (m_quality == 100) ? JXL_TRUE : JXL_FALSE);
+    JxlBasicInfo output_info;
+    JxlEncoderInitBasicInfo(&output_info);
 
     JxlColorEncoding color_profile;
     JxlColorEncodingSetToSRGB(&color_profile, JXL_FALSE);
-- 
2.36.0

