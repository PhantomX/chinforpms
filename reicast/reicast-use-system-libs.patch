From 0ab9a277928d55a3d7720428782f5da23633220d Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Thu, 15 Aug 2019 20:59:34 -0300
Subject: [PATCH] Use system libs

---
 libswirl/archive/ZipArchive.h        |  4 +++
 libswirl/core.mk                     | 26 ++++++++++++++++---
 libswirl/deps/chdr/chd.c             |  4 +++
 libswirl/deps/chdr/flac.h            |  4 +++
 libswirl/hw/maple/maple_devs.cpp     |  8 ++++++
 libswirl/hw/pvr/Renderer_if.cpp      |  4 +++
 libswirl/reios/reios_elf.cpp         |  2 +-
 libswirl/rend/TexCache.cpp           |  4 +++
 libswirl/rend/gles/CustomTexture.cpp |  4 +++
 libswirl/rend/gles/glesrend.cpp      |  7 +++--
 libswirl/rend/gles/glestex.cpp       |  8 ++++++
 libswirl/scripting/lua_bindings.h    |  4 +++
 reicast/linux/Makefile               | 39 ++++++++++++++++++++++++++++
 13 files changed, 112 insertions(+), 6 deletions(-)

diff --git a/libswirl/archive/ZipArchive.h b/libswirl/archive/ZipArchive.h
index 05a0f0f..ff24960 100644
--- a/libswirl/archive/ZipArchive.h
+++ b/libswirl/archive/ZipArchive.h
@@ -22,7 +22,11 @@
 #ifndef CORE_ARCHIVE_ZIPARCHIVE_H_
 #define CORE_ARCHIVE_ZIPARCHIVE_H_
 #include "archive.h"
+#ifdef SYSTEM_LIBZIP
+#include <zip.h>
+#else
 #include "deps/libzip/zip.h"
+#endif
 
 class ZipArchive : public Archive
 {
diff --git a/libswirl/core.mk b/libswirl/core.mk
index 140df97..8cc4f43 100644
--- a/libswirl/core.mk
+++ b/libswirl/core.mk
@@ -9,14 +9,32 @@ VERSION_HEADER := $(RZDCY_SRC_DIR)/version.h
 
 RZDCY_MODULES	:=	cfg/ hw/arm7/ hw/aica/ hw/holly/ hw/ hw/gdrom/ hw/maple/ \
  hw/mem/ hw/pvr/ hw/sh4/ hw/sh4/interpr/ hw/sh4/modules/ plugins/ profiler/ oslib/ \
- hw/extdev/ hw/arm/ hw/naomi/ imgread/ ./ deps/coreio/ deps/zlib/ deps/chdr/ deps/crypto/ \
- deps/libelf/ deps/cdipsr/ arm_emitter/ rend/ reios/ deps/libpng/ deps/xbrz/ \
- deps/xxhash/ deps/libzip/ deps/imgui/ archive/ input/ utils/ utils/glwrap/ gui/
+ hw/extdev/ hw/arm/ hw/naomi/ imgread/ ./ deps/coreio/ deps/chdr/ deps/crypto/ \
+ deps/libelf/ deps/cdipsr/ arm_emitter/ rend/ reios/ deps/xbrz/ \
+ deps/imgui/ archive/ input/ utils/ utils/glwrap/ gui/
+
+ifndef SYSTEM_LIBPNG
+RZDCY_MODULES += deps/libpng/
+endif
+
+ifndef SYSTEM_LIBZIP
+RZDCY_MODULES +=  deps/libzip/
+endif
+
+ifndef SYSTEM_XXHASH
+RZDCY_MODULES +=   deps/xxhash/
+endif
+
+ifndef SYSTEM_ZLIB
+RZDCY_MODULES +=  deps/zlib/
+endif
 
 ifdef SCRIPTING
 	RZDCY_MODULES += scripting/
+ifndef SYSTEM_LUA
 	RZDCY_MODULES += deps/lua/
 endif
+endif
 
 ifdef _NO_WEBUI
 	RZDCY_MODULES += webui/
@@ -123,10 +141,12 @@ else
 endif
 
 ifdef CHD5_FLAC
+ifndef SYSTEM_FLAC
 	RZDCY_CFLAGS += -DCHD5_FLAC -I$(RZDCY_SRC_DIR)/deps/flac/src/libFLAC/include/ -I$(RZDCY_SRC_DIR)/deps/flac/include
 	RZDCY_CFLAGS += -DPACKAGE_VERSION=\"1.3.2\" -DFLAC__HAS_OGG=0 -DFLAC__NO_DLL -DHAVE_LROUND -DHAVE_STDINT_H -DHAVE_STDLIB_H -DHAVE_SYS_PARAM_H
 	RZDCY_MODULES += deps/flac/src/libFLAC/
 endif
+endif
 
 # 7-Zip/LZMA settings (CHDv5)
 ifdef CHD5_LZMA
diff --git a/libswirl/deps/chdr/chd.c b/libswirl/deps/chdr/chd.c
index 4461bdf..05a64aa 100644
--- a/libswirl/deps/chdr/chd.c
+++ b/libswirl/deps/chdr/chd.c
@@ -54,7 +54,11 @@
 #endif // CHD5_LZMA
 #include "deps/crypto/md5.h"
 #include "deps/crypto/sha1.h"
+#ifdef SYSTEM_ZLIB
+#include <zlib.h>
+#else
 #include "deps/zlib/zlib.h"
+#endif
 
 #define TRUE 1
 #define FALSE 0
diff --git a/libswirl/deps/chdr/flac.h b/libswirl/deps/chdr/flac.h
index 3de00eb..6f51ffa 100644
--- a/libswirl/deps/chdr/flac.h
+++ b/libswirl/deps/chdr/flac.h
@@ -14,7 +14,11 @@
 #define __FLAC_H__
 
 #include <stdint.h>
+#ifdef SYSTEM_FLAC
+#include <FLAC/all.h>
+#else
 #include "deps/flac/include/FLAC/all.h"
+#endif
 
 /***************************************************************************
  *  TYPE DEFINITIONS
diff --git a/libswirl/hw/maple/maple_devs.cpp b/libswirl/hw/maple/maple_devs.cpp
index f506c66..7128805 100644
--- a/libswirl/hw/maple/maple_devs.cpp
+++ b/libswirl/hw/maple/maple_devs.cpp
@@ -10,8 +10,16 @@
 #include "input/gamepad.h"
 #include <time.h>
 
+#ifdef SYSTEM_ZLIB
+#include <zlib.h>
+#else
 #include "deps/zlib/zlib.h"
+#endif
+#ifdef SYSTEM_XXHASH
+#include <xxhash.h>
+#else
 #include "deps/xxhash/xxhash.h"
+#endif
 
 #if _ANDROID
 #include <android/log.h>
diff --git a/libswirl/hw/pvr/Renderer_if.cpp b/libswirl/hw/pvr/Renderer_if.cpp
index 073e62d..a8becb0 100644
--- a/libswirl/hw/pvr/Renderer_if.cpp
+++ b/libswirl/hw/pvr/Renderer_if.cpp
@@ -4,7 +4,11 @@
 #include "rend/TexCache.h"
 #include "gui/gui.h"
 
+#ifdef SYSTEM_ZLIB
+#include <zlib.h>
+#else
 #include "deps/zlib/zlib.h"
+#endif
 
 #include "deps/crypto/md5.h"
 
diff --git a/libswirl/reios/reios_elf.cpp b/libswirl/reios/reios_elf.cpp
index ff17c93..9d688dd 100644
--- a/libswirl/reios/reios_elf.cpp
+++ b/libswirl/reios/reios_elf.cpp
@@ -54,4 +54,4 @@ bool reios_loadElf(const string& elf) {
 	}
 
 	return true;
-}
\ No newline at end of file
+}
diff --git a/libswirl/rend/TexCache.cpp b/libswirl/rend/TexCache.cpp
index 7a81e89..896bdd1 100644
--- a/libswirl/rend/TexCache.cpp
+++ b/libswirl/rend/TexCache.cpp
@@ -9,7 +9,11 @@
 #include "hw/pvr/pvr_regs.h"
 #include "hw/mem/_vmem.h"
 #include "deps/xbrz/xbrz.h"
+#ifdef SYSTEM_XXHASH
+#include <xxhash.h>
+#else
 #include "deps/xxhash/xxhash.h"
+#endif
 
 u8* vq_codebook;
 u32 palette_index;
diff --git a/libswirl/rend/gles/CustomTexture.cpp b/libswirl/rend/gles/CustomTexture.cpp
index e5f4209..3baecbb 100644
--- a/libswirl/rend/gles/CustomTexture.cpp
+++ b/libswirl/rend/gles/CustomTexture.cpp
@@ -28,7 +28,11 @@
 #include <dirent.h>
 #endif
 
+#ifdef SYSTEM_LIBPNG
+#include <png.h>
+#else
 #include "deps/libpng/png.h"
+#endif
 #include "reios/reios.h"
 
 #include "scripting/lua_bindings.h"
diff --git a/libswirl/rend/gles/glesrend.cpp b/libswirl/rend/gles/glesrend.cpp
index cff920e..31d080a 100644
--- a/libswirl/rend/gles/glesrend.cpp
+++ b/libswirl/rend/gles/glesrend.cpp
@@ -1621,8 +1621,11 @@ struct glesrend : Renderer
 	}
 };
 
-
+#ifdef SYSTEM_LIBPNG
+#include <png.h>
+#else
 #include "deps/libpng/png.h"
+#endif
 
 FILE* pngfile;
 
@@ -1783,4 +1786,4 @@ GLuint loadPNG(const string& fname, int &width, int &height)
 
 #include "hw/pvr/Renderer_if.h"
 
-static auto gles2rend = RegisterRendererBackend(rendererbackend_t{ "gles", "OpenGL ES 2/PC41 (Per Triangle Sort)", 1, []() { return (Renderer*) new glesrend(); } });
\ No newline at end of file
+static auto gles2rend = RegisterRendererBackend(rendererbackend_t{ "gles", "OpenGL ES 2/PC41 (Per Triangle Sort)", 1, []() { return (Renderer*) new glesrend(); } });
diff --git a/libswirl/rend/gles/glestex.cpp b/libswirl/rend/gles/glestex.cpp
index 1a3802f..d21bf02 100644
--- a/libswirl/rend/gles/glestex.cpp
+++ b/libswirl/rend/gles/glestex.cpp
@@ -3,8 +3,16 @@
 #include "rend/TexCache.h"
 #include "hw/pvr/pvr_mem.h"
 #include "hw/mem/_vmem.h"
+#ifdef SYSTEM_LIBPNG
+#include <png.h>
+#else
 #include "deps/libpng/png.h"
+#endif
+#ifdef SYSTEM_XXHASH
+#include <xxhash.h>
+#else
 #include "deps/xxhash/xxhash.h"
+#endif
 #include "CustomTexture.h"
 
 /*
diff --git a/libswirl/scripting/lua_bindings.h b/libswirl/scripting/lua_bindings.h
index e2f3366..ca6eebd 100644
--- a/libswirl/scripting/lua_bindings.h
+++ b/libswirl/scripting/lua_bindings.h
@@ -1,6 +1,10 @@
 #pragma once
 
+#ifdef SYSTEM_LUA
+#include <lua.hpp>
+#else
 #include "lua/lua.hpp"
+#endif
 #include <string>
 
 void emulib_expose(lua_State* L);
diff --git a/reicast/linux/Makefile b/reicast/linux/Makefile
index d74af07..f5c3ae8 100644
--- a/reicast/linux/Makefile
+++ b/reicast/linux/Makefile
@@ -12,6 +12,13 @@ USE_MODEM := 1
 PLATFORM_EXT := elf
 SCRIPTING := 1
 
+SYSTEM_FLAC := 1
+SYSTEM_LIBPNG := 1
+SYSTEM_LIBZIP := 1
+SYSTEM_LUA := 1
+SYSTEM_XXHASH := 1
+SYSTEM_ZLIB := 1d
+
 CXX=${CC_PREFIX}g++
 CC=${CC_PREFIX}gcc
 AS=${CC_PREFIX}gcc
@@ -201,6 +208,38 @@ ifdef LTO_TEST
     LDFLAGS +=-flto -fwhole-program
 endif
 
+ifdef SYSTEM_FLAC
+    CFLAGS += `pkg-config --cflags flac` -D SYSTEM_FLAC
+    CXXFLAGS += `pkg-config --cflags flac` -D SYSTEM_FLAC
+    LIBS += `pkg-config --libs flac`
+endif
+
+ifdef SYSTEM_LIBPNG
+    CXXFLAGS += `pkg-config --cflags libpng` -D SYSTEM_LIBPNG
+    LIBS += `pkg-config --libs libpng`
+endif
+
+ifdef SYSTEM_LIBZIP
+    CXXFLAGS += `pkg-config --cflags libzip` -D SYSTEM_LIBZIP
+    LIBS += `pkg-config --libs libzip`
+endif
+
+ifdef SYSTEM_LUA
+    CXXFLAGS += `pkg-config --cflags lua` -D SYSTEM_LUA
+    LIBS += `pkg-config --libs lua`
+endif
+
+ifdef SYSTEM_XXHASH
+    CXXFLAGS += -D SYSTEM_XXHASH
+    LIBS += -lxxhash
+endif
+
+ifdef SYSTEM_ZLIB
+    CFLAGS += `pkg-config --cflags zlib` -D SYSTEM_ZLIB
+    CXXFLAGS += `pkg-config --cflags zlib` -D SYSTEM_ZLIB
+    LIBS += `pkg-config --libs zlib`
+endif
+
 # executable name configuration
 EXECUTABLE_STRIPPED=nosym-reicast.$(PLATFORM_EXT)
 ifdef NAOMI
-- 
2.21.0

