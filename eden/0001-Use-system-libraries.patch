From 4f7d6a81912efa3cfa271c7d847bdb8356f6b5c0 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Tue, 9 Sep 2025 18:48:43 -0300
Subject: [PATCH] Use system libraries

---
 CMakeLists.txt                        | 21 +++++++++-
 externals/CMakeLists.txt              | 60 +++++++++++++++++++++++++++
 externals/ffmpeg/CMakeLists.txt       |  5 +++
 externals/nx_tzdb/CMakeLists.txt      |  2 +-
 src/dynarmic/CMakeLists.txt           |  6 +--
 src/dynarmic/externals/CMakeLists.txt | 20 +++++++++
 src/yuzu/externals/CMakeLists.txt     | 11 +++++
 7 files changed, 119 insertions(+), 6 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 144e776..232c0d7 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -117,7 +117,6 @@ endif()
 
 set(CPM_SOURCE_CACHE ${CMAKE_SOURCE_DIR}/.cache/cpm)
 
-include(DownloadExternals)
 include(CMakeDependentOption)
 include(CTest)
 
@@ -455,7 +454,7 @@ if (YUZU_USE_CPM)
     endif()
 else()
     # Enforce the search mode of non-required packages for better and shorter failure messages
-    find_package(fmt 8 REQUIRED)
+    find_package(fmt 8)
     find_package(LLVM MODULE COMPONENTS Demangle)
     find_package(nlohmann_json 3.8 REQUIRED)
     find_package(lz4 REQUIRED)
@@ -466,6 +465,12 @@ else()
     find_package(ZLIB 1.2 REQUIRED)
     find_package(zstd 1.5 REQUIRED MODULE)
 
+    if(fmt_FOUND)
+        message(STATUS "Using the system fmt")
+    else()
+        add_subdirectory("externals/fmt" EXCLUDE_FROM_ALL)
+    endif()
+
     if (YUZU_TESTS)
         find_package(Catch2 3.0.1 REQUIRED)
     endif()
@@ -480,7 +485,11 @@ else()
 endif()
 
 if(NOT TARGET Boost::headers)
+  if (YUZU_USE_CPM)
     AddJsonPackage(boost_headers)
+  else()
+    add_subdirectory(externals/boost-headers)
+  endif()
 endif()
 
 # DiscordRPC
@@ -496,10 +505,15 @@ if (USE_DISCORD_PRESENCE)
 endif()
 
 # SimpleIni
+if (YUZU_USE_CPM)
 AddJsonPackage(simpleini)
+else()
+    add_subdirectory(externals/simpleini)
+endif()
 
 # Most linux distros don't package cubeb, so enable regardless of cpm settings
 if(ENABLE_CUBEB)
+  if (YUZU_USE_CPM)
     AddJsonPackage(cubeb)
 
     if (cubeb_ADDED)
@@ -523,6 +537,9 @@ if(ENABLE_CUBEB)
             )
         endif()
     endif()
+  else()
+    find_package(cubeb CONFIG)
+  endif()
 endif()
 
 # find SDL2 exports a bunch of variables that are needed, so its easier to do this outside of the YUZU_find_package
diff --git a/externals/CMakeLists.txt b/externals/CMakeLists.txt
index 9f89cfc..1ebf50b 100644
--- a/externals/CMakeLists.txt
+++ b/externals/CMakeLists.txt
@@ -34,11 +34,18 @@ endif()
 
 # Xbyak (also used by Dynarmic, so needs to be added first)
 if (ARCHITECTURE_x86 OR ARCHITECTURE_x86_64)
+  if (YUZU_USE_CPM)
     if (PLATFORM_SUN OR PLATFORM_OPENBSD)
         AddJsonPackage(xbyak_sun)
     else()
         AddJsonPackage(xbyak)
     endif()
+  else()
+    find_package(xbyak 7 CONFIG GLOBAL)
+    if (NOT TARGET xbyak::xbyak)
+      add_subdirectory(xbyak)
+    endif()
+  endif()
 endif()
 
 # Oaknut (also used by Dynarmic, so needs to be added first)
@@ -55,8 +62,20 @@ endif()
 add_subdirectory(glad)
 
 # mbedtls
+if (YUZU_USE_CPM)
 AddJsonPackage(mbedtls)
 
+else()
+  find_package(mbedtls GLOBAL)
+  if(mbedtls_FOUND)
+      message(STATUS "Using the system mbed TLS")
+  else()
+      set(mbedtls_SOURCE_DIR ${PROJECT_SOURCE_DIR}/externals/mbedtls)
+      add_subdirectory(mbedtls)
+      set(mbedtls_ADDED ON)
+  endif()
+endif()
+
 if (mbedtls_ADDED)
     target_include_directories(mbedtls PUBLIC ${mbedtls_SOURCE_DIR}/include)
 
@@ -75,16 +94,27 @@ if (mbedtls_ADDED)
 endif()
 
 # libusb
+if (YUZU_USE_CPM)
 if (ENABLE_LIBUSB)
     add_subdirectory(libusb)
 endif()
+endif()
 
 # Sirit
 # TODO(crueter): spirv-tools doesn't work w/ system
+if (YUZU_USE_CPM)
 set(SPIRV_WERROR OFF)
 AddJsonPackage(spirv-headers)
+else()
+  find_package(SPIRV-Headers GLOBAL)
+endif()
 
+if (YUZU_USE_CPM)
 AddJsonPackage(sirit)
+else()
+  set(SIRIT_USE_SYSTEM_SPIRV_HEADERS ON)
+  add_subdirectory(sirit)
+endif()
 
 if(MSVC AND USE_CCACHE AND sirit_ADDED)
     get_target_property(_opts sirit COMPILE_OPTIONS)
@@ -97,16 +127,40 @@ endif()
 
 # httplib
 if (ENABLE_WEB_SERVICE OR ENABLE_QT_UPDATE_CHECKER)
+  if (YUZU_USE_CPM)
     AddJsonPackage(httplib)
+  else()
+    if (NOT TARGET httplib::httplib)
+      set(HTTPLIB_REQUIRE_OPENSSL ${ENABLE_OPENSSL})
+      add_subdirectory(cpp-httplib)
+    endif()
+  endif()
 endif()
 
 # cpp-jwt
 if (ENABLE_WEB_SERVICE)
+  if (YUZU_USE_CPM)
     AddJsonPackage(cpp-jwt)
+  else()
+    if (NOT TARGET cpp-jwt::cpp-jwt)
+      set(CPP_JWT_BUILD_EXAMPLES OFF)
+      set(CPP_JWT_BUILD_TESTS OFF)
+      set(CPP_JWT_USE_VENDORED_NLOHMANN_JSON OFF)
+      add_subdirectory(cpp-jwt)
+    endif()
+  endif()
 endif()
 
 # unordered_dense
+if (YUZU_USE_CPM)
 AddJsonPackage(unordered-dense)
+else()
+  find_package(unordered_dense CONFIG)
+  if (NOT TARGET ankerl::unordered_dense)
+      set(UNORDERED_DENSE_INSTALL OFF)
+      add_subdirectory(unordered-dense)
+  endif()
+endif()
 
 # FFMpeg
 if (YUZU_USE_BUNDLED_FFMPEG)
@@ -118,10 +172,12 @@ if (YUZU_USE_BUNDLED_FFMPEG)
 endif()
 
 # VulkanUtilityHeaders - pulls in headers and utility libs
+if (YUZU_USE_CPM)
 AddJsonPackage(
     NAME vulkan-utility-headers
     BUNDLED_PACKAGE ${YUZU_USE_EXTERNAL_VULKAN_UTILITY_LIBRARIES}
 )
+endif()
 
 # small hack
 if (NOT VulkanUtilityLibraries_ADDED)
@@ -129,6 +185,7 @@ if (NOT VulkanUtilityLibraries_ADDED)
 endif()
 
 # SPIRV Tools
+if (YUZU_USE_CPM)
 AddJsonPackage(
     NAME spirv-tools
     BUNDLED_PACKAGE ${YUZU_USE_EXTERNAL_VULKAN_SPIRV_TOOLS}
@@ -138,12 +195,15 @@ if (SPIRV-Tools_ADDED)
     add_library(SPIRV-Tools::SPIRV-Tools ALIAS SPIRV-Tools-static)
     target_link_libraries(SPIRV-Tools-static PRIVATE SPIRV-Tools-opt SPIRV-Tools-link)
 endif()
+endif()
 
 # TZDB (Time Zone Database)
 add_subdirectory(nx_tzdb)
 
 # VMA
+if (YUZU_USE_CPM)
 AddJsonPackage(vulkan-memory-allocator)
+endif()
 
 if (VulkanMemoryAllocator_ADDED)
     if (CXX_CLANG)
diff --git a/externals/ffmpeg/CMakeLists.txt b/externals/ffmpeg/CMakeLists.txt
index 8908aa2..7064abc 100644
--- a/externals/ffmpeg/CMakeLists.txt
+++ b/externals/ffmpeg/CMakeLists.txt
@@ -21,10 +21,15 @@ if (NOT WIN32 AND NOT ANDROID)
         message(FATAL_ERROR "Required program `autoconf` not found.")
     endif()
 
+  if (YUZU_USE_CPM)
     AddJsonPackage(ffmpeg)
 
     set(FFmpeg_PREFIX ${ffmpeg_SOURCE_DIR})
     set(FFmpeg_BUILD_DIR ${ffmpeg_BINARY_DIR})
+    else()
+      set(FFmpeg_PREFIX ${PROJECT_SOURCE_DIR}/externals/ffmpeg/ffmpeg)
+      set(FFmpeg_BUILD_DIR ${PROJECT_BINARY_DIR}/externals/ffmpeg-build)
+    endif()
     set(FFmpeg_MAKEFILE ${FFmpeg_BUILD_DIR}/Makefile)
     make_directory(${FFmpeg_BUILD_DIR})
 
diff --git a/externals/nx_tzdb/CMakeLists.txt b/externals/nx_tzdb/CMakeLists.txt
index 242e1e1..57da455 100644
--- a/externals/nx_tzdb/CMakeLists.txt
+++ b/externals/nx_tzdb/CMakeLists.txt
@@ -58,7 +58,7 @@ if (MSVC)
             ${NX_TZDB_ARCHIVE}
         DESTINATION
             ${NX_TZDB_BASE_DIR})
-else()
+elseif (CAN_BUILD_NX_TZDB AND YUZU_DOWNLOAD_TIME_ZONE_DATA)
     message(STATUS "Downloading time zone data...")
     AddJsonPackage(tzdb)
 
diff --git a/src/dynarmic/CMakeLists.txt b/src/dynarmic/CMakeLists.txt
index 38457de..21a0d82 100644
--- a/src/dynarmic/CMakeLists.txt
+++ b/src/dynarmic/CMakeLists.txt
@@ -156,7 +156,7 @@ find_package(fmt 9 CONFIG)
 # Pull in externals CMakeLists for libs where available
 add_subdirectory(externals)
 
-find_package(mcl 0.1.12 REQUIRED)
+find_package(mcl 0.1.12)
 
 if ("arm64" IN_LIST ARCHITECTURE OR DYNARMIC_TESTS)
     find_package(oaknut 2.0.1 CONFIG)
@@ -168,8 +168,8 @@ endif()
 
 if ("x86_64" IN_LIST ARCHITECTURE)
     find_package(xbyak 7 CONFIG)
-    find_package(zycore REQUIRED)
-    find_package(zydis 4 REQUIRED)
+    find_package(zycore)
+    find_package(zydis 4)
 endif()
 
 if (DYNARMIC_USE_LLVM)
diff --git a/src/dynarmic/externals/CMakeLists.txt b/src/dynarmic/externals/CMakeLists.txt
index ea666dd..e727d08 100644
--- a/src/dynarmic/externals/CMakeLists.txt
+++ b/src/dynarmic/externals/CMakeLists.txt
@@ -28,14 +28,22 @@ if ("riscv" IN_LIST ARCHITECTURE)
 endif()
 
 # mcl
+if (YUZU_USE_CPM)
 AddJsonPackage(
     NAME mcl
     BUNDLED_PACKAGE ${DYNARMIC_USE_BUNDLED_EXTERNALS}
 )
+else()
+  if (NOT TARGET merry::mcl)
+      set(MCL_INSTALL OFF)
+      add_subdirectory(mcl)
+  endif()
+endif()
 
 # TODO(crueter): maybe it's just Gentoo but zydis system package really sucks
 if ("x86_64" IN_LIST ARCHITECTURE)
     set(CMAKE_DISABLE_FIND_PACKAGE_Doxygen ON)
+  if (YUZU_USE_CPM)
     AddJsonPackage(
         NAME zycore
         BUNDLED_PACKAGE ${DYNARMIC_USE_BUNDLED_EXTERNALS}
@@ -45,4 +53,16 @@ if ("x86_64" IN_LIST ARCHITECTURE)
         NAME zydis
         BUNDLED_PACKAGE ${DYNARMIC_USE_BUNDLED_EXTERNALS}
     )
+  else()
+    if (NOT TARGET Zydis::Zydis)
+        set(ZYDIS_BUILD_TOOLS OFF)
+        set(ZYDIS_BUILD_EXAMPLES OFF)
+        set(ZYDIS_BUILD_DOXYGEN OFF)
+        set(ZYAN_ZYCORE_PATH "${CMAKE_CURRENT_LIST_DIR}/zycore-c" CACHE PATH "")
+        set(CMAKE_DISABLE_FIND_PACKAGE_Doxygen ON)
+        if (NOT TARGET Zydis)
+            add_subdirectory(zydis)
+        endif()
+    endif()
+  endif()
 endif()
diff --git a/src/yuzu/externals/CMakeLists.txt b/src/yuzu/externals/CMakeLists.txt
index 50594a7..015c9ac 100644
--- a/src/yuzu/externals/CMakeLists.txt
+++ b/src/yuzu/externals/CMakeLists.txt
@@ -13,4 +13,15 @@ set(BUILD_SHARED_LIBS OFF)
 set_directory_properties(PROPERTIES EXCLUDE_FROM_ALL ON)
 
 # QuaZip
+if (YUZU_USE_CPM)
 AddJsonPackage(quazip)
+else()
+  find_package(PkgConfig REQUIRED)
+  pkg_check_modules(quazip IMPORTED_TARGET quazip1-qt6)
+  if (TARGET PkgConfig::quazip)
+    message(STATUS "Using the system Quazip")
+    add_library(quazip INTERFACE)
+    target_link_libraries(quazip INTERFACE PkgConfig::quazip)
+    add_library(QuaZip::QuaZip ALIAS quazip)
+  endif()
+endif()
-- 
2.51.0

