From 74dcf41569996137e9580dffede3fff4b0e0b860 Mon Sep 17 00:00:00 2001
From: Phantom X <PhantomX@users.noreply.github.com>
Date: Tue, 9 Sep 2025 18:48:43 -0300
Subject: [PATCH] Use system libraries

---
 CMakeLists.txt                   | 45 ++++++++++++++++++++++++--
 externals/CMakeLists.txt         | 55 ++++++++++++++++++++++++++++++++
 externals/ffmpeg/CMakeLists.txt  |  5 +++
 externals/nx_tzdb/CMakeLists.txt |  2 +-
 src/dynarmic/CMakeLists.txt      |  8 -----
 5 files changed, 104 insertions(+), 11 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 0568a49..55f4793 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -492,7 +492,7 @@ if (YUZU_USE_CPM)
 else()
     # TODO: we can probably just use CPM for this... right?
     # Enforce the search mode of non-required packages for better and shorter failure messages
-    find_package(fmt 8 REQUIRED)
+    find_package(fmt 8)
 
     if (NOT YUZU_DISABLE_LLVM)
         find_package(LLVM MODULE COMPONENTS Demangle)
@@ -517,7 +517,11 @@ else()
 endif()
 
 if(NOT TARGET Boost::headers)
+  if (YUZU_USE_CPM)
     AddJsonPackage(boost_headers)
+  else()
+    add_subdirectory(externals/boost-headers)
+  endif()
 endif()
 
 # List of all FFmpeg components required
@@ -576,7 +580,7 @@ add_subdirectory(externals)
 # pass targets from externals
 find_package(enet)
 find_package(MbedTLS)
-find_package(unordered_dense REQUIRED)
+find_package(unordered_dense)
 
 if (ARCHITECTURE_x86 OR ARCHITECTURE_x86_64)
     find_package(xbyak)
@@ -586,6 +590,7 @@ if (NOT YUZU_STATIC_ROOM)
     find_package(libusb)
     find_package(VulkanMemoryAllocator)
     find_package(VulkanUtilityLibraries)
+    find_package(VulkanHeaders 1.4.317 REQUIRED)
     find_package(SimpleIni)
     find_package(SPIRV-Tools)
     find_package(sirit)
@@ -593,6 +598,31 @@ if (NOT YUZU_STATIC_ROOM)
     find_package(mcl)
     find_package(frozen)
 
+    if(fmt_FOUND)
+        message(STATUS "Using the system fmt")
+    else()
+        add_subdirectory("externals/fmt" EXCLUDE_FROM_ALL)
+    endif()
+
+    if (NOT YUZU_USE_CPM)
+        if(MbedTLS_FOUND)
+            message(STATUS "Using the system mbed TLS")
+        else()
+            set(ENABLE_PROGRAMS OFF)
+            set(DISABLE_PACKAGE_CONFIG_AND_INSTALL ON)
+            set(mbedtls_SOURCE_DIR ${PROJECT_SOURCE_DIR}/externals/mbedtls)
+            add_subdirectory(externals/mbedtls)
+            set(mbedtls_ADDED ON)
+        endif()
+    endif()
+
+    if(unordered_dense_FOUND)
+        message(STATUS "Using the system unordered_dense")
+    else()
+        set(UNORDERED_DENSE_INSTALL OFF)
+        add_subdirectory(externals/unordered-dense)
+    endif()
+
     if (ARCHITECTURE_riscv64)
         find_package(biscuit)
     endif()
@@ -702,7 +732,18 @@ if (ENABLE_QT)
     ## Qt Externals ##
 
     # QuaZip
+    if (YUZU_USE_CPM)
     AddJsonPackage(quazip)
+    else()
+      find_package(PkgConfig REQUIRED)
+      pkg_check_modules(quazip IMPORTED_TARGET quazip1-qt6)
+      if (TARGET PkgConfig::quazip)
+        message(STATUS "Using the system Quazip")
+        add_library(quazip INTERFACE)
+        target_link_libraries(quazip INTERFACE PkgConfig::quazip)
+        add_library(QuaZip::QuaZip ALIAS quazip)
+      endif()
+    endif()
 endif()
 
 if (NOT YUZU_STATIC_ROOM AND NOT (YUZU_USE_BUNDLED_FFMPEG OR YUZU_USE_EXTERNAL_FFMPEG))
diff --git a/externals/CMakeLists.txt b/externals/CMakeLists.txt
index 6c3e5cb..3112f57 100644
--- a/externals/CMakeLists.txt
+++ b/externals/CMakeLists.txt
@@ -27,10 +27,18 @@ set_directory_properties(PROPERTIES EXCLUDE_FROM_ALL ON)
 
 # Xbyak
 if (ARCHITECTURE_x86 OR ARCHITECTURE_x86_64)
+  if (YUZU_USE_CPM)
     AddJsonPackage(xbyak)
+  else()
+    find_package(xbyak 7 CONFIG GLOBAL)
+    if (NOT TARGET xbyak::xbyak)
+      add_subdirectory(xbyak)
+    endif()
+  endif()
 endif()
 
 # enet
+if (YUZU_USE_CPM)
 AddJsonPackage(enet)
 
 if (enet_ADDED)
@@ -40,9 +48,12 @@ endif()
 if (NOT TARGET enet::enet)
     add_library(enet::enet ALIAS enet)
 endif()
+endif()
 
 # mbedtls
+if (YUZU_USE_CPM)
 AddJsonPackage(mbedtls)
+endif()
 
 # stb
 add_library(stb stb/stb_dxt.cpp)
@@ -63,7 +74,9 @@ if (NOT TARGET LLVM::Demangle)
 endif()
 
 # unordered_dense
+if (YUZU_USE_CPM)
 AddJsonPackage(unordered-dense)
+endif()
 
 if (YUZU_STATIC_ROOM)
     return()
@@ -80,13 +93,19 @@ if (ARCHITECTURE_riscv64)
 endif()
 
 # mcl
+if (YUZU_USE_CPM)
 AddJsonPackage(mcl)
+endif()
 
 # Vulkan stuff
+if (YUZU_USE_CPM)
 AddDependentPackages(vulkan-headers vulkan-utility-libraries)
+endif()
 
 # frozen
+if (YUZU_USE_CPM)
 AddJsonPackage(frozen)
+endif()
 
 # DiscordRPC
 if (USE_DISCORD_PRESENCE)
@@ -103,10 +122,15 @@ if (USE_DISCORD_PRESENCE)
 endif()
 
 # SimpleIni
+if (YUZU_USE_CPM)
 AddJsonPackage(simpleini)
+else()
+  add_subdirectory(simpleini)
+endif()
 
 # Most linux distros don't package cubeb, so enable regardless of cpm settings
 if(ENABLE_CUBEB)
+  if (YUZU_USE_CPM)
     AddJsonPackage(cubeb)
 
     if (cubeb_ADDED)
@@ -135,6 +159,7 @@ if(ENABLE_CUBEB)
         add_library(cubeb::cubeb ALIAS cubeb)
     endif()
 endif()
+endif()
 
 # find SDL2 exports a bunch of variables that are needed, so its easier to do this outside of the YUZU_find_package
 if (ENABLE_SDL2)
@@ -180,9 +205,14 @@ endif()
 set(BUILD_SHARED_LIBS OFF)
 
 # SPIRV Headers
+if (YUZU_USE_CPM)
 AddJsonPackage(spirv-headers)
+else()
+find_package(SPIRV-Headers 1.3.274 REQUIRED)
+endif()
 
 # Sirit
+if (YUZU_USE_CPM)
 if (YUZU_USE_BUNDLED_SIRIT)
     AddJsonPackage(sirit-ci)
 else()
@@ -191,9 +221,12 @@ else()
         target_compile_options(siritobj PRIVATE -Wno-error=unused-command-line-argument)
     endif()
 endif()
+endif()
 
 # SPIRV Tools
+if (YUZU_USE_CPM)
 AddJsonPackage(spirv-tools)
+endif()
 
 if (SPIRV-Tools_ADDED)
     add_library(SPIRV-Tools::SPIRV-Tools ALIAS SPIRV-Tools-static)
@@ -201,9 +234,11 @@ if (SPIRV-Tools_ADDED)
 endif()
 
 # Catch2
+if (YUZU_USE_CPM)
 if (YUZU_TESTS OR DYNARMIC_TESTS)
     AddJsonPackage(catch2)
 endif()
+endif()
 
 # getopt
 if (MSVC)
@@ -214,12 +249,16 @@ endif()
 add_subdirectory(glad)
 
 # libusb
+if (YUZU_USE_CPM)
 if (ENABLE_LIBUSB)
     add_subdirectory(libusb)
 endif()
+endif()
 
 # VMA
+if (YUZU_USE_CPM)
 AddJsonPackage(vulkan-memory-allocator)
+endif()
 
 if (VulkanMemoryAllocator_ADDED)
     if (CXX_CLANG)
@@ -235,12 +274,28 @@ endif()
 
 # httplib
 if (ENABLE_WEB_SERVICE OR ENABLE_UPDATE_CHECKER OR USE_DISCORD_PRESENCE OR ENABLE_OPENSSL)
+  if (YUZU_USE_CPM)
     AddJsonPackage(httplib)
+  else()
+    if (NOT TARGET httplib::httplib)
+      set(HTTPLIB_REQUIRE_OPENSSL ${ENABLE_OPENSSL})
+      add_subdirectory(cpp-httplib)
+    endif()
+  endif()
 endif()
 
 # cpp-jwt
 if (ENABLE_WEB_SERVICE OR ENABLE_UPDATE_CHECKER)
+  if (YUZU_USE_CPM)
     AddJsonPackage(cpp-jwt)
+  else()
+    if (NOT TARGET cpp-jwt::cpp-jwt)
+      set(CPP_JWT_BUILD_EXAMPLES OFF)
+      set(CPP_JWT_BUILD_TESTS OFF)
+      set(CPP_JWT_USE_VENDORED_NLOHMANN_JSON OFF)
+      add_subdirectory(cpp-jwt)
+    endif()
+  endif()
 endif()
 
 # FFMpeg
diff --git a/externals/ffmpeg/CMakeLists.txt b/externals/ffmpeg/CMakeLists.txt
index 3140f8e..b6a3325 100644
--- a/externals/ffmpeg/CMakeLists.txt
+++ b/externals/ffmpeg/CMakeLists.txt
@@ -152,10 +152,15 @@ else()
         message(FATAL_ERROR "Required program `autoconf` not found.")
     endif()
 
+  if (YUZU_USE_CPM)
     AddJsonPackage(ffmpeg)
 
     set(FFmpeg_PREFIX ${ffmpeg_SOURCE_DIR})
     set(FFmpeg_BUILD_DIR ${ffmpeg_BINARY_DIR})
+    else()
+      set(FFmpeg_PREFIX ${PROJECT_SOURCE_DIR}/externals/ffmpeg/ffmpeg)
+      set(FFmpeg_BUILD_DIR ${PROJECT_BINARY_DIR}/externals/ffmpeg-build)
+    endif()
     set(FFmpeg_MAKEFILE ${FFmpeg_BUILD_DIR}/Makefile)
     make_directory(${FFmpeg_BUILD_DIR})
 
diff --git a/externals/nx_tzdb/CMakeLists.txt b/externals/nx_tzdb/CMakeLists.txt
index a82bf0b..5f4a39c 100644
--- a/externals/nx_tzdb/CMakeLists.txt
+++ b/externals/nx_tzdb/CMakeLists.txt
@@ -56,7 +56,7 @@ elseif (MSVC AND NOT CXX_CLANG AND ENABLE_LTO)
             ${NX_TZDB_ARCHIVE}
         DESTINATION
             ${NX_TZDB_BASE_DIR})
-else()
+elseif (CAN_BUILD_NX_TZDB AND YUZU_DOWNLOAD_TIME_ZONE_DATA)
     message(STATUS "Downloading time zone data...")
     AddJsonPackage(tzdb)
 
diff --git a/src/dynarmic/CMakeLists.txt b/src/dynarmic/CMakeLists.txt
index e0d1f94..5bb8995 100644
--- a/src/dynarmic/CMakeLists.txt
+++ b/src/dynarmic/CMakeLists.txt
@@ -116,10 +116,6 @@ if (NOT Boost_FOUND)
     find_package(Boost 1.57 REQUIRED)
 endif()
 
-find_package(fmt 8 CONFIG)
-find_package(mcl 0.1.12 REQUIRED)
-find_package(unordered_dense REQUIRED)
-
 if ("arm64" IN_LIST ARCHITECTURE OR DYNARMIC_TESTS)
     find_package(oaknut 2.0.1 CONFIG)
 endif()
@@ -128,10 +124,6 @@ if ("riscv" IN_LIST ARCHITECTURE)
     find_package(biscuit 0.9.1 REQUIRED)
 endif()
 
-if ("x86_64" IN_LIST ARCHITECTURE)
-    find_package(xbyak 7 CONFIG)
-endif()
-
 if (DYNARMIC_USE_LLVM)
     find_package(LLVM REQUIRED)
     separate_arguments(LLVM_DEFINITIONS)
-- 
2.53.0

